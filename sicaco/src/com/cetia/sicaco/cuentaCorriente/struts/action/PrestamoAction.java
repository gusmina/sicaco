/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package com.cetia.sicaco.cuentaCorriente.struts.action;
import java.io.IOException;
import java.sql.Connection;
import java.sql.DriverManager;
import java.text.DecimalFormat;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;

import javax.servlet.ServletContext;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.struts.action.ActionErrors;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;
import org.apache.struts.action.ActionMessage;
import org.apache.struts.action.ActionMessages;
import org.hibernate.Transaction;
import org.jmesa.facade.TableFacade;
import org.jmesa.facade.TableFacadeFactory;
import org.jmesa.limit.Limit;
import org.jmesa.view.component.Column;
import org.jmesa.view.component.Row;
import org.jmesa.view.component.Table;
import org.jmesa.view.editor.BasicCellEditor;
import org.jmesa.view.editor.CellEditor;
import org.jmesa.view.html.HtmlBuilder;

import com.cetia.sicaco.cuentaCorriente.struts.form.DescuentosExternosForm;
import com.cetia.sicaco.cuentaCorriente.struts.form.FiadorPrestamoForm;
import com.cetia.sicaco.cuentaCorriente.struts.form.GarantiaPrestamoForm;
import com.cetia.sicaco.cuentaCorriente.struts.form.NotaGenericForm;
import com.cetia.sicaco.cuentaCorriente.struts.form.PrestamoForm;
import com.cetia.sicaco.cuentaCorriente.struts.form.ReferenciaComercialForm;
import com.cetia.sicaco.cuentaCorriente.struts.form.ReferenciaPersonalForm;
import com.cetia.sicaco.hibernate.CtaAscAsociado;
import com.cetia.sicaco.hibernate.CtaAscAsociadoDAO;
import com.cetia.sicaco.hibernate.CtaCasCuentaAsociado;
import com.cetia.sicaco.hibernate.CtaCasCuentaAsociadoDAO;
import com.cetia.sicaco.hibernate.CtaCbaCuentaBancaria;
import com.cetia.sicaco.hibernate.CtaDexDescuentosExternos;
import com.cetia.sicaco.hibernate.CtaDexDescuentosExternosDAO;
import com.cetia.sicaco.hibernate.CtaFxpFiadorPrestamo;
import com.cetia.sicaco.hibernate.CtaFxpFiadorPrestamoDAO;
import com.cetia.sicaco.hibernate.CtaGarGarantia;
import com.cetia.sicaco.hibernate.CtaGarGarantiaDAO;
import com.cetia.sicaco.hibernate.CtaLprLineaPrestamo;
import com.cetia.sicaco.hibernate.CtaLprLineaPrestamoDAO;
import com.cetia.sicaco.hibernate.CtaMxpMovimientoPrestamo;
import com.cetia.sicaco.hibernate.CtaMxpMovimientoPrestamoDAO;
import com.cetia.sicaco.hibernate.CtaNotNotas;
import com.cetia.sicaco.hibernate.CtaNotNotasDAO;
import com.cetia.sicaco.hibernate.CtaPlmPlanMeses;
import com.cetia.sicaco.hibernate.CtaPlmPlanMesesDAO;
import com.cetia.sicaco.hibernate.CtaPrePrestamo;
import com.cetia.sicaco.hibernate.CtaPrePrestamoDAO;
import com.cetia.sicaco.hibernate.CtaPxtPersonaExterna;
import com.cetia.sicaco.hibernate.CtaPxtPersonaExternaDAO;
import com.cetia.sicaco.hibernate.CtaRcoReferenciasComerciales;
import com.cetia.sicaco.hibernate.CtaRcoReferenciasComercialesDAO;
import com.cetia.sicaco.hibernate.CtaRpeReferenciasPersonales;
import com.cetia.sicaco.hibernate.CtaRpeReferenciasPersonalesDAO;
import com.cetia.sicaco.hibernate.CtaTasTipoAsociado;
import com.cetia.sicaco.hibernate.CtaTasTipoAsociadoDAO;
import com.cetia.sicaco.hibernate.CtaTcoTipoContrato;
import com.cetia.sicaco.hibernate.CtaTcoTipoContratoDAO;
import com.cetia.sicaco.hibernate.CtaTgaTipoGarantiaDAO;
import com.cetia.sicaco.hibernate.CtaTinTasaInteres;
import com.cetia.sicaco.hibernate.CtaTinTasaInteresDAO;
import com.cetia.sicaco.hibernate.CtaTprTipoPrestamo;
import com.cetia.sicaco.hibernate.CtaTprTipoPrestamoDAO;
import com.cetia.sicaco.hibernate.CtrEstEstado;
import com.cetia.sicaco.hibernate.CtrEstEstadoDAO;
import com.cetia.sicaco.hibernate.CtrParParametros;
import com.cetia.sicaco.hibernate.CtrParParametrosDAO;
import com.cetia.sicaco.hibernate.HibernateSessionFactory;
import com.cetia.sicaco.hibernate.SecDppDepartamentoPais;
import com.cetia.sicaco.hibernate.SecDppDepartamentoPaisDAO;
import com.cetia.sicaco.hibernate.SecIseInicioSesion;
import com.cetia.sicaco.hibernate.SecIseInicioSesionDAO;
import com.cetia.sicaco.hibernate.SecParParentescoDAO;
import com.cetia.sicaco.hibernate.SecPerPersona;
import com.cetia.sicaco.hibernate.SecPerPersonaDAO;
import com.cetia.sicaco.struts.Constantes;
import com.cetia.sicaco.struts.CuentaAsociadoVista;
import com.cetia.sicaco.struts.DMLAction;
import com.mad.utilidades.Calculadora;
import com.mad.utilidades.ElapsedTime;
import com.mad.utilidades.ExportWebReport;
import com.mad.utilidades.Format;
import com.mad.utilidades.IntereseYMora;
import com.mad.utilidades.ReportFile;

/** 
 * MyEclipse Struts
 * Creation date: 08-28-2008
 * 
 * XDoclet definition:
 * @struts.action path="/prestamo" name="prestamoForm" parameter="accion" scope="request"
 */
public class PrestamoAction extends DMLAction {
	
	public static final String TABLA_ID = "ctaPrePrestamo";
	private static final String ASC_ID = "ctaAscAsociado.ascId";
	private static final String reporteComprobante = "prestamo_fiadores";
	private static final String rutaReporte = "/listaReportes/asociados/";
	//private static final String subReporte= "subreport_fiadores";
	private static final String FECHA = "FECHA";
	private static final String PRE_ID = "PRE_ID";
	private static final String SUBREPORT_DIR = "SUBREPORT_DIR";	
	
	public ActionForward lista(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		PrestamoForm prestamoForm = (PrestamoForm) form;
	    prestamoForm.setEstado(13/*-1*/);
		return buscarPrestamos(mapping, prestamoForm, request, response);
	}
	
	public ActionForward listaAux(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		PrestamoForm prestamoForm = (PrestamoForm) form;
		return buscarPrestamos(mapping, prestamoForm, request, response);
	}	
	
	//---- metodo que genera el html de la tabla del jmesa
	private String html(final TableFacade tableFacade, final HttpServletRequest request) {			
			tableFacade.setColumnProperties("ctaPrePrestamo.preId", "casCuenta", "ctrEstEstado.estNombre", "casFechaApertura",
					"casFechaCierre","ctaPrePrestamo.preSaldoActualT", "casPrincipal",
					"ctaPrePrestamo.prePendMov", "casValorApertura");
			Table table = tableFacade.getTable();
			
			//---- Titulo de la tabla
			table.setCaptionKey("tbl.cas.caption.prestamo");
			
			Row row = table.getRow();
			Column nombreColumna = row.getColumn("ctaPrePrestamo.preId");
			nombreColumna.setTitleKey("tbl.cas.casReferencia");
			nombreColumna.getCellRenderer().setCellEditor(new CellEditor(){
			
			public Object getValue(Object item, String property, int rowcount) {
				Object value = new BasicCellEditor().getValue(item, property, rowcount);
				CtaCasCuentaAsociado cuAsoc = (CtaCasCuentaAsociado)item;
				HtmlBuilder html = new HtmlBuilder();
				value = cuAsoc.getCtaPrePrestamo().getPreId();
				String link = tableFacade.getWebContext().getContextPath();
				link += "/cuentaCorriente/prestamo.do?accion=cargarSolicitud&preId="+value+"&estado="+cuAsoc.getCtrEstEstado().getEstId();
				html.a().href().quote().append(link).quote().close();
				html.append(value);
				html.aEnd();				
				return html.toString();		
			}
			
			});
			
			nombreColumna = row.getColumn("casCuenta");
			nombreColumna.setTitleKey("tbl.cas.descripcionMov");
			nombreColumna.getCellRenderer().setCellEditor(new CellEditor(){
			
				public Object getValue(Object item, String property, int rowcount) {
					Object value = new BasicCellEditor().getValue(item, property, rowcount);
					CtaCasCuentaAsociado cuentaAsoc = (CtaCasCuentaAsociado)item;
					value = cuentaAsoc.getCtaPrePrestamo().getCtaTprTipoPrestamo().getCtaLprLineaPrestamo().getLprNombre()
					+ " - "+cuentaAsoc.getCtaPrePrestamo().getCtaTprTipoPrestamo().getTprNombre();
					return value;
				}
			
			});
			
			nombreColumna = row.getColumn("ctrEstEstado.estNombre");
			nombreColumna.setTitleKey("tbl.cas.estadoPrestamo");
			
			nombreColumna = row.getColumn("casFechaApertura");
			nombreColumna.setTitleKey("tbl.cas.fechaApertura");
			nombreColumna.getCellRenderer().setCellEditor(new CellEditor(){
				
				public Object getValue(Object item, String property, int rowcount) {
					Object value = new BasicCellEditor().getValue(item, property, rowcount);
					SimpleDateFormat sdf = new SimpleDateFormat("dd-MM-yyyy");
					value = sdf.format(value);
					return value;		
				}
			
			});
			
			nombreColumna = row.getColumn("casFechaCierre");
			nombreColumna.setTitleKey("tbl.cas.fechaUltimoMov");
			nombreColumna.getCellRenderer().setCellEditor(new CellEditor(){
			
				public Object getValue(Object item, String property, int rowcount) {
					Object value = new BasicCellEditor().getValue(item, property, rowcount);
					CtaCasCuentaAsociado cuentaAsoc = (CtaCasCuentaAsociado)item;
					CtaCasCuentaAsociadoDAO cuentaAsocDAO = new CtaCasCuentaAsociadoDAO(getSessionHibernate(request));
					Date obj = cuentaAsocDAO.findFechaTransaction(cuentaAsoc.getCasCuenta());
					String txaFecha ="";
					if(obj!=null){
						SimpleDateFormat sdf = new SimpleDateFormat("dd-MM-yyyy");
						txaFecha = sdf.format(obj);
					}
					value = txaFecha;
					return value;		
				}
			
			});
			
			nombreColumna = row.getColumn("ctaPrePrestamo.preSaldoActualT");
			nombreColumna.setTitleKey("tbl.cas.SaldoActual");
			nombreColumna.getCellRenderer().setCellEditor(new CellEditor(){
				
				public Object getValue(Object item, String property, int rowcount) {
					CtaCasCuentaAsociado cuentaAsoc = (CtaCasCuentaAsociado)item;
					CtaPrePrestamo prestamo = cuentaAsoc.getCtaPrePrestamo();
					return Format.formatDinero(prestamo.getPreSaldoActualT());
				}
				
			});
			
			nombreColumna = row.getColumn("casPrincipal");
			nombreColumna.setTitleKey("tbl.cas.interesAcumulado");
			nombreColumna.getCellRenderer().setCellEditor(new CellEditor(){
				
				public Object getValue(Object item, String property, int rowcount) {
					CtaCasCuentaAsociado cuentaAsoc = (CtaCasCuentaAsociado)item;
					//Solo si esta activo se calcula
					if(cuentaAsoc.getCtrEstEstado().getEstId().equals(13)){
						CtaPrePrestamo prestamo = cuentaAsoc.getCtaPrePrestamo();
						CtaMxpMovimientoPrestamoDAO mxpDao = new CtaMxpMovimientoPrestamoDAO(getSessionHibernate(request));
						IntereseYMora iYm = new IntereseYMora();
						if(mxpDao.findUltimoMovimiento(prestamo.getPreId()) == null || 
								mxpDao.findUltimoMovimiento(prestamo.getPreId()).getMxpId() == null){
							iYm = iYm.actualizaInteres(new CtaMxpMovimientoPrestamo(), prestamo, cuentaAsoc, new Date(),request);
							if(iYm.getAcumulado() == null){
								return Format.formatDinero(0.0);
							}
							return Format.formatDinero(iYm.getAcumulado());
						}else{
							iYm = iYm.actualizaInteres(mxpDao.findUltimoMovimiento(prestamo.getPreId()), prestamo, cuentaAsoc, new Date(),request);
							if(iYm.getAcumulado() == null){
								return Format.formatDinero(0.0);
							}
							return Format.formatDinero(iYm.getAcumulado());
						}
					}else{
						return Format.formatDinero(0.0);
					}
				}
				
			});
			
			nombreColumna = row.getColumn("ctaPrePrestamo.prePendMov");
			nombreColumna.setTitleKey("tbl.cas.interesPendiente");
			nombreColumna.getCellRenderer().setCellEditor(new CellEditor(){
				
				public Object getValue(Object item, String property, int rowcount) {
					CtaCasCuentaAsociado cuentaAsoc = (CtaCasCuentaAsociado)item;
					//Solo si esta activo se calcula
					if(cuentaAsoc.getCtrEstEstado().getEstId().equals(13)){
						CtaPrePrestamo prestamo = cuentaAsoc.getCtaPrePrestamo();
						CtaMxpMovimientoPrestamoDAO mxpDao = new CtaMxpMovimientoPrestamoDAO(getSessionHibernate(request));
						IntereseYMora iYm = new IntereseYMora();
						if(mxpDao.findUltimoMovimiento(prestamo.getPreId()) == null || 
								mxpDao.findUltimoMovimiento(prestamo.getPreId()).getMxpId() == null){
							iYm = iYm.actualizaInteres(new CtaMxpMovimientoPrestamo(), prestamo, cuentaAsoc, new Date(),request);
							if(iYm.getPendiente() == null){
								return Format.formatDinero(0.0);
							}
							return Format.formatDinero(iYm.getPendiente());
						}else{
							iYm = iYm.actualizaInteres(mxpDao.findUltimoMovimiento(prestamo.getPreId()), prestamo, cuentaAsoc, new Date(),request);
							if(iYm.getPendiente() == null){
								return Format.formatDinero(0.0);
							}
							return Format.formatDinero(iYm.getPendiente());
						}
					}else{
						return Format.formatDinero(0.0);
					}
				}
				
			});
			/*
			nombreColumna = row.getColumn("ctaPrePrestamo.preMoraMov");
			nombreColumna.setTitleKey("tbl.cas.mora");
			nombreColumna.getCellRenderer().setCellEditor(new CellEditor(){
				
				public Object getValue(Object item, String property, int rowcount) {
					CtaCasCuentaAsociado cuentaAsoc = (CtaCasCuentaAsociado)item;
					CtaPrePrestamo prestamo = cuentaAsoc.getCtaPrePrestamo();
					CtaMxpMovimientoPrestamoDAO mxpDao = new CtaMxpMovimientoPrestamoDAO(getSessionHibernate(request));
					IntereseYMora iYm = new IntereseYMora();
					if(mxpDao.findUltimoMovimiento(prestamo.getPreId()) == null || 
							mxpDao.findUltimoMovimiento(prestamo.getPreId()).getMxpId() == null){
						iYm = iYm.actualizaInteres(new CtaMxpMovimientoPrestamo(), prestamo, cuentaAsoc, new Date());
						if(iYm.getMora() == null){
							return Format.formatDinero(0.0);
						}
						return Format.formatDinero(iYm.getMora());
					}else{
						iYm = iYm.actualizaInteres(mxpDao.findUltimoMovimiento(prestamo.getPreId()), prestamo, cuentaAsoc, new Date());
						if(iYm.getMora() == null){
							return Format.formatDinero(0.0);
						}
						return Format.formatDinero(iYm.getMora());
					}
				}
				
			});
			*/
			nombreColumna = row.getColumn("casValorApertura");
			nombreColumna.setTitleKey("tbl.cas.acciones");
			nombreColumna.getCellRenderer().setCellEditor(new CellEditor(){
				
				public Object getValue(Object item, String property, int rowcount) {
					Object value ="";
					CtaCasCuentaAsociado cuentaAsoc = (CtaCasCuentaAsociado)item;
					CtaPrePrestamo prestamo = cuentaAsoc.getCtaPrePrestamo();
					
					HtmlBuilder html = new HtmlBuilder();
					if(cuentaAsoc.getCtrEstEstado().getEstId() == 13){
						value =getResources(request).getMessage("cmd.cas.movimientos");
						String link = tableFacade.getWebContext().getContextPath();
						link += "/cuentaCorriente/movXPrestamo.do?accion=lista&prestamoId="+prestamo.getPreId();
						html.a().href().quote().append(link).quote().append("class=\"linkMovimientos\"").title(value.toString()).close();
						//html.append(value);
						html.aEnd();
					}
					return html.toString();		
				}
				
			});
			
		return tableFacade.render();
	}
	
	public ActionForward forwardToNuevaSolicitud(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		PrestamoForm prestamoForm = (PrestamoForm) form;
		CtaTinTasaInteresDAO tasaInteresDAO = new CtaTinTasaInteresDAO(getSessionHibernate(request));
		SecParParentescoDAO parentescoDAO = new SecParParentescoDAO(getSessionHibernate(request));
		CtaTgaTipoGarantiaDAO tipoGarantiaDAO = new CtaTgaTipoGarantiaDAO(getSessionHibernate(request));
		prestamoForm.setPreFechaSolicitud(new Date());
		CtaCasCuentaAsociadoDAO cuentaAsociadoDAO = new CtaCasCuentaAsociadoDAO(getSessionHibernate(request));
		//CtaTprTipoPrestamoDAO tipoPrestamoDAO = new CtaTprTipoPrestamoDAO(getSessionHibernate(request));
		CtaLprLineaPrestamoDAO lineaPrestamoDAO = new CtaLprLineaPrestamoDAO(getSessionHibernate(request));
		CtaPlmPlanMesesDAO planMesesDAO = new CtaPlmPlanMesesDAO(getSessionHibernate(request)); 

		
		request.setAttribute("tipoGarantias", tipoGarantiaDAO.findAll());
		request.setAttribute("tinList", tasaInteresDAO.findAllWithName());
		request.setAttribute("parList", parentescoDAO.findAll());
		request.setAttribute("cuentas", cuentaAsociadoDAO.findCuentasSinPrestamos(prestamoForm.getAscId(),new Integer(9)));
		//request.setAttribute("tipos", tipoPrestamoDAO.findTiposVigentes(new Date()));
		
		request.setAttribute("listaLineas", lineaPrestamoDAO.findAll());
		request.setAttribute("listaPlanes", planMesesDAO.findAllWithName());
		request.setAttribute("listaTasas", tasaInteresDAO.findAllWithName());
		
		request.setAttribute("form", prestamoForm);
		if(prestamoForm.getNueva() == 1){
			request.getSession().setAttribute("listaReferenciasPersonales",new HashMap<Long, CtaRpeReferenciasPersonales>() );
			request.getSession().setAttribute("listaReferenciasComerciales", new HashMap<Long,CtaRcoReferenciasComerciales>());
			request.getSession().setAttribute("listaNotas", new HashMap<Long, String>());
			request.getSession().setAttribute("listaFiadores", new HashMap<Long, CtaFxpFiadorPrestamo>());
			request.getSession().setAttribute("listaGarantias", new HashMap<Long, CtaGarGarantia>());
			request.getSession().setAttribute("listaDescuentos", new HashMap<Long, DescuentosExternosForm>());
		}
		CtrParParametrosDAO parametrosDAO = new CtrParParametrosDAO(getSessionHibernate(request));
		Double iva = parametrosDAO.findById("IVA").getParValorNumber();
		request.setAttribute("iva", iva);
		request.setAttribute(Constantes.ACCION_KEY, "/prestamo");	
		return mapping.findForward("nuevaSolicitudCredito");
	}
	
	public ActionForward forwardToFiadores(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		FiadorPrestamoForm fiadorPrestamoForm = new FiadorPrestamoForm();
		PrestamoForm prestamoForm = (PrestamoForm) form;
		fiadorPrestamoForm.setPreId(prestamoForm.getPreId());
		request.setAttribute("form", fiadorPrestamoForm);
		return mapping.findForward("forwardToFiadores");
	}
	
	/* ########################### Busqueda de Asociados ############################################# */
	
	public ActionForward cargarListaAsociados(ActionMapping mapping,
			ActionForm form, HttpServletRequest request,
			HttpServletResponse response) {
		CtaAscAsociadoDAO asociadoDAO = new CtaAscAsociadoDAO(getSessionHibernate(request));
		PrestamoForm prestamoForm = (PrestamoForm) form;
		try {
		String listaResponse = construirListaAsociados(asociadoDAO.findAsociadosDisponiblesPrestamo(prestamoForm.getAsociadoH(),10));
			response.getWriter().write(listaResponse);
			response.getWriter().flush();
			response.getWriter().close();
		} catch (RuntimeException e) {
			log.error("Error runtime", e);
		} catch (IOException e) {
			log.error(e);
		}
		return null;
	}
	
	public ActionForward cargarListaCuentas(ActionMapping mapping,
			ActionForm form, HttpServletRequest request,
			HttpServletResponse response) {
		CtaCasCuentaAsociadoDAO cuentaAsociadoDAO = new CtaCasCuentaAsociadoDAO(getSessionHibernate(request));
		PrestamoForm prestamoForm = (PrestamoForm) form;
		try {
		String listaResponse = contruirListaCuentas(cuentaAsociadoDAO.findCuentasSinPrestamos(prestamoForm.getAscId(),new Integer(9)),request);
			response.getWriter().write(listaResponse);
			response.getWriter().flush();
			response.getWriter().close();
		} catch (RuntimeException e) {
			log.error("Error runtime", e);
		} catch (IOException e) {
			log.error(e);
		}
		return null;
	}
	
	private String contruirListaCuentas(List<CuentaAsociadoVista> listaCuentasAsc,HttpServletRequest request){
		String lista;
		if(listaCuentasAsc.size() > 0){
			lista ="<select name=\"casCuenta\" id=\"casCuenta\" class=\"obligatorio\">";
			Iterator<CuentaAsociadoVista> it = listaCuentasAsc.iterator();
			while(it.hasNext()){
				CuentaAsociadoVista cuentaAsociado = it.next();
				lista+="<option value=\""+cuentaAsociado.getId()+"\">"+cuentaAsociado.getNombreCuenta()+"</option>";
			}
			lista+="</select>";
		}else{
			lista = "<label>"+getResources(request).getMessage("lbl.pre.noHayCuentas")+"</label>" ;
		}
		return lista;
	}	
	
	private String construirListaAsociados(List<CtaAscAsociado> listaAsociados){
		String lista = "<table id=\"resultadoCli\">";
		int max = 0;
		if(listaAsociados.size() == 0)
			lista+= "<td><span style=\"font-size: 10px;color: red;font-style: italic;\">"
			+ "No se encontro asociado en el sistema para esta b&uacute;squeda</span></td>";
		else{
			Iterator<CtaAscAsociado> it = listaAsociados.iterator();
			while(it.hasNext() &&  max < 5){
				CtaAscAsociado asociado = it.next();
				lista += "<tr>";
				lista += "<td><input onclick=\"JavaScript:saveSeleccion(this.value);\" type=\"radio\" name=\"_miseleccion\" value=\""
					+ asociado.getAscCodigoAsociado()
					+ ";"
					+ asociado.getSecPerPersona().getPerNit()
					+ ";"
					+ asociado.getSecPerPersona().getPerDui()
					+ ";"
					+ asociado.getSecPerPersona().getPerPrimerNombre()
					+ ";"
					+ asociado.getSecPerPersona().getPerSegundoNombre()
					+ ";"
					+ asociado.getSecPerPersona().getPerPrimerApellido()
					+ ";"
					+ asociado.getSecPerPersona().getPerSegundoApellido()
					+ ";"
					+ asociado.getAscId()
					+ ";"
					+ asociado.getAscCodigo()
					+ ";"
					+ asociado.getAscSalario()
					+ "\"/></td>";
			lista += "<td><span style=\"font-size: 10px;color: #6E6E6E;font-style: italic;\">"
					+ asociado.getAscCodigoAsociado()
					+ " "
					+ asociado.getSecPerPersona().getPerPrimerNombre()
					+ " "
					+ asociado.getSecPerPersona().getPerPrimerApellido();
			if(asociado.getEstId() == 21){
				lista += "</span> "
					+ "<span style=\"font-size: 10px;color: #FF1414;font-style: italic;\">"
					+ "Restringido</span>";
			}
			lista += "</span></td></tr>";
			max++;
			}
		}
		lista += "</table>";
		return lista;
	}
	
	/* ########################### COMUNES ############################################*/
	
	private String construirListaErrores(ArrayList<String> errors){
		String errores = "<table align=\"center\"><tr><td colspan=\"2\"><span style=\"font-size: 12px;color: red;font-style: italic;\">Se han encontrado los siguientes errores:</span></td></tr>";
		Iterator<String> it = errors.iterator();
		while(it.hasNext()){
			errores=errores+"<tr><td><span style=\"font-size: 10px;color: red;font-style: italic;\">"+ 
			it.next()
			+"</span></td></tr>";
		}
		errores=errores+"</table>";
		return errores;
	}
	
	public ActionForward forwardToVerificacion(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		String respuesta = "";
		ArrayList<String> errors = new ArrayList<String>();
		PrestamoForm prestamoForm  = (PrestamoForm) form;
		CtaAscAsociadoDAO asociadoDAO = new CtaAscAsociadoDAO(getSessionHibernate(request));
		CtaPrePrestamoDAO prestamoDAO = new CtaPrePrestamoDAO(getSessionHibernate(request));
		CtaAscAsociado asoc =  asociadoDAO.findById(prestamoForm.getAscId());
		CtaTprTipoPrestamoDAO tipoPrestamoDAO = new CtaTprTipoPrestamoDAO(getSessionHibernate(request));
		
		List listaTipos = tipoPrestamoDAO.findTasaByLineaAndPlazoAndTasa(prestamoForm.getLprId(), prestamoForm.getPlmId(), prestamoForm.getTinPlazoId());
		if(listaTipos.size()!=0){//El tipo de pr√©stamo ya existe
			prestamoForm.setCtaTprTipoPrestamo((CtaTprTipoPrestamo) listaTipos.get(0));
		}else{//Hay que crear el tipo de pr√©stamo
			CtaTprTipoPrestamo ctaTprTipoPrestamo = new CtaTprTipoPrestamo();
			Integer id = tipoPrestamoDAO.nextId(); 
			ctaTprTipoPrestamo.setTprId(id);
			
			CtaLprLineaPrestamoDAO ctaLprLineaPrestamoDAO = new CtaLprLineaPrestamoDAO(getSessionHibernate(request));
			CtaLprLineaPrestamo ctaLprLineaPrestamo =  ctaLprLineaPrestamoDAO.findById(prestamoForm.getLprId());
			CtaPlmPlanMesesDAO ctaPlmPlanMesesDAO = new CtaPlmPlanMesesDAO(getSessionHibernate(request));
			CtaPlmPlanMeses ctaPlmPlanMeses = ctaPlmPlanMesesDAO.findById(prestamoForm.getPlmId());
			CtaTinTasaInteresDAO ctaTinTasaInteresDAO = new CtaTinTasaInteresDAO(getSessionHibernate(request));
			CtaTinTasaInteres ctaTinTasaInteres = ctaTinTasaInteresDAO.findById(prestamoForm.getTinPlazoId());
			
			ctaTprTipoPrestamo.setCtaLprLineaPrestamo(ctaLprLineaPrestamo);
			ctaTprTipoPrestamo.setCtaPlmPlanMeses(ctaPlmPlanMeses);
			ctaTprTipoPrestamo.setCtaTinTasaInteres(ctaTinTasaInteres);
			ctaTprTipoPrestamo.setTprNombre(ctaLprLineaPrestamo.getLprNombre()+", "+ctaPlmPlanMeses.getPlmDuracion()+" MESES, TASA "+ctaTinTasaInteres.getTinNombre());
			ctaTprTipoPrestamo.setTprDescripcion(ctaLprLineaPrestamo.getLprNombre()+", "+ctaPlmPlanMeses.getPlmDuracion()+" MESES, TASA "+ctaTinTasaInteres.getTinNombre());
			
			tipoPrestamoDAO.save(ctaTprTipoPrestamo);
			prestamoForm.setCtaTprTipoPrestamo((CtaTprTipoPrestamo) tipoPrestamoDAO.findById(id));
		}
		if(prestamoForm.getPrestamoH().getPreMontoSolicitado() <= 0){
			errors.add(getResources(request).getMessage("errors.pre.montoSolicitadoRequerido"));
		}
		if(prestamoForm.getMontoRecibir() < 0){
			errors.add(getResources(request).getMessage("errors.pre.montoRecibir"));
		}		
		if(asoc== null){
			errors.add(getResources(request).getMessage("errors.pre.asociadoNoSeleccionado"));
		}
		if(prestamoForm.getCtaTprTipoPrestamo().getTprId() == null || prestamoForm.getCtaTprTipoPrestamo().getTprId()<=0){
			errors.add(getResources(request).getMessage("errors.pre.tipoNoSeleccionado"));
		}
		if (!errors.isEmpty()) {
			respuesta = "<table align=\"center\"><tr><td><input type=\"button\" value=\"Verificar Informacion\" onclick=\"ajaxCallNormal('"
					+ request.getContextPath()
					+ "/cuentaCorriente/prestamo.do','accion=forwardToVerificacion&ascId='+$('#ascId').val()+'&fuente='+$('#fuente').val()+'&lprId='+$('#lineaCombo').val()+'&plmId='+$('#plmId').val()+'&tinPlazoId='+$('#tinPlazoId').val()+'&preMontoSolicitado='+$('#preMontoSolicitado').val()+'&casCuenta='+$('#casCuenta').val()+'&ctaTinTasaInteres.tinId='+$('#tinId').val()+'&montoRecibir='+$('#montoRecibir').val()+'&aportaciones='+$('#aportacionesId').val()+'&preOtrasDeducciones='+$('#otrasDeducId').val()+'&preIvaDeducciones='+$('#iva').val(),'respuesta')\"/></td></tr></table>";
			respuesta = respuesta + construirListaErrores(errors);
		} else {
			String preId = prestamoDAO.generarId("C");
			try{
				prestamoForm.setPreId(preId);
				saveSolicitud(prestamoForm,request,asoc);
				request.setAttribute("preId", preId);
				respuesta = "<label class=\"obligatorio\">"+getResources(request).getMessage("lbl.pre.mensajeInformativoPrestamo")
				+ "</label><br><br><table align=\"center\"><tr><td>"+
				"<input type=\"button\" onclick=\"generarComprobante('"+asoc.getAscId()+"','"+asoc.getAscSalario()+"','"+preId+"')\" value=\"Generar Constancia de Descuentos\"/>"
				+"</td><td><input type=\"submit\" value=\"Finalizar\" name=\"accion\" onclick=\"finalizar('"+preId+"')\"/></td></tr></table>";
			}catch(Exception e){
				e.printStackTrace();
				respuesta = "<table align=\"center\"><tr><td><span style=\"font-size: 10px;color: red;font-style: italic;\">Ha "
				+"ocurrido un error inesperado al intentar guardar la solicitud, por favor contacte al administrador del sistema para mayor informaci&oacute;n.</span></td></tr></table>";
			}
		}
		try {
			response.getWriter().write(respuesta);
			response.getWriter().flush();
			response.getWriter().close();
		} catch (IOException e) {
			e.printStackTrace();
		}
		return null;
	}
	
	private void saveSolicitud(PrestamoForm prestamoForm,HttpServletRequest request,CtaAscAsociado asociado){
		CtaTprTipoPrestamoDAO tipoPrestamoDAO = new CtaTprTipoPrestamoDAO(getSessionHibernate(request));
		CtrParParametrosDAO parametrosDAO = new CtrParParametrosDAO(getSessionHibernate(request));
		CtaPrePrestamoDAO prestamoDAO = new CtaPrePrestamoDAO(getSessionHibernate(request));
		CtaCasCuentaAsociado cuentaAsociado = new CtaCasCuentaAsociado();
		CtaCasCuentaAsociadoDAO cuentaAsociadoDAO = new CtaCasCuentaAsociadoDAO(getSessionHibernate(request));
		CtaRpeReferenciasPersonalesDAO referenciasPersonalesDAO = new CtaRpeReferenciasPersonalesDAO(getSessionHibernate(request));
		CtaRcoReferenciasComercialesDAO referenciasComercialesDAO = new CtaRcoReferenciasComercialesDAO(getSessionHibernate(request));
		CtaGarGarantiaDAO garantiaDAO = new CtaGarGarantiaDAO(getSessionHibernate(request));
		CtaFxpFiadorPrestamoDAO fiadorPrestamoDAO = new CtaFxpFiadorPrestamoDAO(getSessionHibernate(request));
		CtaNotNotasDAO notasDAO = new CtaNotNotasDAO(getSessionHibernate(request));
		CtaPxtPersonaExternaDAO pexDAO = new CtaPxtPersonaExternaDAO(getSessionHibernate(request));
		CtaDexDescuentosExternosDAO dexDAO = new CtaDexDescuentosExternosDAO(getSessionHibernate(request));
		HashMap<Long, CtaGarGarantia> mapaGar = (HashMap<Long, CtaGarGarantia>)request.getSession().getAttribute("listaGarantias");
		HashMap<Long, CtaDexDescuentosExternos> mapaDxp = (HashMap<Long, CtaDexDescuentosExternos>)request.getSession().getAttribute("listaDescuentos");
		HashMap<Long, CtaRcoReferenciasComerciales> mapaRco = (HashMap<Long,CtaRcoReferenciasComerciales>)request.getSession().getAttribute("listaReferenciasComerciales");
		HashMap<Long, CtaRpeReferenciasPersonales> mapaRpe = (HashMap<Long, CtaRpeReferenciasPersonales>)request.getSession().getAttribute("listaReferenciasPersonales");
		HashMap<Long, String> mapaNota = (HashMap<Long,String>)request.getSession().getAttribute("listaNotas");
		HashMap<Long, CtaFxpFiadorPrestamo> mapaFxp = (HashMap<Long, CtaFxpFiadorPrestamo>)request.getSession().getAttribute("listaFiadores");
		CtaPrePrestamo prestamo = prestamoForm.getPrestamoH();
		Transaction tx = prestamoDAO.getSession().beginTransaction();
		try{
			CtaTprTipoPrestamo tipoPrestamo = tipoPrestamoDAO.findById(prestamo.getCtaTprTipoPrestamo().getTprId());
			prestamo.setCtaTprTipoPrestamo(tipoPrestamo);
			prestamo.setPreSaldoActualT(prestamo.getPreMontoSolicitado());
			prestamo.setPreReferencia(prestamoForm.getPreId());
			prestamo.setPreCuota(Calculadora.calcularCuotaDouble(prestamo.getPreMontoSolicitado(),tipoPrestamo.getCtaTinTasaInteres().getTinTasa().doubleValue(), tipoPrestamo.getCtaPlmPlanMeses().getPlmDuracion()));
			prestamo.setPreGastoAbogado(parametrosDAO.findById("PAGO_ABOGADO").getParValorNumber());
			prestamo.setPreMoraEmbargo(parametrosDAO.findById("MORA_EMBARGO").getParValorNumber());
			prestamo.setPreLiquidoARecibir(prestamoForm.getMontoRecibir());
			
			prestamo.setPreAportaciones(prestamoForm.getAportaciones());
			prestamo.setCtaCbaCuentaBancaria(null);
			
			prestamo.setPreInteresAcumulado(new Double(0.00));
			prestamo.setPreFechaSolicitud(new Date());
			prestamo.setCtaSegSeguros(null);
			/*if(prestamoForm.isFuente() == false){
				prestamo.setCasCuenta(prestamoForm.getCasCuenta());
			}else{
				prestamo.setCasCuenta(null);
			}*/
			prestamo.setCasCuenta(null);
			prestamoDAO.save(prestamo);
			cuentaAsociado.getCtrEstEstado().setEstId(14);//estado de "En evaluacion"
			cuentaAsociado.setCtaAscAsociado(prestamoForm.getAsociadoH());
			cuentaAsociado.setCtaPrePrestamo(prestamo);
			cuentaAsociado.setCasFechaApertura(new Date());
			cuentaAsociado.setCasValorApertura(0.00);
			cuentaAsociado.setCtaCahCuentaAhorro(null);
			cuentaAsociado.setCtaCbaCuentaBancaria(null);
			cuentaAsociado.setCtaSegSeguros(null);
			cuentaAsociado.setCasPrincipal("N");
			cuentaAsociado.setCtaPxtPersonaExterna(null);
			cuentaAsociado.setCasFechaCierre(ElapsedTime.obtenerFechaMeses(new Date(), 
					prestamo.getCtaTprTipoPrestamo().getCtaPlmPlanMeses().getPlmDuracion()));
			cuentaAsociadoDAO.save(cuentaAsociado);
			Iterator<CtaGarGarantia> itGar = mapaGar.values().iterator();
			//comparamos las garantias ingresadas contra las garantias establecidas en la linea
			if(mapaGar.size() < (tipoPrestamo.getCtaLprLineaPrestamo().getLprMinGarantias()==null?0:tipoPrestamo.getCtaLprLineaPrestamo().getLprMinGarantias())){ 
				mapaNota.put(System.currentTimeMillis()+12, getResources(request).getMessage("error.gar.cantidadMinimoGarantias"));
			}
			if(mapaRco.size() < (tipoPrestamo.getCtaLprLineaPrestamo().getLprMinRefComerciales()==null?0:tipoPrestamo.getCtaLprLineaPrestamo().getLprMinRefComerciales())){ 
				mapaNota.put(System.currentTimeMillis()+12, getResources(request).getMessage("errors.rpe.RcoCantidadMinima"));
			}
			if(mapaRpe.size() < (tipoPrestamo.getCtaLprLineaPrestamo().getLprMinRefPersonales()==null?0:tipoPrestamo.getCtaLprLineaPrestamo().getLprMinRefPersonales())){ 
				mapaNota.put(System.currentTimeMillis()+12, getResources(request).getMessage("errors.rpe.RpeCantidadMinima"));
			}
			if(mapaFxp.size() < (tipoPrestamo.getCtaLprLineaPrestamo().getLprMinFiadores()==null?0:tipoPrestamo.getCtaLprLineaPrestamo().getLprMinFiadores())){ 
				mapaNota.put(System.currentTimeMillis()+12, getResources(request).getMessage("errors.fxp.fiadorMinNum"));
			}
			//verificamos si cumple la restriccion del sueldo
			if(asociado.getAscSalario() < (tipoPrestamo.getCtaLprLineaPrestamo().getLprSueldoMinimo()==null?0:tipoPrestamo.getCtaLprLineaPrestamo().getLprSueldoMinimo())){
				mapaNota.put(System.currentTimeMillis()+12, getResources(request).getMessage("errors.pre.asocNoCumpleSalario"));
			}	
			while(itGar.hasNext()){//salvamos todas las garantias y les asignamos el id del prestamo
				CtaGarGarantia gar = itGar.next();
				gar.getCtaPrePrestamo().setPreId(prestamoForm.getPreId());
					garantiaDAO.save(gar);
			}
			Iterator<CtaDexDescuentosExternos> itDxp = mapaDxp.values().iterator();
			while(itDxp.hasNext()){//salvamos todos los descuentos externos y les asignamos el id del prestamo
				CtaDexDescuentosExternos dexDescuentosExternos = itDxp.next();
				dexDescuentosExternos.getCtaPrePrestamo().setPreId(prestamoForm.getPreId());
				dexDescuentosExternos.setCtaLprLineaPrestamo(null);
				dexDAO.save(dexDescuentosExternos);
			}
			Iterator<CtaRpeReferenciasPersonales> itRpe = mapaRpe.values().iterator();
			while(itRpe.hasNext()){//salvamos todas las referencias personales y les asignamos el id del prestamo
				CtaRpeReferenciasPersonales rpe = itRpe.next();
				rpe.setRpeEstadoValidez("I");//asumimos estado de invalidez para las referecias personales
				rpe.getCtaPrePrestamo().setPreId(prestamoForm.getPreId());
				referenciasPersonalesDAO.save(rpe);
			}
			Iterator<CtaRcoReferenciasComerciales> itRco = mapaRco.values().iterator();
			while(itRco.hasNext()){//salvamos las referencias comerciales y les asignamos el id del prestamo.
				CtaRcoReferenciasComerciales rco = itRco.next();
				rco.setRcoEstado("A");//asumimos el estado de activas
				rco.getCtaPrePrestamo().setPreId(prestamoForm.getPreId());
				referenciasComercialesDAO.save(rco);
			}
			Iterator<CtaFxpFiadorPrestamo> itFxp = mapaFxp.values().iterator();
			while(itFxp.hasNext()){//salvamos los fiadores  y les asignamos el id del prestamo.
				CtaFxpFiadorPrestamo fxp = itFxp.next();
				if (fxp.getCtaAscAsociado() == null) {//solo si es persona externa
//					fxp.getCtaPxtPersonaExterna().setPxtId(pexDAO.generarId());
			
//					pexDAO.save(fxp.getCtaPxtPersonaExterna());
					
					CtaPxtPersonaExternaDAO pxtDao = new CtaPxtPersonaExternaDAO(getSessionHibernate(request));
					CtaPxtPersonaExterna pxt = new CtaPxtPersonaExterna();
					Transaction perTX = pxtDao.getSession().beginTransaction();
					
					SecPerPersonaDAO perDao = new SecPerPersonaDAO(getSessionHibernate(request));
					SecPerPersona per = new SecPerPersona();
					SecDppDepartamentoPaisDAO dppDao = new SecDppDepartamentoPaisDAO(getSessionHibernate(request));
					SecDppDepartamentoPais dpp = new SecDppDepartamentoPais();
					
					dpp = dppDao.findById(1);
					
					pxt = fxp.getCtaPxtPersonaExterna();
					fxp.setCtaPxtPersonaExterna(null);		
						per.setAudFechaCreacion(new Date());
						per.setAudFechaModificacion(new Date());
						per.setAudUsuarioCreacion(prestamoForm.getUsuarioConectado().getNombreUsuario());
						per.setAudUsuarioModificacion(prestamoForm.getUsuarioConectado().getNombreUsuario());
						
						per.setSecDppDepartamentoPais(dpp);
						per.setPerApellidoCasada(" ");
						per.setPerCalle("");
						per.setPerCodigoPostal("0");
						per.setPerColoniaBarrio("");
						String dir = " ";
						if(pxt.getPxtDireccion()!=null){
							dir = pxt.getPxtDireccion();
						}
						per.setPerDireccionCompleta(dir);
						per.setSecSucSucursal(null);
						per.setPerDui(pxt.getPxtDui());
						per.setPerEstado("A");
						per.setPerFechaNacimiento(new Date());
						per.setPerGenero("M");
						per.setPerId(perDao.generarId());
						per.setPerLugarNacimiento("NO DISPONILE");
						per.setPerMunicipio("NO DISPONIBLE");
						per.setPerNit("0");
						per.setPerPrimerApellido(pxt.getPxtPrimerApellido());
						per.setPerPrimerNombre(pxt.getPxtNombres());
						per.setPerSegundoApellido(pxt.getPxtSegundoApellido());
						per.setPerSegundoNombre("");
						per.setPerTercerNombre("");
						
						perDao.save(per);
					perTX.commit();
					perDao.getSession().flush();
					perDao.getSession().clear();
					
					CtaNotNotasDAO notDao = new CtaNotNotasDAO(getSessionHibernate(request));
					CtaNotNotas not = new CtaNotNotas();
					
					not = notDao.findById(1);
					CtaAscAsociadoDAO ascDao = new CtaAscAsociadoDAO(getSessionHibernate(request));
					CtaAscAsociado aso = new CtaAscAsociado();					
					Transaction asoTX = ascDao.getSession().beginTransaction();
						
						aso.setCtaNotNotas(not);
						aso.setAscAsociadoPadre(null);
						
						if(pxt.getPxtCodigoEmpleado()!= null && pxt.getPxtCodigoEmpleado().length() > 1){
							aso.setAscCodigo(pxt.getPxtCodigoEmpleado());	
						}else{
							aso.setAscCodigo(ascDao.next());
						}
						
						String codigo = "F"+per.getPerId().substring(2, 12);
						aso.setAscCodigoAsociado(codigo);
						
						if(
								!aso.getAscCodigo().substring(0, 1).equalsIgnoreCase("F")
							){
								com.cetia.sicaco.hibernate.CtaDptDepartamentoTrabajoDAO dptDao = new com.cetia.sicaco.hibernate.CtaDptDepartamentoTrabajoDAO(getSessionHibernate(request));
								com.cetia.sicaco.hibernate.CtaDptDepartamentoTrabajo dpt = new com.cetia.sicaco.hibernate.CtaDptDepartamentoTrabajo();
	
								if(aso.getAscCodigo().substring(0, 2).equalsIgnoreCase("86")){
									dpt = dptDao.findById(388);
									aso.setCtaDptDepartamentoTrabajo(dpt);
								}else{
									dpt = dptDao.findById(389);
									aso.setCtaDptDepartamentoTrabajo(dpt);
								}
						}else{
							aso.setAscDirTrabajo(pxt.getPxtTrabajo());	
						}
						
						
						aso.setAscDuiFechaExp(new Date());
						aso.setAscDuiLugarExp("San Salvador");
						aso.setAscId(per.getPerId());
						aso.setAscIngresoCia(new Date());
						aso.setAscIngresoCoope(new Date());
						aso.setAscIsss("0");
						aso.setAscJefeInmediato("INVESTIGAR");
						aso.setAscNacionalidad("SALVADORE—A");
						aso.setAscNombreNit(pxt.getPxtPrimerApellido()+" "+pxt.getPxtSegundoApellido()+", "+pxt.getPxtNombres());
						aso.setAscPagaraPadre("N");
						aso.setAscPagoIngreso("N");
						aso.setAscProfesion("NO DEFINIDA");
						aso.setAscRentaDomicilio(new Float(150.00));
						
						CtaTasTipoAsociadoDAO tasDao = new CtaTasTipoAsociadoDAO(getSessionHibernate(request));
						CtaTasTipoAsociado tas = new CtaTasTipoAsociado();
						tas= tasDao.findById(7);
						aso.setCtaTasTipoAsociado(tas);
						aso.setAscSalario(pxt.getPxtSalario());
						
						CtaTcoTipoContratoDAO tcoDao = new CtaTcoTipoContratoDAO(getSessionHibernate(request));;
						CtaTcoTipoContrato tco = new CtaTcoTipoContrato();
						tco= tcoDao.findById(1);
						aso.setCtaTcoTipoContrato(tco);
						
						CtrEstEstadoDAO estDao = new CtrEstEstadoDAO(getSessionHibernate(request));;
						CtrEstEstado est = new CtrEstEstado();
						est = estDao.findById(6);
						aso.setCtrEstEstado(est);
						aso.setEstId(6);
						aso.setSecPerPersona(per);
						aso.setCtaDomDomicilio(null);
						ascDao.save(aso);
						fxp.setCtaAscAsociado(aso);
					asoTX.commit();
					ascDao.getSession().flush();
					ascDao.getSession().clear();

					
					
				}else{
					 if(fiadorPrestamoDAO.findByProperty(ASC_ID,fxp.getCtaAscAsociado().getAscId()).size() > parametrosDAO.findById("MAXIMO_ASC_FIADOR").getParValorNumber()){
						 	CtaAscAsociadoDAO asociadoDAO = new CtaAscAsociadoDAO(getSessionHibernate(request));
						 	CtaAscAsociado asoc = asociadoDAO.findById(fxp.getCtaAscAsociado().getAscId());
							mapaNota.put(System.currentTimeMillis()+12, asoc.getSecPerPersona().toString() + " "+getResources(request).getMessage("errors.fxp.fiadorNumAscSuperado"));
						}
				}
				fxp.setFxpEstado("V");// denota estado de verificacion
				fxp.setCtaTfiTipoFiador(null);
				fxp.getCtaPrePrestamo().setPreId(prestamoForm.getPreId());
				fiadorPrestamoDAO.save(fxp);
			}
			Iterator<String> itNot = mapaNota.values().iterator();
			while(itNot.hasNext()){//almacenamos las notas y las asociamos a la cuenta de prestamo
				CtaNotNotas notas = new CtaNotNotas();
				notas.setCasCuenta(cuentaAsociado.getCasCuenta());
				notas.setNotFecha(new Date());
				notas.setNotNota(itNot.next());
				notas.setNotId(notasDAO.nextId());
				notasDAO.save(notas);
			}
			tx.commit();
		}catch (Exception e) {
			tx.rollback();
			e.printStackTrace();
		}finally{
			prestamoDAO.getSession().flush();
			prestamoDAO.getSession().clear();
			
		}
	}
	
	public ActionForward loadPrestamoExistente(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		PrestamoForm prestamoForm = (PrestamoForm) form;
		CtaCasCuentaAsociadoDAO cuentaAsociadoDAO = new CtaCasCuentaAsociadoDAO(getSessionHibernate(request));
		CtaPrePrestamoDAO prestamoDAO = new CtaPrePrestamoDAO(getSessionHibernate(request));
		CtaTprTipoPrestamoDAO tipoPrestamoDAO = new CtaTprTipoPrestamoDAO(getSessionHibernate(request));
		CtaTinTasaInteresDAO tasaInteresDAO = new CtaTinTasaInteresDAO(getSessionHibernate(request));
		SecParParentescoDAO parentescoDAO = new SecParParentescoDAO(getSessionHibernate(request));
		CtaTgaTipoGarantiaDAO tipoGarantiaDAO = new CtaTgaTipoGarantiaDAO(getSessionHibernate(request));
		CtaCasCuentaAsociado cas = cuentaAsociadoDAO.findByPreId(prestamoForm.getPreId());
		//CtaPrePrestamo prestamo = prestamoDAO.findById(cas.getCtaPrePrestamo().getPreId());
		CtaPrePrestamo prestamo = cas.getCtaPrePrestamo();
		
		//Redondeando el n√∫mero
		DecimalFormat df = new DecimalFormat("0.00");		
		
		//Calcular saldo con los intereses pendientes
		IntereseYMora iYm = new IntereseYMora();
		CtaMxpMovimientoPrestamoDAO mxpDao = new CtaMxpMovimientoPrestamoDAO(getSessionHibernate(request));
		CtaMxpMovimientoPrestamo mxpAnt = mxpDao.findUltimoMovimiento(cas.getCtaPrePrestamo().getPreId());
		if(mxpAnt == null || mxpAnt.getMxpId() == null){
			mxpAnt = new CtaMxpMovimientoPrestamo();
		}
		iYm = iYm.actualizaInteres(mxpAnt, cas.getCtaPrePrestamo(), cas, new Date(),request);
		Double saldoConInteres = cas.getCtaPrePrestamo().getPreSaldoActualT() + iYm.getAcumulado() + iYm.getPendiente();
		
		prestamo.setPreSaldoActualT(new Double(df.format(saldoConInteres)));
		
		CtaAscAsociadoDAO asociadoDAO = new CtaAscAsociadoDAO(getSessionHibernate(request));
		CtaAscAsociado asociado = asociadoDAO.findById(cas.getCtaAscAsociado().getAscId());
		
		prestamoForm.setAsociadoH(asociado);
		prestamoForm.setPrestamoH(prestamo);
		
		prestamoForm.setMontoSolicitadoAnterior(cas.getCtaPrePrestamo().getPreMontoSolicitado());
		/*CtaMxpMovimientoPrestamoDAO mxpDao = new CtaMxpMovimientoPrestamoDAO(getSessionHibernate(request));
		if(mxpDao.findUltimoMovimiento(cas.getCtaPrePrestamo().getPreId()) == null){
			prestamoForm.setPreSaldoActualT(cas.getCtaPrePrestamo().getPreMontoSolicitado() - cas.getCtaPrePrestamo().getPreLiquidoARecibir());
		}else{*/
			//prestamoForm.setPreSaldoActualT((cas.getCtaPrePrestamo().getPreSaldoActualT()+cas.getCtaPrePrestamo().getPreInteresAcumulado()+cas.getCtaPrePrestamo().getPrePendMov()));
		//}
		
		CtaTprTipoPrestamo tpr = tipoPrestamoDAO.findById(prestamoForm.getCtaTprTipoPrestamo().getTprId());
		prestamoForm.setLprId(tpr.getCtaLprLineaPrestamo().getLprId());
		prestamoForm.setPlmId(tpr.getCtaPlmPlanMeses().getPlmId());
		prestamoForm.setTinPlazoId(tpr.getCtaTinTasaInteres().getTinId());
		
		CtaLprLineaPrestamoDAO lprDao = new CtaLprLineaPrestamoDAO(getSessionHibernate(request));
		CtaPlmPlanMesesDAO planMesesDAO = new CtaPlmPlanMesesDAO(getSessionHibernate(request));
		
		List lineas = lprDao.findAll();
		request.setAttribute("lineas", lineas);
		request.setAttribute("listaPlanes", planMesesDAO.findAllWithName());
		request.setAttribute("listaTasas", tasaInteresDAO.findAllWithName());
		
		//CtaLprLineaPrestamo lpr = (CtaLprLineaPrestamo)lineas.get(0);
		List tprList = tipoPrestamoDAO.findByLinea(tpr.getCtaLprLineaPrestamo().getLprId());
		request.setAttribute("lstTpr", tprList);
		
		request.setAttribute("tipoGarantias", tipoGarantiaDAO.findAll());
		request.setAttribute("tinList", tasaInteresDAO.findAllWithName());
		request.setAttribute("parList", parentescoDAO.findAll());
		request.setAttribute("cuentas", cuentaAsociadoDAO.findCuentasSinPrestamos(prestamoForm.getAscId(),new Integer(9)));
		//request.setAttribute("tipos", tipoPrestamoDAO.findTiposVigentes(new Date()));
		request.setAttribute("form", prestamoForm);
		request.getSession().setAttribute("listaReferenciasPersonales",new HashMap<Long, CtaRpeReferenciasPersonales>() );
		request.getSession().setAttribute("listaReferenciasComerciales", new HashMap<Long,CtaRcoReferenciasComerciales>());
		request.getSession().setAttribute("listaNotas", new HashMap<Long, String>());
		request.getSession().setAttribute("listaFiadores", new HashMap<Long, CtaFxpFiadorPrestamo>());
		request.getSession().setAttribute("listaGarantias", new HashMap<Long, CtaGarGarantia>());
		request.getSession().setAttribute("listaDescuentos", new HashMap<Long, DescuentosExternosForm>());
		
		CtrParParametrosDAO parametrosDAO = new CtrParParametrosDAO(getSessionHibernate(request));
		Double iva = parametrosDAO.findById("IVA").getParValorNumber();
		request.setAttribute("iva", iva);
		
		if(prestamoForm.getCtaTinTasaInteres()==null){
			CtaTinTasaInteres ctaTinTasaInteres = new CtaTinTasaInteres();
			ctaTinTasaInteres.setTinTasa(0.00);
			prestamoForm.setCtaTinTasaInteres(ctaTinTasaInteres);
		}	
		
		request.setAttribute(Constantes.ACCION_KEY, "/prestamo");
		return mapping.findForward("creditoExistente");
	}
	
	public ActionForward refinanciar(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		PrestamoForm prestamoForm = (PrestamoForm)form;
		CtaTprTipoPrestamoDAO tipoPrestamoDAO = new CtaTprTipoPrestamoDAO(getSessionHibernate(request));
		CtaTinTasaInteresDAO tasaInteresDAO = new CtaTinTasaInteresDAO(getSessionHibernate(request));
		request.setAttribute("tinList", tasaInteresDAO.findAllWithName());
		request.setAttribute("tipos", tipoPrestamoDAO.findTiposVigentes(new Date()));
		request.setAttribute(Constantes.ACCION_KEY, "/prestamo");
		return mapping.findForward("verSolicitud");
	}
	
	public ActionForward verificacionRefinanciamiento(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		String respuesta;
		ArrayList<String> errors = new ArrayList<String>();
		PrestamoForm prestamoForm  = (PrestamoForm) form;
		CtaAscAsociadoDAO asociadoDAO = new CtaAscAsociadoDAO(getSessionHibernate(request));
		CtaAscAsociado asoc =  asociadoDAO.findById(prestamoForm.getAscId());
		CtaTprTipoPrestamoDAO tipoPrestamoDAO = new CtaTprTipoPrestamoDAO(getSessionHibernate(request));
		errors = validarSolicitudRefinanciamiento(prestamoForm, errors, request);
		if(asoc== null){
			errors.add(getResources(request).getMessage("errors.pre.asociadoNoSeleccionado"));
		}
		if (!errors.isEmpty()) {
			respuesta = "<table align=\"center\"><tr><td><input type=\"button\" value=\"Verificar Informacion\" onclick=\"ajaxCallNormal('"
					+ request.getContextPath()
					+ "/cuentaCorriente/prestamo.do','accion=verificacionRefinanciamiento&ascId='+$('#ascId').val()" +
							"+'&fuente='+$('#hidFuente').val()+'&casCuenta='+$('#casCuenta').val()" +
							"+'&lprId='+$('#lprId').val()" +
							"+'&plmId='+$('#plmId').val()" +
							"+'&tinPlazoId='+$('#tinPlazoId').val()" +							
							"+'&nuevoMontoSolicitado='+$('#nuevoMontoSolicitado').val()" +
							"+'&ctaTinTasaInteres.tinId='+$('#tinId').val()" +
							"+'&aportaciones='+$('#aportacionesId').val()"+
							"+'&preOtrasDeducciones='+$('#otrasDeducId').val()"+
							"+'&preId='+$('#preId').val()"+
							"+'&montoRecibir='+$('#montoRecibir').val()"+
							"+'&preIvaDeducciones='+$('#ivaId').val(),"+
							"'respuesta')\"/></td></tr></table>";
			respuesta = respuesta + construirListaErrores(errors);
		} else {
			/*
				respuesta = "<br>"
						+ getResources(request).getMessage("lbl.pre.mensajeInformativoPrestamo")
						+ "<br/>"
						+ "<a href=\""
						+ request.getContextPath()
						+ "/cuentaCorriente/prestamo.do?accion=lista\">"
						+ getResources(request).getMessage("lbl.pre.clickAqui")
						+ "</a>";
				*/
				CtaPrePrestamoDAO prestamoDAO = new CtaPrePrestamoDAO(getSessionHibernate(request));
				String preId = prestamoDAO.generarId("C");
				try{
					String prestamoAnterior = prestamoForm.getPreId();
					prestamoForm.setPreId(preId);
										
					List<CtaTprTipoPrestamo> listaTipos = tipoPrestamoDAO.findTasaByLineaAndPlazoAndTasa(prestamoForm.getLprId(), prestamoForm.getPlmId(), prestamoForm.getTinPlazoId());					
					if(listaTipos.size()!=0){//El tipo de pr√©stamo ya existe
						prestamoForm.setCtaTprTipoPrestamo((CtaTprTipoPrestamo) listaTipos.get(0));
						//System.out.println("El tipo de pr√©stamo ya existe");
					}else{//Hay que crear el tipo de pr√©stamo
						CtaTprTipoPrestamo ctaTprTipoPrestamo = new CtaTprTipoPrestamo();
						Integer id = tipoPrestamoDAO.nextId(); 
						ctaTprTipoPrestamo.setTprId(id);
						
						CtaLprLineaPrestamoDAO ctaLprLineaPrestamoDAO = new CtaLprLineaPrestamoDAO(getSessionHibernate(request));
						CtaLprLineaPrestamo ctaLprLineaPrestamo =  ctaLprLineaPrestamoDAO.findById(prestamoForm.getLprId());
						CtaPlmPlanMesesDAO ctaPlmPlanMesesDAO = new CtaPlmPlanMesesDAO(getSessionHibernate(request));
						CtaPlmPlanMeses ctaPlmPlanMeses = ctaPlmPlanMesesDAO.findById(prestamoForm.getPlmId());
						CtaTinTasaInteresDAO ctaTinTasaInteresDAO = new CtaTinTasaInteresDAO(getSessionHibernate(request));
						CtaTinTasaInteres ctaTinTasaInteres = ctaTinTasaInteresDAO.findById(prestamoForm.getTinPlazoId());
						
						ctaTprTipoPrestamo.setCtaLprLineaPrestamo(ctaLprLineaPrestamo);
						ctaTprTipoPrestamo.setCtaPlmPlanMeses(ctaPlmPlanMeses);
						ctaTprTipoPrestamo.setCtaTinTasaInteres(ctaTinTasaInteres);
						ctaTprTipoPrestamo.setTprNombre(ctaLprLineaPrestamo.getLprNombre()+", "+ctaPlmPlanMeses.getPlmDuracion()+" MESES, TASA "+ctaTinTasaInteres.getTinNombre());
						ctaTprTipoPrestamo.setTprDescripcion(ctaLprLineaPrestamo.getLprNombre()+", "+ctaPlmPlanMeses.getPlmDuracion()+" MESES, TASA "+ctaTinTasaInteres.getTinNombre());
						
						tipoPrestamoDAO.save(ctaTprTipoPrestamo);
						prestamoForm.setCtaTprTipoPrestamo((CtaTprTipoPrestamo) tipoPrestamoDAO.findById(id));
						//System.out.println("El tipo de pr√©stamo no existe");
					}			
					saveSolicitudRefinanciamiento(prestamoForm,request,asoc, prestamoAnterior);
					respuesta = "<label class=\"obligatorio\">"+getResources(request).getMessage("lbl.pre.mensajeInformativoPrestamo")
					+ "</label><br><br><table align=\"center\"><tr><td>"+
					"<input type=\"button\" onclick=\"generarComprobante('"+asoc.getAscId()+"','"+asoc.getAscSalario()+"','"+preId+"')\" value=\"Generar Constancia de Descuentos\"/>"
					+"</td><td><input type=\"submit\" value=\"Finalizar\" name=\"accion\"/></td></tr></table>";
				}catch(Exception e){
					e.printStackTrace();
					respuesta = "<table align=\"center\"><tr><td><span style=\"font-size: 10px;color: red;font-style: italic;\">Ha "
					+"Ocurrido un error inesperado al intentar guardar la solicitud, por favor contacte al administrador del sistema para mayor informacion.</span></td></tr></table>";
				} 
		}
		try {
			response.getWriter().write(respuesta);
			response.getWriter().flush();
			response.getWriter().close();
		} catch (IOException e) {
			e.printStackTrace();
		}
		return null;
	}
	
	private void saveSolicitudRefinanciamiento(PrestamoForm prestamoForm,HttpServletRequest request,CtaAscAsociado asociado, String prestamoAnterior){
		CtaTprTipoPrestamoDAO tipoPrestamoDAO = new CtaTprTipoPrestamoDAO(getSessionHibernate(request));
		CtrParParametrosDAO parametrosDAO = new CtrParParametrosDAO(getSessionHibernate(request));
		CtaPrePrestamoDAO prestamoDAO = new CtaPrePrestamoDAO(getSessionHibernate(request));
		CtaCasCuentaAsociado cuentaAsociado = new CtaCasCuentaAsociado();
		CtaCasCuentaAsociadoDAO cuentaAsociadoDAO = new CtaCasCuentaAsociadoDAO(getSessionHibernate(request));
		CtaRpeReferenciasPersonalesDAO referenciasPersonalesDAO = new CtaRpeReferenciasPersonalesDAO(getSessionHibernate(request));
		CtaRcoReferenciasComercialesDAO referenciasComercialesDAO = new CtaRcoReferenciasComercialesDAO(getSessionHibernate(request));
		CtaGarGarantiaDAO garantiaDAO = new CtaGarGarantiaDAO(getSessionHibernate(request));
		CtaFxpFiadorPrestamoDAO fiadorPrestamoDAO = new CtaFxpFiadorPrestamoDAO(getSessionHibernate(request));
		CtaNotNotasDAO notasDAO = new CtaNotNotasDAO(getSessionHibernate(request));
		CtaPxtPersonaExternaDAO pexDAO = new CtaPxtPersonaExternaDAO(getSessionHibernate(request));
		CtaDexDescuentosExternosDAO dexDAO = new CtaDexDescuentosExternosDAO(getSessionHibernate(request));
		HashMap<Long, CtaGarGarantia> mapaGar = (HashMap<Long, CtaGarGarantia>)request.getSession().getAttribute("listaGarantias");
		HashMap<Long, CtaDexDescuentosExternos> mapaDxp = (HashMap<Long, CtaDexDescuentosExternos>)request.getSession().getAttribute("listaDescuentos");
		HashMap<Long, CtaRcoReferenciasComerciales> mapaRco = (HashMap<Long,CtaRcoReferenciasComerciales>)request.getSession().getAttribute("listaReferenciasComerciales");
		HashMap<Long, CtaRpeReferenciasPersonales> mapaRpe = (HashMap<Long, CtaRpeReferenciasPersonales>)request.getSession().getAttribute("listaReferenciasPersonales");
		HashMap<Long, String> mapaNota = (HashMap<Long,String>)request.getSession().getAttribute("listaNotas");
		HashMap<Long, CtaFxpFiadorPrestamo> mapaFxp = (HashMap<Long, CtaFxpFiadorPrestamo>)request.getSession().getAttribute("listaFiadores");
		CtaPrePrestamo prestamo = prestamoForm.getPrestamoH();
		Transaction tx = prestamoDAO.getSession().beginTransaction();
		Transaction fiaTx = fiadorPrestamoDAO.getSession().beginTransaction();
		try{
			//Obtener casCuenta del prestamo que se esta refinanciando
			String preRef = prestamoAnterior;
			CtaCasCuentaAsociado cas = cuentaAsociadoDAO.findByPreId(preRef);
			
			String preId = prestamoDAO.generarId("C");
			prestamoForm.setPreId(preId);
			CtaTprTipoPrestamo tipoPrestamo = tipoPrestamoDAO.findById(prestamo.getCtaTprTipoPrestamo().getTprId());
			prestamo.setPreSaldoActualT(prestamoForm.getNuevoMontoSolicitado());
			prestamo.setPreReferencia(preId);
			prestamo.setPreCuota(Calculadora.calcularCuotaDouble(prestamoForm.getNuevoMontoSolicitado(),tipoPrestamo.getCtaTinTasaInteres().getTinTasa().doubleValue(), tipoPrestamo.getCtaPlmPlanMeses().getPlmDuracion()));
			prestamo.setPreMontoSolicitado(prestamoForm.getNuevoMontoSolicitado());
			prestamo.setPreGastoAbogado(parametrosDAO.findById("PAGO_ABOGADO").getParValorNumber());
			prestamo.setPreMoraEmbargo(parametrosDAO.findById("MORA_EMBARGO").getParValorNumber());
			prestamo.setPreLiquidoARecibir(prestamoForm.getMontoRecibir());
			
			prestamo.setPreInteresAcumulado(new Double(0.00));
			prestamo.setPreFechaSolicitud(new Date());
			/*if(prestamoForm.isFuente() == false){
				prestamo.setCasCuenta(prestamoForm.getCasCuenta());
			}else{
				prestamo.setCasCuenta(null);
			}*/
			prestamo.setCasCuenta(null);
			prestamo.setPreOtrasDeducciones(prestamoForm.getPreOtrasDeducciones());
			prestamo.setPreIvaDeducciones(prestamoForm.getPreIvaDeducciones());
			prestamo.setPreAportaciones(prestamoForm.getAportaciones());
			prestamo.setCtaSegSeguros(null);
			prestamo.setCtaCbaCuentaBancaria(null);
			prestamoDAO.save(prestamo);
			
			cuentaAsociado.getCtrEstEstado().setEstId(14);//estado de "En evaluacion"
			cuentaAsociado.setCtaAscAsociado(prestamoForm.getAsociadoH());
			cuentaAsociado.setCtaPrePrestamo(prestamo);
			cuentaAsociado.setCasFechaApertura(new Date());
			cuentaAsociado.setCasValorApertura(0.00);
			cuentaAsociado.setCtaCahCuentaAhorro(null);
			cuentaAsociado.setCtaCbaCuentaBancaria(null);
			cuentaAsociado.setCtaSegSeguros(null);
			cuentaAsociado.setCasPrincipal("N");
			cuentaAsociado.setCtaPxtPersonaExterna(null);
			cuentaAsociado.setCasRefinanciado(cas.getCasCuenta());
			cuentaAsociadoDAO.save(cuentaAsociado);

			/*CtaNotNotas notas2 = new CtaNotNotas();
			notas2.setCasCuenta(cuentaAsociado.getCasCuenta());
			CtaTntTipoNotaDAO tipoNotaDAO = new CtaTntTipoNotaDAO(getSessionHibernate(request));
			notas2.setCtaTntTipoNota(tipoNotaDAO.findById(9));
			notas2.setNotFecha(new Date());
			notas2.setNotNota(prestamoForm.getAportaciones().toString());
			notas2.setNotId(notasDAO.nextId());
			notasDAO.save(notas2);*/
			
			Iterator<CtaGarGarantia> itGar = mapaGar.values().iterator();
			//comparamos las garantias ingresadas contra las garantias establecidas en la linea
			if(mapaGar.size() < (tipoPrestamo.getCtaLprLineaPrestamo().getLprMinGarantias()==null?0:tipoPrestamo.getCtaLprLineaPrestamo().getLprMinGarantias())){ 
				mapaNota.put(System.currentTimeMillis()+12, getResources(request).getMessage("error.gar.cantidadMinimoGarantias"));
			}
			if(mapaRco.size() < (tipoPrestamo.getCtaLprLineaPrestamo().getLprMinRefComerciales()==null?0:tipoPrestamo.getCtaLprLineaPrestamo().getLprMinRefComerciales())){ 
				mapaNota.put(System.currentTimeMillis()+12, getResources(request).getMessage("errors.rpe.RcoCantidadMinima"));
			}
			if(mapaRpe.size() < (tipoPrestamo.getCtaLprLineaPrestamo().getLprMinRefPersonales()==null?0:tipoPrestamo.getCtaLprLineaPrestamo().getLprMinRefPersonales())){ 
				mapaNota.put(System.currentTimeMillis()+12, getResources(request).getMessage("errors.rpe.RpeCantidadMinima"));
			}
			if(mapaFxp.size() < (tipoPrestamo.getCtaLprLineaPrestamo().getLprMinFiadores()==null?0:tipoPrestamo.getCtaLprLineaPrestamo().getLprMinFiadores())){ 
				mapaNota.put(System.currentTimeMillis()+12, getResources(request).getMessage("errors.fxp.fiadorMinNum"));
			}
			//verificamos si cumple la restriccion del sueldo
			if(asociado.getAscSalario() < (tipoPrestamo.getCtaLprLineaPrestamo().getLprSueldoMinimo()==null?0:tipoPrestamo.getCtaLprLineaPrestamo().getLprSueldoMinimo())){
				mapaNota.put(System.currentTimeMillis()+12, getResources(request).getMessage("errors.pre.asocNoCumpleSalario"));
			}
			while(itGar.hasNext()){//salvamos todas las garantias y les asignamos el id del prestamo
				CtaGarGarantia gar = itGar.next();
				gar.getCtaPrePrestamo().setPreId(preId);
					garantiaDAO.save(gar);
			}
			Iterator<CtaDexDescuentosExternos> itDxp = mapaDxp.values().iterator();
			while(itDxp.hasNext()){//salvamos todos los descuentos externos y les asignamos el id del prestamo
				CtaDexDescuentosExternos dexDescuentosExternos = itDxp.next();
				dexDescuentosExternos.getCtaPrePrestamo().setPreId(preId);
				dexDescuentosExternos.setCtaLprLineaPrestamo(null);
				dexDAO.save(dexDescuentosExternos);
			}
			Iterator<CtaRpeReferenciasPersonales> itRpe = mapaRpe.values().iterator();
			while(itRpe.hasNext()){//salvamos todas las referencias personales y les asignamos el id del prestamo
				CtaRpeReferenciasPersonales rpe = itRpe.next();
				rpe.setRpeEstadoValidez("I");//asumimos estado de invalidez para las referecias personales
				CtaPrePrestamo press = prestamoDAO.findById(preId);
				rpe.setCtaPrePrestamo(press);
				referenciasPersonalesDAO.save(rpe);
			}
			Iterator<CtaRcoReferenciasComerciales> itRco = mapaRco.values().iterator();
			while(itRco.hasNext()){//salvamos las referencias comerciales y les asignamos el id del prestamo.
				CtaRcoReferenciasComerciales rco = itRco.next();
				rco.setRcoEstado("A");//asumimos el estado de activas
				CtaPrePrestamo press = prestamoDAO.findById(preId);
				rco.setCtaPrePrestamo(press);
				referenciasComercialesDAO.save(rco);
			}
			Iterator<CtaFxpFiadorPrestamo> itFxp = mapaFxp.values().iterator();
			while(itFxp.hasNext()){//salvamos los fiadores  y les asignamos el id del prestamo.
				CtaFxpFiadorPrestamo fxp = itFxp.next();
				if (fxp.getCtaAscAsociado() == null) {//solo si es persona externa
					
					/*
					
					fxp.getCtaPxtPersonaExterna().setPxtId(pexDAO.generarId());
					pexDAO.save(fxp.getCtaPxtPersonaExterna());
					
					*/
					
					CtaPxtPersonaExternaDAO pxtDao = new CtaPxtPersonaExternaDAO(getSessionHibernate(request));
					CtaPxtPersonaExterna pxt = new CtaPxtPersonaExterna();
					Transaction perTX = pxtDao.getSession().beginTransaction();
					
					SecPerPersonaDAO perDao = new SecPerPersonaDAO(getSessionHibernate(request));
					SecPerPersona per = new SecPerPersona();
					SecDppDepartamentoPaisDAO dppDao = new SecDppDepartamentoPaisDAO(getSessionHibernate(request));
					SecDppDepartamentoPais dpp = new SecDppDepartamentoPais();
					
					dpp = dppDao.findById(1);
					
					pxt = fxp.getCtaPxtPersonaExterna();
					fxp.setCtaPxtPersonaExterna(null);		
						per.setAudFechaCreacion(new Date());
						per.setAudFechaModificacion(new Date());
						per.setAudUsuarioCreacion(prestamoForm.getUsuarioConectado().getNombreUsuario());
						per.setAudUsuarioModificacion(prestamoForm.getUsuarioConectado().getNombreUsuario());
						
						per.setSecDppDepartamentoPais(dpp);
						per.setPerApellidoCasada(" ");
						per.setPerCalle("");
						per.setPerCodigoPostal("0");
						per.setPerColoniaBarrio("");
						String dir = " ";
						if(pxt.getPxtDireccion()!=null){
							dir = pxt.getPxtDireccion();
						}
						per.setPerDireccionCompleta(dir);
						per.setSecSucSucursal(null);
						per.setPerDui(pxt.getPxtDui());
						per.setPerEstado("A");
						per.setPerFechaNacimiento(new Date());
						per.setPerGenero("M");
						per.setPerId(perDao.generarId());
						per.setPerLugarNacimiento("NO DISPONILE");
						per.setPerMunicipio("NO DISPONIBLE");
						per.setPerNit("0");
						per.setPerPrimerApellido(pxt.getPxtPrimerApellido());
						per.setPerPrimerNombre(pxt.getPxtNombres());
						per.setPerSegundoApellido(pxt.getPxtSegundoApellido());
						per.setPerSegundoNombre("");
						per.setPerTercerNombre("");
						
						perDao.save(per);
					perTX.commit();
					perDao.getSession().flush();
					perDao.getSession().clear();
					
					CtaNotNotasDAO notDao = new CtaNotNotasDAO(getSessionHibernate(request));
					CtaNotNotas not = new CtaNotNotas();
					
					not = notDao.findById(1);
					CtaAscAsociadoDAO ascDao = new CtaAscAsociadoDAO(getSessionHibernate(request));
					CtaAscAsociado aso = new CtaAscAsociado();					
					Transaction asoTX = ascDao.getSession().beginTransaction();
						
						aso.setCtaNotNotas(not);
						aso.setAscAsociadoPadre(null);
						
						if(pxt.getPxtCodigoEmpleado()!= null && pxt.getPxtCodigoEmpleado().length() > 1){
							aso.setAscCodigo(pxt.getPxtCodigoEmpleado());	
						}else{
							aso.setAscCodigo(ascDao.next());
						}
						
						String codigo = "F"+per.getPerId().substring(2, 12);
						aso.setAscCodigoAsociado(codigo);
						
						if(
								!aso.getAscCodigo().substring(0, 1).equalsIgnoreCase("F")
							){
								com.cetia.sicaco.hibernate.CtaDptDepartamentoTrabajoDAO dptDao = new com.cetia.sicaco.hibernate.CtaDptDepartamentoTrabajoDAO(getSessionHibernate(request));
								com.cetia.sicaco.hibernate.CtaDptDepartamentoTrabajo dpt = new com.cetia.sicaco.hibernate.CtaDptDepartamentoTrabajo();
	
								if(aso.getAscCodigo().substring(0, 2).equalsIgnoreCase("86")){
									dpt = dptDao.findById(388);
									aso.setCtaDptDepartamentoTrabajo(dpt);
								}else{
									dpt = dptDao.findById(389);
									aso.setCtaDptDepartamentoTrabajo(dpt);
								}
						}else{
							aso.setAscDirTrabajo(pxt.getPxtTrabajo());	
						}
						
						
						aso.setAscDuiFechaExp(new Date());
						aso.setAscDuiLugarExp("San Salvador");
						aso.setAscId(per.getPerId());
						aso.setAscIngresoCia(new Date());
						aso.setAscIngresoCoope(new Date());
						aso.setAscIsss("0");
						aso.setAscJefeInmediato("INVESTIGAR");
						aso.setAscNacionalidad("SALVADORE—A");
						aso.setAscNombreNit(pxt.getPxtPrimerApellido()+" "+pxt.getPxtSegundoApellido()+", "+pxt.getPxtNombres());
						aso.setAscPagaraPadre("N");
						aso.setAscPagoIngreso("N");
						aso.setAscProfesion("NO DEFINIDA");
						aso.setAscRentaDomicilio(new Float(150.00));
						
						CtaTasTipoAsociadoDAO tasDao = new CtaTasTipoAsociadoDAO(getSessionHibernate(request));
						CtaTasTipoAsociado tas = new CtaTasTipoAsociado();
						tas= tasDao.findById(7);
						aso.setCtaTasTipoAsociado(tas);
						aso.setAscSalario(pxt.getPxtSalario());
						
						CtaTcoTipoContratoDAO tcoDao = new CtaTcoTipoContratoDAO(getSessionHibernate(request));;
						CtaTcoTipoContrato tco = new CtaTcoTipoContrato();
						tco= tcoDao.findById(1);
						aso.setCtaTcoTipoContrato(tco);
						
						CtrEstEstadoDAO estDao = new CtrEstEstadoDAO(getSessionHibernate(request));;
						CtrEstEstado est = new CtrEstEstado();
						est = estDao.findById(6);
						aso.setCtrEstEstado(est);
						aso.setEstId(6);
						aso.setSecPerPersona(per);
						aso.setCtaDomDomicilio(null);
						ascDao.save(aso);
						fxp.setCtaAscAsociado(aso);
					asoTX.commit();
					ascDao.getSession().flush();
					ascDao.getSession().clear();


					
				}else{
					 if(fiadorPrestamoDAO.findByProperty(ASC_ID,fxp.getCtaAscAsociado().getAscId()).size() > parametrosDAO.findById("MAXIMO_ASC_FIADOR").getParValorNumber()){
						 	CtaAscAsociadoDAO asociadoDAO = new CtaAscAsociadoDAO(getSessionHibernate(request));
						 	CtaAscAsociado asoc = asociadoDAO.findById(fxp.getCtaAscAsociado().getAscId());
							mapaNota.put(System.currentTimeMillis()+12, asoc.getSecPerPersona().toString() + " "+getResources(request).getMessage("errors.fxp.fiadorNumAscSuperado"));
						}
				}
				fxp.setFxpEstado("V");// denota estado de verificacion
				fxp.setCtaTfiTipoFiador(null);
				//fxp.getCtaPrePrestamo().setPreId(preId);
				CtaPrePrestamo ctaPrePrestamo= prestamoDAO.findById(preId);
				fxp.setCtaPrePrestamo(ctaPrePrestamo);
				fiadorPrestamoDAO.save(fxp);
				fiaTx.commit();
				fiadorPrestamoDAO.getSession().flush();
				fiadorPrestamoDAO.getSession().clear();
			}
			Iterator<String> itNot = mapaNota.values().iterator();
			while(itNot.hasNext()){//almacenamos las notas y las asociamos a la cuenta de prestamo
				CtaNotNotas notas = new CtaNotNotas();
				notas.setCasCuenta(cuentaAsociado.getCasCuenta());
				notas.setNotFecha(new Date());
				notas.setNotNota(itNot.next());
				notas.setNotId(notasDAO.nextId());
				notasDAO.save(notas);
			}
			tx.commit();
		}catch (Exception e) {
			tx.rollback();
			e.printStackTrace();
		}finally{
			prestamoDAO.getSession().flush();
			prestamoDAO.getSession().clear();
			
		}
	}
	
	private ArrayList<String> validarSolicitudRefinanciamiento(PrestamoForm prestamoForm,ArrayList<String> errors,HttpServletRequest request){
		CtrParParametrosDAO parametrosDAO = new CtrParParametrosDAO(getSessionHibernate(request));
		CtaTprTipoPrestamo tipoPrestamo = prestamoForm.getCtaTprTipoPrestamo();
		CtaPrePrestamoDAO prestamoDAO = new CtaPrePrestamoDAO(getSessionHibernate(request));
		CtaAscAsociadoDAO asociadoDAO = new CtaAscAsociadoDAO(getSessionHibernate(request));
		CtaAscAsociado asoc =  asociadoDAO.findById(prestamoForm.getAscId());
		
		CtaPrePrestamo prestamo = prestamoDAO.findById(prestamoForm.getPreId());
		if(((prestamo.getPreMontoSolicitado() - prestamo.getPreSaldoActualT())*100)/prestamo.getPreMontoSolicitado()
				< parametrosDAO.findById("MINIMO_CANCELADO_REFINANCIAR").getParValorNumber()){
			errors.add(getResources(request).getMessage("errors.rpe.minimoNoCumplido"));
		}
		if(prestamoForm.getNuevoMontoSolicitado() <= 0){
			errors.add(getResources(request).getMessage("errors.pre.montoSolicitadoRequerido"));
		}
		if(prestamoForm.getMontoRecibir() < 0){
			errors.add(getResources(request).getMessage("errors.pre.noEsSuficiente"));
		}
		if(asoc.getCtrEstEstado().getEstId()==6)  errors.add(getResources(request).getMessage("errors.pre.liquidado"));
		
		return errors;
	}
	
	public ActionForward cargarSolicitud(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {//metodo para cargar una solicitud
		SecIseInicioSesionDAO sesionDAO = new SecIseInicioSesionDAO(getSessionHibernate(request));
		CtaCasCuentaAsociadoDAO cuentaAsociadoDAO = new CtaCasCuentaAsociadoDAO(getSessionHibernate(request));
		CtaNotNotasDAO ctaNotNotasDAO = new CtaNotNotasDAO(getSessionHibernate(request));
		PrestamoForm prestamoForm = (PrestamoForm) form;
		CtaCasCuentaAsociado cuentaAsociado = cuentaAsociadoDAO.findByPreId(prestamoForm.getPreId());
		if(cuentaAsociado != null && cuentaAsociado.getCasRefinanciado()!= null){
			request.setAttribute("refinanciado", 1);
		}
		prestamoForm.setPrestamoH(cuentaAsociado.getCtaPrePrestamo());
		prestamoForm.setEstado(cuentaAsociado.getCtrEstEstado().getEstId());
		SecIseInicioSesion sesion = sesionDAO.findById(prestamoForm.getUsuarioConectado().getNombreUsuario());

		if((sesion.getSecRolRoles().getRolNombre().equals("COMITECRED") || sesion.getSecRolRoles().getRolNombre().equals("ADMINISTRADOR")) 
				/*&& !sesion.getSecPerPersona().getPerId().equals(cuentaAsociado.getCtaAscAsociado().getSecPerPersona().getPerId())*/){
			request.setAttribute("rol", sesion.getSecRolRoles().getRolNombre());
		}
		if(cuentaAsociado.getCasFechaCierre() == null){
			CtaMxpMovimientoPrestamoDAO mxpDao = new CtaMxpMovimientoPrestamoDAO(getSessionHibernate(request));
			if(mxpDao.getFechaPrimerMov(prestamoForm.getPreId()) != null){
				prestamoForm.setVencimiento(
						ElapsedTime.obtenerFechaMeses(
								(Date)mxpDao.getFechaPrimerMov(prestamoForm.getPreId()), 
								cuentaAsociado.getCtaPrePrestamo().getCtaTprTipoPrestamo()
								.getCtaPlmPlanMeses().getPlmDuracion()));
			}else{
				ElapsedTime.obtenerFechaMeses(cuentaAsociado.getCasFechaApertura(), 
						cuentaAsociado.getCtaPrePrestamo().getCtaTprTipoPrestamo()
						.getCtaPlmPlanMeses().getPlmDuracion());
			}
			
		}else{
			prestamoForm.setVencimiento(cuentaAsociado.getCasFechaCierre());
		}
		request.setAttribute("cuentas", cuentaAsociadoDAO.findCuentasSinPrestamos(cuentaAsociado.getCtaAscAsociado().getAscId(),new Integer(9)));
		
		//divisor de cuotas para planilla
		CtrParParametrosDAO parametrosDAO = new CtrParParametrosDAO(getSessionHibernate(request));
		CtrParParametros parDivisorCuotas = parametrosDAO.findById("DIVISOR_CUOTAS_MES");
		prestamoForm.setCuotaPlanilla(prestamoForm.getPreCuota()/parDivisorCuotas.getParValorNumber());
		
		if(prestamoForm.getCtaTinTasaInteres()==null){
			prestamoForm.setTasaMora(0.0);
		}else{
			prestamoForm.setTasaMora(prestamoForm.getCtaTinTasaInteres().getTinTasa());
		}
		//Double cuotasPendientes = prestamoForm.getPreSaldoActualT()/prestamoForm.getPreCuota();
		//Double roundCuotas = Redondeo.roundDouble(cuotasPendientes, 0);
		prestamoForm.setCuotasPendientes(Calculadora.calcularPeriodosRestantes(prestamoForm.getPreSaldoActualT(), prestamoForm.getCtaTprTipoPrestamo().getCtaTinTasaInteres().getTinTasa(), prestamoForm.getPreCuota()));
		request.setAttribute("form", prestamoForm);
		request.setAttribute("notas", ctaNotNotasDAO.findbyCuenta(cuentaAsociado.getCasCuenta()));
		request.setAttribute("asociado", cuentaAsociado.getCtaAscAsociado());
		request.setAttribute(Constantes.ACCION_KEY, "/prestamo");
		
		
		if(cuentaAsociado.getCtaAscAsociado().getCtrEstEstado().getEstId()!=6) request.setAttribute("refinanciar", "true");
		return mapping.findForward("verSolicitud");
	}
	
	public ActionForward buscarPrestamos(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		CtaCasCuentaAsociadoDAO ctaCasCuentaAsociadoDAO = new CtaCasCuentaAsociadoDAO(getSessionHibernate(request));
		CtrEstEstadoDAO estadoDAO = new CtrEstEstadoDAO(getSessionHibernate(request));
		PrestamoForm prestamoForm = (PrestamoForm) form;
		TableFacade tableFacade = TableFacadeFactory.createTableFacade(TABLA_ID, request);
		//tableFacade.setExportTypes(response, ExportType.CSV, ExportType.JEXCEL);
		tableFacade.setStateAttr("restore");
		Limit limit = tableFacade.getLimit();
		int totalRows =ctaCasCuentaAsociadoDAO.getTotalRowCountPrestamosByCriteria(prestamoForm);
		tableFacade.setTotalRows(totalRows);
		int rowStart = limit.getRowSelect().getRowStart();
		int rowEnd = limit.getRowSelect().getRowEnd();
		List<CtaCasCuentaAsociado> lista = ctaCasCuentaAsociadoDAO.findPrestamosByCriteria(prestamoForm, rowStart, rowEnd);
		tableFacade.setItems(lista);
		/*List<CtaCasCuentaAsociado> items = ctaCasCuentaAsociadoDAO.findPrestamosByCriteria(prestamoForm);
		TableFacade tableFacade = new TableFacadeImpl(TABLA_ID, request);
		tableFacade.setItems(items);
		//---- Genera los tipos de formas con que se podran exportar los datos
		tableFacade.setExportTypes(response, ExportType.CSV, ExportType.JEXCEL);
		tableFacade.setStateAttr("restore");
		int totalRows = ctaCasCuentaAsociadoDAO.getTotalRowCountPrestamosByCriteria(prestamoForm);//ctaCasCuentaAsociadoDAO.getTotalPrestamosRowCount();
		Limit limit = tableFacade.getLimit();*/
		if (limit.isExported()) {
        	//---- exporta la tabla
           // export(tableFacade,cuentaAsociadoForm.getTipoCuentaMadre());
            return null; 
        } else {
        	//---- genera el html de la tabla para ser mostrada
            //String html = html(tableFacade, request);
        	String html;
        	if(prestamoForm.getEstado()==15) html = htmlAprobado(tableFacade, request); 
        	else html = html(tableFacade, request);
            request.setAttribute(Constantes.LISTA_KEY, html);
        }
        //----- Variables de configuracion
		request.setAttribute("estados",estadoDAO.findByTus("PREST"));
		request.setAttribute("form", prestamoForm);
		request.setAttribute(Constantes.ACCION_KEY, "/prestamo");
		return mapping.findForward("lista");
	}
	
	public ActionForward cancelar(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		return lista(mapping, form, request, response);
	}
	
	public ActionForward forwardToRco(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		ReferenciaComercialForm rcoForm = new ReferenciaComercialForm();
		PrestamoForm prestamoForm = (PrestamoForm) form;
		rcoForm.setPreId(prestamoForm.getPreId());
		rcoForm.setEstadoPrestamo(prestamoForm.getEstado());
		request.setAttribute("referenciaComercialForm",rcoForm);
		return mapping.findForward("forwardToRco");
	}
	
	public ActionForward forwardToRpe(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		PrestamoForm prestamoForm = (PrestamoForm) form;
		ReferenciaPersonalForm rpeForm = new ReferenciaPersonalForm();
		rpeForm.setPreId(prestamoForm.getPreId());
		rpeForm.setEstadoPrestamo(prestamoForm.getEstado());
		request.setAttribute("referenciaPersonalForm",rpeForm);
		return mapping.findForward("forwardToRpe");
	}
	
	public ActionForward forwardToDxp(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		PrestamoForm prestamoForm = (PrestamoForm) form;
		DescuentosExternosForm dxpForm = new DescuentosExternosForm();
		dxpForm.setPreId(prestamoForm.getPreId());
		dxpForm.setEstadoPrestamo(prestamoForm.getEstado());
		request.setAttribute("descuentosExternosForm",dxpForm);
		return mapping.findForward("forwardToDxp");
	}
	
	public ActionForward forwardToGxp(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		PrestamoForm prestamoForm = (PrestamoForm) form;
		GarantiaPrestamoForm gxpForm = new GarantiaPrestamoForm();
		gxpForm.setPreId(prestamoForm.getPreId());
		gxpForm.setEstadoPrestamo(prestamoForm.getEstado());
		request.setAttribute("garantiaPrestamoForm",gxpForm);
		return mapping.findForward("forwardToGxp");
	}
	
	public ActionForward forwardToFxp(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		PrestamoForm prestamoForm = (PrestamoForm) form;
		FiadorPrestamoForm fxpForm = new FiadorPrestamoForm();
		fxpForm.setPreId(prestamoForm.getPreId());
		fxpForm.setEstadoPrestamo(prestamoForm.getEstado());
		request.setAttribute("fiadorForm",fxpForm);
		return mapping.findForward("forwardToFxp");
	}
	
	public ActionForward forwardToNxp(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		PrestamoForm prestamoForm = (PrestamoForm) form;
		NotaGenericForm notaForm = new NotaGenericForm();
		notaForm.setPreId(prestamoForm.getPreId());
		notaForm.setEstadoPrestamo(prestamoForm.getEstado());
		request.setAttribute("notaGenericForm",notaForm);
		return mapping.findForward("forwardToNxp");
	}
	
	public ActionForward aprobarPrestamo(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		ActionErrors errors = new ActionErrors();
		CtaCasCuentaAsociadoDAO cuentaAsociadoDAO = new CtaCasCuentaAsociadoDAO(getSessionHibernate(request));
		CtrEstEstadoDAO estadoDAO = new CtrEstEstadoDAO(getSessionHibernate(request));
		PrestamoForm prestamoForm = (PrestamoForm) form;
		CtaCasCuentaAsociado cuenta = cuentaAsociadoDAO.findByPreId(prestamoForm.getPreId());
		CtrEstEstado estado = estadoDAO.findById(15);//buscamos el estado de aprobado
		Transaction tx = cuentaAsociadoDAO.getSession().beginTransaction();
		try{
			cuenta.setCtrEstEstado(estado);// cambiamos al estado de aprobacion
			cuentaAsociadoDAO.merge(cuenta);
			tx.commit();
			errors.add(ActionMessages.GLOBAL_MESSAGE,new ActionMessage("lbl.pre.aprobado"));
		}catch (Exception e) {
			// TODO: handle exception
			tx.rollback();
			e.printStackTrace();
		}finally{
			cuentaAsociadoDAO .getSession().flush();
			cuentaAsociadoDAO .getSession().clear();
			
		}
		saveMessages(request, errors);
		request.setAttribute(Constantes.ACCION_KEY, "/prestamo");
		request.setAttribute("estado",15);
		return mapping.findForward("respuesta");
	}
	
	public ActionForward regresarToPrestamoList(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		PrestamoForm prestamoForm = (PrestamoForm) form;
		return buscarPrestamos(mapping, prestamoForm, request, response);
	}
	
	public ActionForward forwardToCalculadora(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		CtaTprTipoPrestamoDAO tipoPrestamoDAO = new CtaTprTipoPrestamoDAO(getSessionHibernate(request));
		request.setAttribute("tipoPrest", tipoPrestamoDAO.findTiposVigentes(new Date()));
		request.setAttribute(Constantes.ACCION_KEY, "/prestamo");
		return mapping.findForward("forwardToCalculadora");
	}
	
	public ActionForward calcularCuota(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		String respuesta = null;
		PrestamoForm prestamoForm = (PrestamoForm) form;
		respuesta = validarCampos(prestamoForm);
		if(respuesta.length() == 0){
			respuesta = "<table align=\"center\">" +
							"<tr>" +
								"<td>" +
									"<span class=\"obligatorio\" >Plazo: </span>"+prestamoForm.getMesesSolicitados() +"meses"
								+"</td>" +
							"</tr>" +
							"<tr>" +
								"<td>" +
									"<span class=\"obligatorio\" >Tasa de Interes: </span>"+prestamoForm.getInteresSolicitado() +"&#37;"
								+"</td>" +
							"</tr>" +
								"<span class=\"obligatorio\" >Cuota: </span>"+ 
									Format.formatDinero(Calculadora.calcularCuotaFloat(prestamoForm.getPreMontoSolicitado().doubleValue(), prestamoForm.getInteresSolicitado(), prestamoForm.getMesesSolicitados()));
		}
		try {
			response.getWriter().write(respuesta);
			response.getWriter().flush();
			response.getWriter().close();
		} catch (IOException e) {
			e.printStackTrace();
		}
		return null;
	}
	
	public String validarCampos(PrestamoForm form){
		String errors = "";
		if(!(form.getPreMontoSolicitado()>0)){
			errors += "<span style=\"font-size: 10px;color: red;font-style: italic;\">"
				+ "No se puede realizar el calculo con un monto solicitado menor o igual que cero</span><br>";
		}
		if(form.getMesesSolicitados()<=0){
			errors += "<span style=\"font-size: 10px;color: red;font-style: italic;\">"
				+ "No se puede realizar el calculo con un plan de meses menor o igual que cero</span><br>";
		}
		if(form.getInteresSolicitado() < 0){
			errors += "<span style=\"font-size: 10px;color: red;font-style: italic;\">"
				+ "No se puede realizar el calculo con una tasa de interes menor o igual que cero</span>";
		}
		return errors;
	}

	public ActionForward denegarPrestamo(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		ActionErrors errors = new ActionErrors();
		CtaCasCuentaAsociadoDAO cuentaAsociadoDAO = new CtaCasCuentaAsociadoDAO(getSessionHibernate(request));
		CtrEstEstadoDAO estadoDAO = new CtrEstEstadoDAO(getSessionHibernate(request));
		PrestamoForm prestamoForm = (PrestamoForm) form;
		CtaCasCuentaAsociado cuenta = cuentaAsociadoDAO.findByPreId(prestamoForm.getPreId());
		CtrEstEstado estado = estadoDAO.findById(16);//buscamos el estado de denegado
		Transaction tx = cuentaAsociadoDAO.getSession().beginTransaction();
		try{
			cuenta.setCtrEstEstado(estado);// cambiamos al estado de denegado
			cuentaAsociadoDAO.merge(cuenta);
			tx.commit();
			errors.add(ActionMessages.GLOBAL_MESSAGE,new ActionMessage("lbl.pre.denegado"));
			request.setAttribute("denegado", "true");			
		}catch (Exception e) {
			// TODO: handle exception
			tx.rollback();
			e.printStackTrace();
		}finally{
			cuentaAsociadoDAO .getSession().flush();
			cuentaAsociadoDAO .getSession().clear();
			
		}
		saveMessages(request, errors);
		request.setAttribute(Constantes.ACCION_KEY, "/prestamo");
		return mapping.findForward("respuesta");
	}
	
	public ActionForward chequePrestamo(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		PrestamoForm prestamoForm = (PrestamoForm) form;
		request.getSession().setAttribute("preId", prestamoForm.getPreId());
		return mapping.findForward("aCheques");
	}
	
	public ActionForward generarComprobante(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		PrestamoForm prestamoForm = (PrestamoForm) form;
		
		String pathJasper="",jdbcDriver="",url,user,pass;
		
		response.setHeader("Cache-Control","private");
		response.setHeader("Pragma", "Cache");
		String nombreReporte = "constanciaAprobacionPrestamo";
		ReportFile reporte = new ReportFile();
		ServletContext servletContext = getServlet().getServletContext();
		pathJasper = servletContext
		.getRealPath("/listaReportes/asociados");
		reporte.addParameter("FECHA",new Date());
		reporte.addParameter("PRE_ID", prestamoForm.getPreId());
		reporte.addParameter("SUBREPORT_DIR",pathJasper);

		System.out.println("FECHA: "+new Date());
		System.out.println("PRE_ID: "+prestamoForm.getPreId());
		System.out.println("SUBREPORT_DIR: "+pathJasper);
		
		try{
			
		jdbcDriver = "com.mysql.jdbc.Driver";
		Class.forName(jdbcDriver);
		url = HibernateSessionFactory.getConfiguration().getProperty("connection.url");
		user = HibernateSessionFactory.getConfiguration().getProperty("connection.username");
		pass = HibernateSessionFactory.getConfiguration().getProperty("connection.password");

		Connection con = DriverManager.getConnection(url, user, pass);
		con = DriverManager.getConnection(url, user, pass);
		
		ExportWebReport export = new ExportWebReport();
		
		reporte.setPathJasper(pathJasper+"/prestamo_fiadores.jasper");
		export.setReportFile(reporte);
		export.exportPDFWeb(nombreReporte, request, response, true, con);

		}catch (Exception e) {
			e.printStackTrace();
		}		
		
		/*
		HashMap<String, Object> pars = new HashMap<String, Object>();
		PrestamoForm prestamoForm = (PrestamoForm) form;
		String pathReporte = getServlet().getServletContext().getRealPath(rutaReporte+reporteComprobante+".jrxml");
		int posicion = pathReporte.lastIndexOf("/");//para sistemas unix
		if(posicion == -1) posicion= pathReporte.lastIndexOf("\\");//para sistemas windows
		String pathSubreporte = pathReporte.substring(0,posicion+1);
		pars.put(FECHA,new Date());
		pars.put(PRE_ID, prestamoForm.getPreId());
		pars.put(SUBREPORT_DIR, pathSubreporte);
		try{
			Connection con = HibernateSessionFactory.getSession().connection();
			FileInputStream input = new FileInputStream(new File(pathReporte));
			JasperDesign jd = JRXmlLoader.load(input);
			JasperReport jr = JasperCompileManager.compileReport(jd);
			JasperPrint jp = JasperFillManager.fillReport(jr,pars, con);
			response.setHeader("Cache-Control","private");
			response.setHeader("Pragma", "Cache");
			response.setContentType("application/pdf");
			response.setHeader("content-Disposition", "attachment;filename=constanciaAprobacionPrestamo"  + new SimpleDateFormat("yyyy-MM-dd").format(new Date()) + ".pdf");
	        JRPdfExporter pdfExporter = new JRPdfExporter();
	        pdfExporter.setParameter(JRExporterParameter.JASPER_PRINT, jp);
	        pdfExporter.setParameter(JRExporterParameter.OUTPUT_STREAM, response.getOutputStream());
	        pdfExporter.exportReport();
		}catch (Exception e) {
			e.printStackTrace();
		}*/
		return null;
	}
	
	public ActionForward cargarTipos(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		PrestamoForm prestamoForm = (PrestamoForm)form;
		CtaTprTipoPrestamoDAO tprDao = new CtaTprTipoPrestamoDAO(getSessionHibernate(request));
		String listaResponse = "";
		try{
			if(prestamoForm.getLprId().equals(-1)){
				listaResponse = "No hay elementos que mostrar";
			}else{
				List tpr = tprDao.findByLinea(prestamoForm.getLprId());
				listaResponse = contruirListaTipos(tpr,request);
			}
			response.getWriter().write(listaResponse);
			response.getWriter().flush();
			response.getWriter().close();
		} catch (RuntimeException e) {
			log.error("Error runtime", e);
		} catch (IOException e) {
			log.error(e);
		}
		return null;
	}
	
	private String contruirListaTipos(List tpr, HttpServletRequest request) {
		HtmlBuilder html = new HtmlBuilder();
		html.select().name("ctaTprTipoPrestamo.tprId");
		html.id("tprId").styleClass("obligatorio").close();
		for (Iterator iterator = tpr.iterator(); iterator.hasNext();) {
			CtaTprTipoPrestamo tipo = (CtaTprTipoPrestamo) iterator.next();
			html.option().value(tipo.getTprId().toString()).close().append(tipo.getTprNombre()).optionEnd();
		}
		html.selectEnd();
		return html.toString();
	}
	
	public ActionForward generarDescuentos(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		
		CtrParParametrosDAO parametrosDAO = new CtrParParametrosDAO(getSessionHibernate(request));
		PrestamoForm prestamoForm = (PrestamoForm) form;
		
		String reporteP="",pathJasper="",jdbcDriver="",url,user,pass;
		
		response.setHeader("Cache-Control","private");
		response.setHeader("Pragma", "Cache");
		String nombreReporte = "Verificar Descuentos";;
		ReportFile reporte = new ReportFile();
		ServletContext servletContext = getServlet().getServletContext();
		pathJasper = servletContext
		.getRealPath("/listaReportes/asociados/constancia_descuentos.jasper");
		reporte.addParameter("ASC_ID",prestamoForm.getAscId());
		reporte.addParameter("PRE_ID", prestamoForm.getPreId());
		reporte.addParameter("ASC_SALARIO", prestamoForm.getAscSalario());
		reporte.addParameter("MIN_APORT", parametrosDAO.findById("APORTACION_MIN").getParValorNumber().floatValue());

		System.out.println("ASC_ID: "+prestamoForm.getAscId());
		System.out.println("PRE_ID: "+prestamoForm.getPreId());
		System.out.println("ASC_SALARIO: "+ prestamoForm.getAscSalario());
		System.out.println("MIN_APORT: "+ parametrosDAO.findById("APORTACION_MIN").getParValorNumber().floatValue());
		
		try{
			
		jdbcDriver = "com.mysql.jdbc.Driver";
		Class.forName(jdbcDriver);
		url = HibernateSessionFactory.getConfiguration().getProperty("connection.url");
		user = HibernateSessionFactory.getConfiguration().getProperty("connection.username");
		pass = HibernateSessionFactory.getConfiguration().getProperty("connection.password");

		Connection con = DriverManager.getConnection(url, user, pass);
		con = DriverManager.getConnection(url, user, pass);
		
		ExportWebReport export = new ExportWebReport();
		
		reporte.setPathJasper(pathJasper);
		export.setReportFile(reporte);
		export.exportPDFWeb(nombreReporte, request, response, true, con);
		
		
		
		
		/*
		String pathReporte = getServlet().getServletContext().getRealPath(rutaReporte+"constancia_descuentos.jrxml");
		int posicion = pathReporte.lastIndexOf("/");//para sistemas unix
		if(posicion == -1) posicion= pathReporte.lastIndexOf("\\");//para sistemas windows
		pars.put("ASC_ID",prestamoForm.getAscId());
		pars.put("PRE_ID", prestamoForm.getPreId());
		pars.put("ASC_SALARIO", prestamoForm.getAscSalario());
		pars.put("MIN_APORT", parametrosDAO.findById("APORTACION_MIN").getParValorNumber().floatValue());
		try{
			
			response.setHeader("Cache-Control","private");
			response.setHeader("Pragma", "Cache");
			response.setContentType("application/pdf");
			response.setHeader("content-Disposition", "attachment;filename=constancia_descuentos_" + prestamoForm.getPreId() +"_" + new SimpleDateFormat("yyyy-MM-dd").format(new Date()) + ".pdf");
	        
			Connection con = HibernateSessionFactory.getSession().connection();
			FileInputStream input = new FileInputStream(new File(pathReporte));
			
			JasperDesign jd = JRXmlLoader.load( new LegacyJasperInputStream(input));
			
			JasperReport jr = JasperCompileManager.compileReport(jd);
			JasperPrint jp = JasperFillManager.fillReport(jr,pars, con);
			
			JRPdfExporter pdfExporter = new JRPdfExporter();
	        
			pdfExporter.setParameter(JRExporterParameter.JASPER_PRINT, jp);
	        pdfExporter.setParameter(JRExporterParameter.OUTPUT_STREAM, response.getOutputStream());
	        pdfExporter.exportReport();
	        
	        */
		}catch (Exception e) {
			e.printStackTrace();
		}
		return null;
	}

//////////////////////////////Inicializando Solicitud de Refinanciamiento///////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
	
	public ActionForward inicializarSolicitudRefinanciamiento(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		PrestamoForm prestamoForm = (PrestamoForm) form;
		System.out.println("prestamoForm.getPreId()"+prestamoForm.getPreId());
		//Cargando Referencias Personales
		String listaResponse = "";
		//ReferenciaPersonalForm rpeForm = (ReferenciaPersonalForm) form;
		HashMap<Long, CtaRpeReferenciasPersonales> mapa = (HashMap<Long, CtaRpeReferenciasPersonales>)request.getSession().getAttribute("listaReferenciasPersonales");
		CtaRpeReferenciasPersonalesDAO referenciasPersonalesDAO = new CtaRpeReferenciasPersonalesDAO(getSessionHibernate(request));
		try {
		List<CtaRpeReferenciasPersonales> lista = referenciasPersonalesDAO.findByProperty("ctaPrePrestamo.preId", prestamoForm.getPreId());
		System.out.println("Size="+lista.size());
		request.getSession().setAttribute("listaReferenciasPersonales", lista);
		
		Iterator<CtaRpeReferenciasPersonales> iterator = lista.iterator();
		int add= 0;
			while(iterator.hasNext()) {
				CtaRpeReferenciasPersonales referenciasPersonales = (CtaRpeReferenciasPersonales) iterator.next();
				mapa.put(System.currentTimeMillis() + add, referenciasPersonales);
				add++;
			}
			listaResponse =construirListaReferenciasPersonales(mapa,request);
			String var = listaResponse;
			response.getWriter().write(var);
			response.getWriter().flush();
			response.getWriter().close();
		} catch (IOException e) {
			e.printStackTrace();
			System.out.println("Problemas al cargar Referencias Personales");
		}

		//Cargando Referencias Comerciales
		//String listaResponse = "";
		//ReferenciaComercialForm rcoForm = (ReferenciaComercialForm) form;
		HashMap<Long, CtaRcoReferenciasComerciales> mapa2 = (HashMap<Long, CtaRcoReferenciasComerciales>)request.getSession().getAttribute("listaReferenciasComerciales");
		CtaRcoReferenciasComercialesDAO referenciasComercialesDAO = new CtaRcoReferenciasComercialesDAO(getSessionHibernate(request));
		List<CtaRcoReferenciasComerciales> lista2 = referenciasComercialesDAO.findByProperty("ctaPrePrestamo.preId", prestamoForm.getPreId());
		request.getSession().setAttribute("listaReferenciasComerciales", lista2);
		
		Iterator<CtaRcoReferenciasComerciales> iterator2 = lista2.iterator();
		int add2 = 0;
		while(iterator2.hasNext()){
				CtaRcoReferenciasComerciales referenciasComerciales = (CtaRcoReferenciasComerciales) iterator2.next();
				mapa2.put(System.currentTimeMillis() + add2, referenciasComerciales);
				add2++;
		}
		listaResponse =construirListaReferenciasComerciales(mapa2,request);
		try {
			String var = listaResponse;
			response.getWriter().write(var);
			response.getWriter().flush();
			response.getWriter().close();
		} catch (IOException e) {
			e.printStackTrace();
			System.out.println("Problemas al cargar Referencias Comerciales");
		}		
		
		//Cargando Fiadores
		//String listaResponse = "";
		//FiadorPrestamoForm fiadorForm = (FiadorPrestamoForm) form;
		HashMap<Long, CtaFxpFiadorPrestamo> mapaF = (HashMap<Long, CtaFxpFiadorPrestamo>)request.getSession().getAttribute("listaFiadores");
		CtaFxpFiadorPrestamoDAO fiadorPrestamoDAO = new CtaFxpFiadorPrestamoDAO(getSessionHibernate(request));
		List<CtaFxpFiadorPrestamo> lista3 = fiadorPrestamoDAO.findByProperty("ctaPrePrestamo.preId", prestamoForm.getPreId());
		Iterator iterator3 = lista3.iterator();
		int add3 = 0;
		while(iterator3.hasNext()) {
			CtaFxpFiadorPrestamo fiadorPrestamo = (CtaFxpFiadorPrestamo) iterator3.next();
			mapaF.put(System.currentTimeMillis() + add3, fiadorPrestamo);
			add3++;
		}
		listaResponse =construirListaFiadores(mapaF, request);
		try {
			String var = listaResponse;
			response.getWriter().write(var);
			response.getWriter().flush();
			//response.getWriter().close();
		} catch (IOException e) {
			e.printStackTrace();
			System.out.println("Problemas al cargar Fiadores");
		}		
		
		//Cargando Garantias
		//String listaResponse = "";
		//GarantiaPrestamoForm garantiaPrestamoForm = (GarantiaPrestamoForm) form;
		HashMap<Long, CtaGarGarantia> mapaG = (HashMap<Long, CtaGarGarantia>)request.getSession().getAttribute("listaGarantias");
		CtaGarGarantiaDAO garantiaDAO = new CtaGarGarantiaDAO(getSessionHibernate(request));
		List<CtaGarGarantia> lista = garantiaDAO.findByProperty("ctaPrePrestamo.preId", prestamoForm.getPreId());
		Iterator<CtaGarGarantia> iterator = lista.iterator();
		int add = 0;
		while(iterator.hasNext()) {
			CtaGarGarantia garantia =  iterator.next();
			mapaG.put(System.currentTimeMillis() + add, garantia);
			add++;
		}
		listaResponse = construirListaGarantias(mapaG, request);
		try {
			String var = listaResponse;
			response.getWriter().write(var);
			response.getWriter().flush();
			//response.getWriter().close();
		} catch (IOException e) {
			e.printStackTrace();
			System.out.println("Problemas al cargar Garantias");
		}
		
		//Cargando Descuentos Externos
		//String listaResponse = "";
		//String listaErrores ="";
		//DescuentosExternosForm descuentosExternosForm = (DescuentosExternosForm) form;
		HashMap<Long, CtaDexDescuentosExternos> mapaD = (HashMap<Long, CtaDexDescuentosExternos>)request.getSession().getAttribute("listaDescuentos");
		CtaCasCuentaAsociadoDAO casCuentaAsociadoDAO = new CtaCasCuentaAsociadoDAO(getSessionHibernate(request));
		CtaCasCuentaAsociado cas = casCuentaAsociadoDAO.findByPreId(prestamoForm.getPreId());
		if(cas!=null){
		Set perList = cas.getCtaPrePrestamo().getCtaDexDescuentosExternoses();
		int addD = 0;
		for (Iterator iteratorD = perList.iterator(); iterator.hasNext();) {
			CtaDexDescuentosExternos descuentosExternos = (CtaDexDescuentosExternos) iteratorD.next();
			mapaD.put(System.currentTimeMillis() + addD, descuentosExternos);
			addD++;
		}}
		listaResponse = construirListaDescuentos(mapaD, request);
		try {
			String var = listaResponse;
			response.getWriter().write(var);
			response.getWriter().flush();
			//response.getWriter().close();
		} catch (IOException e) {
			e.printStackTrace();
			System.out.println("Problemas al cargar Descuentos Externos");
		}		

		//Cargando Notas
		//String listaResponse = "";
		//String listaErrores ="";
		//NotaGenericForm notaForm = (NotaGenericForm) form;
		HashMap<Long, String> mapaN = (HashMap<Long, String>)request.getSession().getAttribute("listaAnotaciones");
		if(mapaN == null){
			mapaN = new HashMap<Long, String>();
		}
		//CtaCasCuentaAsociadoDAO casCuentaAsociadoDAO = new CtaCasCuentaAsociadoDAO(getSessionHibernate(request));
		//CtaCasCuentaAsociado cas = casCuentaAsociadoDAO.findByPreId(notaForm.getPreId());
		if(cas!=null){
			CtaNotNotasDAO	notasDAO = new CtaNotNotasDAO(getSessionHibernate(request));
			List perList = notasDAO.findbyCuenta(cas.getCasCuenta());
			int addN = 0;
			for (Iterator iteratorN = perList.iterator(); iteratorN.hasNext();) {
				CtaNotNotas nota = (CtaNotNotas) iteratorN.next();
				mapaN.put(System.currentTimeMillis() + addN, nota.getNotNota());
				addN++;
			}
		}
		listaResponse = construirListaNotas(mapaN, request);
		try {
			String var = listaResponse;
			response.getWriter().write(var);
			response.getWriter().flush();
			response.getWriter().close();
		} catch (IOException e) {
			e.printStackTrace();
			System.out.println("Problemas al cargar Notas");
		}
		
		return null;
	}

	private String construirListaReferenciasPersonales(HashMap<Long, CtaRpeReferenciasPersonales> mapa,HttpServletRequest request){
		SecParParentescoDAO parentescoDAO = new SecParParentescoDAO(getSessionHibernate(request));
		String html = "<table class=\"tableone\" summary=\"\"><caption>"
				+ getResources(request).getMessage("lbl.rpeTbl.titulo")
				+ "</caption>";
		html = html
				+ "<thead><tr><th class=\"th1\" scope=\"col\">&nbsp;</th><th class=\"th1\" scope=\"col\">"
				+ getResources(request).getMessage("lbl.rpe.nombres")
				+ "</th><th class=\"th1\" scope=\"col\">"
				+ getResources(request).getMessage("lbl.rpe.apellidos")
				+ "</th><th class=\"th1\" scope=\"col\">"
				+ getResources(request).getMessage("lbl.rpe.parentesco")
				+ "</th></tr></thead><tbody><tr><td colspan=\"5\"><div class=\"innerb\"><table class=\"tabletwo\">";
		Iterator<Long> iterator = (mapa.keySet().iterator());
		long i;
		while (iterator.hasNext()) {
			i = iterator.next().longValue();
			CtaRpeReferenciasPersonales rf = (CtaRpeReferenciasPersonales) mapa.get(i);
			html = html
					+ "<tr><th class=\"td1\" scope=\"row\"><input type=\"checkbox\" name=\"posicionRpe\" class=\"posicionRpe\" value=\""
					+ i + "\"/></th>" + "<td class=\"td1\">"
					+ rf.getRpeNombres() + "</td><td class=\"td1\">"
					+ rf.getRpeApellidos() + "</td><td class=\"td1\">"
					+ parentescoDAO.findById(rf.getParId()).getParDescripcion()
					+ "</td></tr>";
		}
		html = html + "</table></div></td></tr></tbody></table>";
		return html;
	}
	
	private String construirListaReferenciasComerciales(HashMap<Long, CtaRcoReferenciasComerciales> mapa,HttpServletRequest request){
		String html = "<table class=\"tableone\" summary=\"\"><caption>"
				+ getResources(request).getMessage("lbl.rcoTbl.titulo")
				+ "</caption>";
		html = html
				+ "<thead><tr><th class=\"th1\" scope=\"col\">&nbsp;</th><th class=\"th1\" scope=\"col\">"
				+ getResources(request).getMessage("lbl.rco.nombreEmpresa")
				+ "</th><th class=\"th1\" scope=\"col\">"
				+ getResources(request).getMessage("lbl.rco.sucursal")
				+ "</th><th class=\"th1\" scope=\"col\">"
				+ getResources(request).getMessage("lbl.rco.monto")
				+ "</th></tr></thead><tbody><tr><td colspan=\"5\"><div class=\"innerb\"><table class=\"tabletwo\">";
		long i;
		Iterator<Long> iterator = mapa.keySet().iterator();

		while (iterator.hasNext()) {
			i = iterator.next().longValue();
			CtaRcoReferenciasComerciales rf = (CtaRcoReferenciasComerciales) mapa
					.get(i);
			html = html
					+ "<tr><th class=\"td1\" scope=\"row\"><input type=\"checkbox\" name=\"posicionRco\" class=\"posicionRco\" value=\""
					+ i + "\"/></th>" + "<td class=\"td1\">"
					+ rf.getRcoReferencia() + "</td><td class=\"td1\">"
					+ rf.getRcoSucursal() + "</td><td class=\"td1\">"
					+ new Double(rf.getRcoMonto()) + "</td></tr>";
		}
		html = html + "</table></div></td></tr></tbody></table>";
		return html;
	}
	
	private String construirListaFiadores(HashMap<Long, CtaFxpFiadorPrestamo> mapa,HttpServletRequest request){
		String html = "<table class=\"tableone\" summary=\"\"><caption>"
				+ getResources(request).getMessage("lbl.fxp.caption")
				+ "</caption>";
		html = html
				+ "<thead><tr><th class=\"th1\" scope=\"col\">&nbsp;</th><th class=\"th1\" scope=\"col\">"
				+ getResources(request).getMessage("lbl.fxp.Nombre")
				+ "</th><th class=\"th1\" scope=\"col\">"
				+ getResources(request).getMessage("lbl.fxp.salario")
				+ "</th><th class=\"th1\" scope=\"col\">"
				+ getResources(request).getMessage("lbl.fxp.tipoFiador")
				+ "</th></tr></thead><tbody><tr><td colspan=\"5\"><div class=\"innerb\"><table class=\"tabletwo\">";
		long i;
		Iterator<Long> iterator = mapa.keySet().iterator();

		while (iterator.hasNext()) {
			i = iterator.next().longValue();
			CtaFxpFiadorPrestamo fxp = mapa.get(i);
			html = html
					+ "<tr><th class=\"td1\" scope=\"row\"><input type=\"checkbox\" name=\"posicionFxp\" class=\"posicionFxp\" value=\""
					+ i + "\"/></th>" + "<td class=\"td1\">";
					if(fxp.getCtaAscAsociado() == null){//es externo
						html = html +  fxp.getCtaPxtPersonaExterna().getPxtNombres()+ ", " +fxp.getCtaPxtPersonaExterna().getPxtPrimerApellido() + "</td><td class=\"td1\">"
						+ fxp.getCtaPxtPersonaExterna().getPxtSalario() + "</td><td class=\"td1\">"
						+ getResources(request).getMessage("lbl.fxp.personaExterna")+ "</td></tr>";
					}else{//es asociado
						html = html +  fxp.getCtaAscAsociado().getSecPerPersona().getPerPrimerNombre()+ ", " +fxp.getCtaAscAsociado().getSecPerPersona().getPerPrimerApellido() + "</td><td class=\"td1\">"
						+ fxp.getCtaAscAsociado().getAscSalario() + "</td><td class=\"td1\">"
						+ getResources(request).getMessage("lbl.fxp.asociado")+ "</td></tr>";
					}
		}
		html = html + "</table></div></td></tr></tbody></table>";
		return html;
	}

	private String construirListaGarantias(HashMap<Long,CtaGarGarantia> mapa,HttpServletRequest request){
		String html = "<table class=\"tableone\" summary=\"\"><caption>"
				+ getResources(request).getMessage("lbl.garTbl.titulo")
				+ "</caption>";
		html = html
				+ "<thead><tr><th class=\"th1\" scope=\"col\">&nbsp;</th><th class=\"th1\" scope=\"col\">"
				+ getResources(request).getMessage("lbl.gar.nombreGarantia")
				+ "</th><th class=\"th1\" scope=\"col\">"
				+ getResources(request).getMessage("lbl.gar.valorGarantia")
				+ "</th><th class=\"th1\" scope=\"col\">"
				+ getResources(request).getMessage("lbl.gar.inspeccionadaGarantia")
				+ "</th></tr></thead><tbody><tr><td colspan=\"5\"><div class=\"innerb\"><table class=\"tabletwo\">";
		long i;
		Iterator<Long> iterator = mapa.keySet().iterator();

		while (iterator.hasNext()) {
			i = iterator.next().longValue();
			CtaGarGarantia gxp = mapa.get(i);
			html = html
					+ "<tr><th class=\"td1\" scope=\"row\"><input type=\"checkbox\" name=\"posicionGxp\" class=\"posicionGxp\" value=\""
					+ i + "\"/></th>" + "<td class=\"td1\">";
						html = html + gxp.getGarNombreInmueble() + "</td><td class=\"td1\">"
						+ gxp.getGarValor() + "</td><td class=\"td1\">";
						if(gxp.getGarInspeccion().equals("S")){
							html= html+"Si";
						}else{
							html= html+"No";
						}
					html = html+ "</td></tr>";
		}
		html = html + "</table></div></td></tr></tbody></table>";
		return html;
	}
	
	private String construirListaDescuentos(HashMap<Long, CtaDexDescuentosExternos> mapa,HttpServletRequest request){
		String html = "<table class=\"tableone\" summary=\"\"><caption>"
				+ getResources(request).getMessage("lbl.dexTbl.titulo")
				+ "</caption>";
		html = html
				+ "<thead><tr><th class=\"th1\" scope=\"col\">&nbsp;</th><th class=\"th1\" scope=\"col\">"
				+ getResources(request).getMessage("lbl.descuentosExternos.dexNombreDescuento")
				+ "</th><th class=\"th1\" scope=\"col\">"
				+ getResources(request).getMessage("lbl.descuentosExternos.dexMonto")
				+ "</th></tr></thead><tbody><tr><td colspan=\"5\"><div class=\"innerb\"><table class=\"tabletwo\">";
		long i;
		Iterator<Long> iterator = mapa.keySet().iterator();

		while (iterator.hasNext()) {
			i = iterator.next().longValue();
			CtaDexDescuentosExternos dex = mapa.get(i);
			html = html
					+ "<tr><th class=\"td1\" scope=\"row\"><input type=\"checkbox\" name=\"posicionDex\" class=\"posicionDex\" value=\""
					+ i + "\"/></th>" + "<td class=\"td1\">";
						html = html +  dex.getDexNombreDescuento() +"</td><td class=\"td1\">"
						+ dex.getDexMonto()+ "</td></tr>";
		}
		html = html + "</table></div></td></tr></tbody></table>";
		return html;
	}
	
	private String construirListaNotas(HashMap<Long, String> mapa,HttpServletRequest request){
		String html = "<table class=\"tableone\" summary=\"\"><caption>"
				+ getResources(request).getMessage("lbl.notPreTbl.titulo")
				+ "</caption>";
		html = html
				+ "<thead><tr><th class=\"th1\" scope=\"col\">&nbsp;</th><th class=\"th1\" scope=\"col\">"
				+ getResources(request).getMessage("lbl.pre.nota")
				+ "</th></tr></thead><tbody><tr><td colspan=\"2\"><div class=\"innerb\"><table class=\"tabletwo\">";
		long i;
		Iterator<Long> iterator = mapa.keySet().iterator();

		while (iterator.hasNext()) {
			i = iterator.next().longValue();
			String nota = (String) mapa.get(i);
			html = html
					+ "<tr><th class=\"td1\" scope=\"row\"><input type=\"checkbox\" name=\"posicionNota\" class=\"posicionNota\" value=\""
					+ i + "\"/></th>" + "<td class=\"td1\">"+ nota + "</td></tr>";
		}
		html = html + "</table></div></td></tr></tbody></table>";
		return html;
	}
	
	
////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////	
	//---- metodo que genera el html de la tabla del jmesa cuando el prestamo esta aprobado
	private String htmlAprobado(final TableFacade tableFacade, final HttpServletRequest request) {			
			tableFacade.setColumnProperties("ctaAscAsociado.ascCodigoAsociado", "ctaAscAsociado.secPerPersona.perPrimerNombre", "ctaPrePrestamo.ctaTprTipoPrestamo.ctaLprLineaPrestamo.lprNombre",
					"ctaPrePrestamo.preMontoSolicitado","ctaPrePrestamo.preLiquidoARecibir",
					"ctaPrePrestamo.ctaCbaCuentaBancaria.cbaId", "ctaAscAsociado.ascId");
			Table table = tableFacade.getTable();
			
			//---- Titulo de la tabla
			table.setCaptionKey("tbl.cas.caption.prestamo");
			
			Row row = table.getRow();
			Column nombreColumna = row.getColumn("ctaAscAsociado.ascCodigoAsociado");
			nombreColumna.setTitleKey("tbl.cas.codigoAsociado");
			
			nombreColumna = row.getColumn("ctaAscAsociado.secPerPersona.perPrimerNombre");
			nombreColumna.setTitleKey("tbl.cas.nombreAsociado");

			nombreColumna.getCellRenderer().setCellEditor(new CellEditor(){

				public Object getValue(Object item, String property, int rowcount) {
					Object value = new BasicCellEditor().getValue(item, property, rowcount);
					CtaCasCuentaAsociado ctaCasCuentaAsociado = (CtaCasCuentaAsociado)item;
					SecPerPersona persona = ctaCasCuentaAsociado.getCtaAscAsociado().getSecPerPersona();
					value = persona.getPerPrimerApellido();
					value = value + (isObjectNull(persona.getPerSegundoApellido())?"":(" "+persona.getPerSegundoApellido()));
					value = value  + ", " +persona.getPerPrimerNombre();
					value = value  + (isObjectNull(persona.getPerSegundoNombre())?"":(" "+persona.getPerSegundoNombre()));		
					return value.toString();	
				}
			});
			
			nombreColumna = row.getColumn("ctaPrePrestamo.ctaTprTipoPrestamo.ctaLprLineaPrestamo.lprNombre");
			nombreColumna.setTitleKey("tbl.cas.lineaPrestamo");
			
			nombreColumna = row.getColumn("ctaPrePrestamo.preMontoSolicitado");
			nombreColumna.setTitleKey("tbl.cas.montoSolicitado");
			
			nombreColumna = row.getColumn("ctaPrePrestamo.preLiquidoARecibir");
			nombreColumna.setTitleKey("tbl.cas.liquidoARecibir");
			nombreColumna.getCellRenderer().setCellEditor(new CellEditor(){
				public Object getValue(Object item, String property, int rowcount) {
	                CtaCasCuentaAsociado cuentaAsociado = (CtaCasCuentaAsociado)item;
	                ChequePrestamoAction chequePrestamoAction = new ChequePrestamoAction();
	                Double montoDesembolso = chequePrestamoAction.montoDesembolso(cuentaAsociado.getCasCuenta(),request);
	                
	                DecimalFormat df = new DecimalFormat("0.00");
	                return df.format(montoDesembolso);
				}
			});
			
			nombreColumna = row.getColumn("ctaPrePrestamo.ctaCbaCuentaBancaria.cbaId");
			nombreColumna.setTitleKey("tbl.cas.formaDesembolso");
			nombreColumna.getCellRenderer().setCellEditor(new CellEditor(){
				
				public Object getValue(Object item, String property, int rowcount) {
					Object value ="n/a";
					CtaCasCuentaAsociado cuentaAsoc = (CtaCasCuentaAsociado)item;
					CtaPrePrestamo prestamo = cuentaAsoc.getCtaPrePrestamo();
					CtaCbaCuentaBancaria ctaBancaria = prestamo.getCtaCbaCuentaBancaria();
					if(ctaBancaria!=null) value=ctaBancaria.getCtrBanBanco().getBanNombre()+" "+ctaBancaria.getCbaCuenta();
					return value;
				}
			});
				
			nombreColumna = row.getColumn("ctaAscAsociado.ascId");
			nombreColumna.setTitleKey("tbl.cas.acciones");
			nombreColumna.getCellRenderer().setCellEditor(new CellEditor(){
				
			public Object getValue(Object item, String property, int rowcount) {
				Object value ="";
				String toReturn;
				
				CtaCasCuentaAsociado cuentaAsoc = (CtaCasCuentaAsociado)item;
				CtaPrePrestamo prestamo = cuentaAsoc.getCtaPrePrestamo();

				HtmlBuilder html = new HtmlBuilder();
				value =getResources(request).getMessage("cmd.cas.aplicarDescuentos");
				String link = tableFacade.getWebContext().getContextPath();
				link += "/cuentaCorriente/aplicarDescuentos.do?accion=lista&casCuenta="+cuentaAsoc.getCasCuenta();
				html.a().href().quote().append(link).quote().append("class=\"linkDescuentos\"").title(value.toString()).close();
				//html.append(value);
				html.aEnd();
				toReturn = html.toString() + " | ";
				
				html = new HtmlBuilder();
				value =getResources(request).getMessage("cmd.cas.linkDesembolso");
				link = tableFacade.getWebContext().getContextPath();
				link += "/cuentaCorriente/preCuentaBancaria.do?accion=lista&ascId="+cuentaAsoc.getCtaAscAsociado().getAscId()+"&preId="+prestamo.getPreId()+"&estado=15";
				html.a().href().quote().append(link).quote().append("class=\"linkDesembolso\"").title(value.toString()).close();
				//html.append(value);
				html.aEnd();				
				toReturn = toReturn + html.toString() + " | ";
				
				/*html = new HtmlBuilder();
				value =getResources(request).getMessage("cmd.cas.linkAceptar");
				link = tableFacade.getWebContext().getContextPath();
				link += "/cuentaCorriente/prestamo.do?accion=enviarADesembolso&preId="+prestamo.getPreId()+"&estado=15";
				html.a().href().quote().append(link).quote().append("class=\"linkActivar\"").title(value.toString()).close();
				//html.append(value);
				html.aEnd();				
				toReturn = toReturn + html.toString() + " | ";*/
				
				html = new HtmlBuilder();
				value =getResources(request).getMessage("cmd.cas.linkEliminar");
				link = tableFacade.getWebContext().getContextPath();
				link += "/cuentaCorriente/prestamo.do?accion=eliminarPrestamo&preId="+prestamo.getPreId();
				html.a().id("deleteButtonId").append("class=\"linkInActivar\"").title(value.toString()).onclick("handlerDeleteButton('"+prestamo.getPreId()+"');").style("cursor: pointer;").close();
				//html.append(value);
				html.aEnd();				
				toReturn = toReturn + html.toString();
		
				return toReturn;		
				
			}
			});
			
		return tableFacade.render();
	}

	public ActionForward enviarADesembolso(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		PrestamoForm prestamoForm = (PrestamoForm) form;
		CtaPrePrestamoDAO prestamoDAO = new CtaPrePrestamoDAO(getSessionHibernate(request));
		CtaCasCuentaAsociadoDAO cuentaAsociadoDAO = new CtaCasCuentaAsociadoDAO(getSessionHibernate(request));
		CtrEstEstadoDAO estadoDAO = new CtrEstEstadoDAO(getSessionHibernate(request));
		
		CtaPrePrestamo ctaPrePrestamo = prestamoDAO.findById(prestamoForm.getPreId());
		
		if(ctaPrePrestamo.getPreLiquidoARecibir()>0 && ctaPrePrestamo.getCtaCbaCuentaBancaria()==null){
			mensajes("errors.pre.nodesembolso",request);
			return buscarPrestamos(mapping, prestamoForm, request, response);
		}else{
			if(ctaPrePrestamo.getPreLiquidoARecibir() < 0){
				mensajes("errors.pre.nodesembolsoln",request);
				return buscarPrestamos(mapping, prestamoForm, request, response);				
			}else{
				//Cambiamos al estado 24: espera desembolso
				CtaCasCuentaAsociado cuentaAsociado = cuentaAsociadoDAO.findByPreId(prestamoForm.getPreId());
				CtrEstEstado estado = estadoDAO.findById(24);//buscamos el estado de espera desembolso
				Transaction tx = cuentaAsociadoDAO.getSession().beginTransaction();
				try{
					cuentaAsociado.setCtrEstEstado(estado);// cambiamos al estado de espera desembolso
					cuentaAsociadoDAO.merge(cuentaAsociado);
					tx.commit();				
				}catch (Exception e) {
					tx.rollback();
					e.printStackTrace();
				}finally{
					cuentaAsociadoDAO .getSession().flush();
					cuentaAsociadoDAO .getSession().clear();
					
				}
				
				prestamoForm.setEstado(24);
				return buscarPrestamos(mapping, prestamoForm, request, response);
			}
		}		
	}

	public ActionForward eliminarPrestamo(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		PrestamoForm prestamoForm = (PrestamoForm) form;
		CtaPrePrestamoDAO prestamoDAO = new CtaPrePrestamoDAO(getSessionHibernate(request));		
		String preId = prestamoForm.getPreId();
		Transaction tx = prestamoDAO.getSession().beginTransaction();
		try{
			//Elimino los descuentos asociados al prestamo
			CtaDexDescuentosExternosDAO descuentosDAO = new CtaDexDescuentosExternosDAO(getSessionHibernate(request));
			List<CtaDexDescuentosExternos> descuentos = descuentosDAO.findByProperty("ctaPrePrestamo.preId", preId);
			Iterator<CtaDexDescuentosExternos> d = descuentos.iterator();
			while(d.hasNext()){
				CtaDexDescuentosExternos descuento = (CtaDexDescuentosExternos) d.next();
				descuentosDAO.delete(descuento);
			}
			//Elimino los fiadores asociados al prestamo
			CtaFxpFiadorPrestamoDAO fiadoresDAO = new CtaFxpFiadorPrestamoDAO(getSessionHibernate(request));
			List<CtaFxpFiadorPrestamo> fiadores = fiadoresDAO.findByProperty("ctaPrePrestamo.preId", preId);
			Iterator<CtaFxpFiadorPrestamo> f = fiadores.iterator();
			while(f.hasNext()){
				CtaFxpFiadorPrestamo fiador = (CtaFxpFiadorPrestamo) f.next();
				fiadoresDAO.delete(fiador);
			}
			//Elimino las garantias asociadas al prestamo
			CtaGarGarantiaDAO garantiasDAO = new CtaGarGarantiaDAO(getSessionHibernate(request));
			List<CtaGarGarantia> garantias = garantiasDAO.findByProperty("ctaPrePrestamo.preId", preId);
			Iterator<CtaGarGarantia> g = garantias.iterator();
			while(g.hasNext()){
				CtaGarGarantia garantia = (CtaGarGarantia) g.next();
				garantiasDAO.delete(garantia);
			}
			//Elimino las referencias comerciales asociadas al prestamo
			CtaRcoReferenciasComercialesDAO referenciasComDAO = new CtaRcoReferenciasComercialesDAO(getSessionHibernate(request));
			List<CtaRcoReferenciasComerciales> referenciasCom = referenciasComDAO.findByProperty("ctaPrePrestamo.preId", preId);
			Iterator<CtaRcoReferenciasComerciales> rc = referenciasCom.iterator();
			while(rc.hasNext()){
				CtaRcoReferenciasComerciales referenciaCom = (CtaRcoReferenciasComerciales) rc.next();
				referenciasComDAO.delete(referenciaCom);
			}
			//Elimino las referencias personales asociadas al prestamo
			CtaRpeReferenciasPersonalesDAO referenciasPerDAO = new CtaRpeReferenciasPersonalesDAO(getSessionHibernate(request));
			List<CtaRpeReferenciasPersonales> referenciasPer = referenciasPerDAO.findByProperty("ctaPrePrestamo.preId", preId);
			Iterator<CtaRpeReferenciasPersonales> rp = referenciasPer.iterator();
			while(rp.hasNext()){
				CtaRpeReferenciasPersonales referenciaPer = (CtaRpeReferenciasPersonales) rp.next();
				referenciasPerDAO.delete(referenciaPer);
			}
			//Elimino las notas asociadas a la cuenta del prestamo
			CtaCasCuentaAsociadoDAO cuentaAsociadoDAO = new CtaCasCuentaAsociadoDAO(getSessionHibernate(request));
			CtaCasCuentaAsociado cuenta = cuentaAsociadoDAO.findByPreId(preId);
			
			CtaNotNotasDAO notasDAO = new CtaNotNotasDAO(getSessionHibernate(request));
			List<CtaNotNotas> notas = notasDAO.findbyCuenta(cuenta.getCasCuenta());
			Iterator<CtaNotNotas> n = notas.iterator();
			while(n.hasNext()){
				CtaNotNotas nota = (CtaNotNotas) n.next();
				notasDAO.delete(nota);
			}
			
			//Elimino de la cuenta del asociado			
			cuentaAsociadoDAO.delete(cuenta);
			
			//Elimino el prestamo
			CtaPrePrestamo ctaPrePrestamo = prestamoDAO.findById(preId);
			prestamoDAO.delete(ctaPrePrestamo);			
			tx.commit();
			prestamoForm.setPreId(null);
			mensajes("lbl.pre.eliminado",request);
		}catch (Exception e) {
			tx.rollback();
			mensajes("errors.pre.noeliminado",request);
		}		
		return buscarPrestamos(mapping, prestamoForm, request, response);
	
	}
	
	public void mensajes(String msg, HttpServletRequest request){
		ActionErrors errors = new ActionErrors();
        errors.add(ActionMessages.GLOBAL_MESSAGE,new ActionMessage(msg));
        saveMessages(request, errors);
	}
	
	protected Map getKeyMethodMap() {
		HashMap<String, String> map = new HashMap<String, String>();
		map.put("cmd.pre.lista","lista");
		map.put("cmd.pre.listaAux","listaAux");
		map.put("cmd.pre.cargarListaCuentas", "cargarListaCuentas");
		map.put("cmd.pre.buscarPrestamos", "buscarPrestamos");
		map.put("cmd.pre.cargarListaAsociados", "cargarListaAsociados");
		map.put("cmd.pre.forwardToNuevaSolicitud","forwardToNuevaSolicitud");
		map.put("cmd.pre.forwardToFiadores","forwardToFiadores");
		map.put("cmd.pre.listaNuevaSolicitud","listaNuevaSolicitud");
		map.put("cmd.pre.forwardToVerificacion","forwardToVerificacion");
		map.put("cmd.pre.loadPrestamoExistente", "loadPrestamoExistente");
		map.put("cmd.pre.cargarSolicitud","cargarSolicitud");
		map.put("cmd.pre.refinanciar", "refinanciar");
		map.put("cmd.pre.verificacionRefinanciamiento", "verificacionRefinanciamiento");
		map.put("cmd.prestamo.cancelar", "cancelar");
		map.put("cmd.prestamo.finalizar", "regresarToPrestamoList");
		map.put("cmd.prestamo.verRco", "forwardToRco");
		map.put("cmd.prestamo.verRpe", "forwardToRpe");
		map.put("cmd.prestamo.verDex", "forwardToDxp");
		map.put("cmd.prestamo.verGxp", "forwardToGxp");
		map.put("cmd.prestamo.verFxp", "forwardToFxp");
		map.put("cmd.prestamo.verNxp", "forwardToNxp");
		map.put("cmd.prestamo.aprobar", "aprobarPrestamo");
		map.put("cmd.prestamo.cancelar", "regresarToPrestamoList");
		map.put("cmd.prestamo.forwardToCalculadora", "forwardToCalculadora");
		map.put("cmd.prestamo.calcularCuota", "calcularCuota");
		map.put("cmd.prestamo.regresar", "regresarToPrestamoList");
		map.put("cmd.prestamo.denegar", "denegarPrestamo");
		map.put("cmd.pre.chequePrestamo", "chequePrestamo");
		map.put("cmd.pre.generarComprobante", "generarComprobante");
		map.put("cmd.pre.finalizar", "regresarToPrestamoList");
		map.put("cmd.pre.cargarTipos", "cargarTipos");
		map.put("cmd.pre.generarDescuentos", "generarDescuentos");
		map.put("cmd.pre.iniSolRef", "inicializarSolicitudRefinanciamiento");
		map.put("cmd.pre.enviarADesembolso","enviarADesembolso");
		map.put("cmd.pre.eliminarPrestamo","eliminarPrestamo");
		return map;
	} 
}