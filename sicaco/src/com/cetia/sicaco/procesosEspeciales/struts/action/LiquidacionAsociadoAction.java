/* * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package com.cetia.sicaco.procesosEspeciales.struts.action;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.sql.Connection;
import java.sql.DriverManager;
import java.text.DecimalFormat;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import net.sf.jasperreports.engine.JRExporterParameter;
import net.sf.jasperreports.engine.JasperCompileManager;
import net.sf.jasperreports.engine.JasperFillManager;
import net.sf.jasperreports.engine.JasperPrint;
import net.sf.jasperreports.engine.JasperReport;
import net.sf.jasperreports.engine.design.JasperDesign;
import net.sf.jasperreports.engine.export.JRPdfExporter;
import net.sf.jasperreports.engine.xml.JRXmlLoader;

import org.apache.struts.action.ActionErrors;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;
import org.apache.struts.action.ActionMessage;
import org.apache.struts.action.ActionMessages;
import org.hibernate.Transaction;
import org.jmesa.facade.TableFacade;
import org.jmesa.facade.TableFacadeImpl;
import org.jmesa.limit.ExportType;
import org.jmesa.limit.Limit;
import org.jmesa.view.component.Column;
import org.jmesa.view.component.Row;
import org.jmesa.view.component.Table;
import org.jmesa.view.editor.BasicCellEditor;
import org.jmesa.view.editor.CellEditor;
import org.jmesa.view.html.HtmlBuilder;

import com.cetia.sicaco.cuentaCorriente.struts.action.CuentaAhorroAction;
import com.cetia.sicaco.hibernate.CtaAscAsociado;
import com.cetia.sicaco.hibernate.CtaAscAsociadoDAO;
import com.cetia.sicaco.hibernate.CtaCahCuentaAhorro;
import com.cetia.sicaco.hibernate.CtaCahCuentaAhorroDAO;
import com.cetia.sicaco.hibernate.CtaCasCuentaAsociado;
import com.cetia.sicaco.hibernate.CtaCasCuentaAsociadoDAO;
import com.cetia.sicaco.hibernate.CtaInaIngresosxasociado;
import com.cetia.sicaco.hibernate.CtaInaIngresosxasociadoDAO;
import com.cetia.sicaco.hibernate.CtaLasLiquidarAsociado;
import com.cetia.sicaco.hibernate.CtaLasLiquidarAsociadoDAO;
import com.cetia.sicaco.hibernate.CtaLasLiquidarAsociadoId;
import com.cetia.sicaco.hibernate.CtaMxaMovimientoAhorro;
import com.cetia.sicaco.hibernate.CtaMxaMovimientoAhorroDAO;
import com.cetia.sicaco.hibernate.CtaMxpMovimientoPrestamo;
import com.cetia.sicaco.hibernate.CtaMxpMovimientoPrestamoDAO;
import com.cetia.sicaco.hibernate.CtaMxsMovimientoSeguros;
import com.cetia.sicaco.hibernate.CtaMxsMovimientoSegurosDAO;
import com.cetia.sicaco.hibernate.CtaPrePrestamo;
import com.cetia.sicaco.hibernate.CtaPrePrestamoDAO;
import com.cetia.sicaco.hibernate.CtaSegSeguros;
import com.cetia.sicaco.hibernate.CtaSegSegurosDAO;
import com.cetia.sicaco.hibernate.CtaTtrTipoTransaccion;
import com.cetia.sicaco.hibernate.CtaTxaTransaccionxcuentaAsociado;
import com.cetia.sicaco.hibernate.CtaTxaTransaccionxcuentaAsociadoDAO;
import com.cetia.sicaco.hibernate.CtrEstEstadoDAO;
import com.cetia.sicaco.hibernate.CtrParParametros;
import com.cetia.sicaco.hibernate.CtrParParametrosDAO;
import com.cetia.sicaco.hibernate.HibernateSessionFactory;
import com.cetia.sicaco.hibernate.PartidaContable;
import com.cetia.sicaco.hibernate.SecPerPersona;
import com.cetia.sicaco.hibernate.SecPerPersonaDAO;
import com.cetia.sicaco.procesosEspeciales.struts.form.LiquidacionAsociadoForm;
import com.cetia.sicaco.struts.Constantes;
import com.cetia.sicaco.struts.DMLAction;
import com.cetia.sicaco.struts.PartidaAutomatica;
import com.mad.utilidades.ElapsedTime;
import com.mad.utilidades.Format;
import com.mad.utilidades.IntereseYMora;

/** 
 * MyEclipse Struts
 * Creation date: 12-20-2008
 * 
 * XDoclet definition:
 * @struts.action path="/liquidacionAsociado" name="liquidacionAsociadoForm" parameter="accion" scope="request"
 * @struts.action-forward name="lista" path="pagina-lista.procesosEspeciales.liquidacionAsociados"
 */


public class LiquidacionAsociadoAction extends DMLAction {
	
	private static final String reporteLiquidado= "Liquidacion_Saldos";
	private static final String rutaReporteLiquidado = "/listaReportes/liquidacion/";
	private static final String ASCID = "ascId";
	public static final String TABLA_ID = "ctaAscAsociado";
	
	public ActionForward lista(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		LiquidacionAsociadoForm liquidacionAsociadoForm = (LiquidacionAsociadoForm) form;
 		CtaAscAsociadoDAO asociadoDAO = new CtaAscAsociadoDAO(getSessionHibernate(request));
		List lst = asociadoDAO.findAllByEstado(liquidacionAsociadoForm.getUsuarioConectado().getMax(), 0);//para buscar solo los asociados activos pues los inactivos
		CtaCahCuentaAhorroDAO cAhorroDAO = new CtaCahCuentaAhorroDAO(getSessionHibernate(request));
		// Estas son mis pruebas para  la lista de ahorros que posee el asociado
		//List lstPrueba = cAhorroDAO.findListByLiquidacion("200811193521");
		
		//no se pueden liquidar,
		TableFacade tableFacade = new TableFacadeImpl(TABLA_ID, request);
		tableFacade.setItems(lst);//lstPrueba
		//---- Genera los tipos de formas con que se podran exportar los datos
		tableFacade.setExportTypes(response, ExportType.CSV, ExportType.JEXCEL);
		tableFacade.setStateAttr("restore");
		Limit limit = tableFacade.getLimit();
		if (limit.isExported()) {
        	//---- exporta la tabla
        //    export(tableFacade);
            return null; 
        } else {
        	String html = html(tableFacade,request);/*htmlPrueba(tableFacade, request);*/
            request.setAttribute(Constantes.LISTA_KEY, html);
        }
        //----- Variables de configuracion
		request.setAttribute("form", form);
		request.setAttribute(Constantes.ACCION_KEY, "/liquidacionAsociado");
		return mapping.findForward("lista");
	}

	private String html(final TableFacade tableFacade, final HttpServletRequest request) {
		tableFacade.setColumnProperties("ascCodigoAsociado","secPerPersona.perPrimerNombre","estId","secPerPersona.perPrimerApellido");
		Table table = tableFacade.getTable();
		
		//---- Titulo de la tabla
		table.setCaptionKey("tbl.ascAsociado.caption");
		
		Row row = table.getRow();
		Column nombreColumna = row.getColumn("ascCodigoAsociado");
		nombreColumna.setTitleKey("tbl.ascAsociado.ascCodigo");
		
		nombreColumna.getCellRenderer().setCellEditor(new CellEditor(){

			public Object getValue(Object item, String property, int rowcount) {
				Object value = new BasicCellEditor().getValue(item, property, rowcount);
				CtaAscAsociado asociado = (CtaAscAsociado)item;
				HtmlBuilder html = new HtmlBuilder();
				value = asociado.getAscCodigoAsociado();
				//---- Generar link para entrar a edicion
				String link = tableFacade.getWebContext().getContextPath();
				link += "/procesosEspeciales/liquidacionAsociado.do?accion=cargarDatos&ascId="+asociado.getAscId();
				html.a().href().quote().append(link).quote().close();
				html.append(value);
				html.aEnd();				
				return html.toString();	
			}
		});
		
		nombreColumna = row.getColumn("estId");
		nombreColumna.setTitleKey("tbl.ascAsociado.ascEstado");
		
		nombreColumna.getCellRenderer().setCellEditor(new CellEditor(){

			public Object getValue(Object item, String property, int rowcount) {
				Object value = new BasicCellEditor().getValue(item, property, rowcount);
				CtaAscAsociado asociado = (CtaAscAsociado)item;
				CtrEstEstadoDAO estadoDAO = new CtrEstEstadoDAO(getSessionHibernate(request));
				value = estadoDAO.findById(asociado.getEstId()).getEstNombre().toString();
				return value;
			}
		});
		
		nombreColumna = row.getColumn("secPerPersona.perPrimerNombre");
		nombreColumna.setTitleKey("tbl.ascAsociado.ascNombre");
		//----- Implementamos la edicion de asociado
		nombreColumna.getCellRenderer().setCellEditor(new CellEditor(){

			public Object getValue(Object item, String property, int rowcount) {
				Object value = new BasicCellEditor().getValue(item, property, rowcount);
				CtaAscAsociado asociado = (CtaAscAsociado)item;
				SecPerPersona persona = asociado.getSecPerPersona();
				value = persona.getPerPrimerApellido();
				value = value + (isObjectNull(persona.getPerSegundoApellido())?"":(" "+persona.getPerSegundoApellido()));
				value = value  + ", " +persona.getPerPrimerNombre();
				value = value  + (isObjectNull(persona.getPerSegundoNombre())?"":(" "+persona.getPerSegundoNombre()));		
				return value.toString();	
			}
		});
		
		nombreColumna = row.getColumn("secPerPersona.perPrimerApellido");
		nombreColumna.setTitleKey("tbl.ascAsociado.accion");
		//----- Implementamos la edicion de asociado
		nombreColumna.getCellRenderer().setCellEditor(new CellEditor(){

			public Object getValue(Object item, String property, int rowcount) {
				Object value = new BasicCellEditor().getValue(item, property, rowcount);
				CtaAscAsociado asociado = (CtaAscAsociado)item;
				HtmlBuilder html = new HtmlBuilder();
				value = "Proyectar Liquidacion";
				//---- Generar link para entrar a edicion
				String link = tableFacade.getWebContext().getContextPath();
				link += "/procesosEspeciales/liquidacionAsociado.do?accion=cargarDatosProyeccion&ascId="+asociado.getAscId();
				html.a().href().quote().append(link).quote().append("class=\"linkProyeccion\"").title(value.toString()).close();
				//html.append(value);
				html.aEnd();				
				return html.toString();		
			}
		});
		return tableFacade.render();
	}
	
	public ActionForward buscar(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		LiquidacionAsociadoForm liquidacionAsociadoForm = (LiquidacionAsociadoForm) form;
 		CtaAscAsociadoDAO asociadoDAO = new CtaAscAsociadoDAO(getSessionHibernate(request));
		List lst = asociadoDAO.findByNameUserYEstado( liquidacionAsociadoForm.getCtaAscAsociadoH(), liquidacionAsociadoForm.getUsuarioConectado().getMax(),0);
		TableFacade tableFacade = new TableFacadeImpl(TABLA_ID, request);
		tableFacade.setItems(lst);
		//---- Genera los tipos de formas con que se podran exportar los datos
		tableFacade.setExportTypes(response, ExportType.CSV, ExportType.JEXCEL);
		tableFacade.setStateAttr("restore");
		Limit limit = tableFacade.getLimit();
		if (limit.isExported()) {
        	//---- exporta la tabla
        //    export(tableFacade);
            return null; 
        } else {
        	String html = html(tableFacade, request);
            request.setAttribute(Constantes.LISTA_KEY, html);
        }
        //----- Variables de configuracion
		request.setAttribute("form",  liquidacionAsociadoForm);
		request.setAttribute(Constantes.ACCION_KEY, "/liquidacionAsociado");
		return mapping.findForward("lista");
	}
	
	public ActionErrors validacionLiquidacion(ActionForm form,HttpServletRequest request){
		ActionErrors errors = new ActionErrors();
		LiquidacionAsociadoForm liquidacionForm = (LiquidacionAsociadoForm)form;
		Integer[] posicionA = liquidacionForm.getSelectedItemsA();
		Double[] saldosA = liquidacionForm.getSaldosA();
		Double[] liquidarA = liquidacionForm.getLiquidaA();
		Integer[] posicionP = liquidacionForm.getSelectedItemsP();
		Double[] saldosP = liquidacionForm.getSaldosP();
		Double[] liquidarP = liquidacionForm.getLiquidaP();
		Integer[] posicionS = liquidacionForm.getSelectedItemsS();
		Double[] saldosS = liquidacionForm.getSaldosS();
		Double[] liquidarS = liquidacionForm.getLiquidaS();
		
		//Validando los saldos a liquidar de los Ahorros
		if(posicionA != null)
			for (int i = 0; i < posicionA.length; i++) {
				if(saldosA[posicionA[i]]<liquidarA[posicionA[i]])
					errors.add(ActionMessages.GLOBAL_MESSAGE,new ActionMessage("errors.saldosASuperiores"));
			}
		
		
		if(posicionP != null)
			for (int j = 0; j < posicionP.length; j++) {
				if(saldosP[posicionP[j]]<liquidarP[posicionP[j]])
						errors.add(ActionMessages.GLOBAL_MESSAGE,new ActionMessage("errors.saldosPSuperiores"));
			}
		
		if(posicionS != null)
			for (int k = 0; k < posicionS.length; k++) {
				if(saldosS[posicionS[k]]<liquidarS[posicionS[k]])
					errors.add(ActionMessages.GLOBAL_MESSAGE,new ActionMessage("errors.saldosSSuperiores"));
			}
		
		return errors;
	}
	
	public ActionForward liquidar(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		LiquidacionAsociadoForm liquidacionAsociadoForm = (LiquidacionAsociadoForm) form;
 		/* 1.	Cargar la listas con el total de ahorros y otra con el total de prestamos
 		 * 2.	Sumar el total a favor del asociado
 		 * 3.	Calcular los intereses a la fecha + los que ya tenia cada prestamo
 		 * 4.	Abonar cada una de las cuentas de prestamos en el orden especificado
 		 * 5.	No setear los campos en la tabla prestamo, sino hasta que se genere el reporte¿?
 		 * 6.	Generar reporte y en metodo de generacion actualizar el movimiento y los de la tabla de prestamo a 0.0
 		 * 7.	ACTUALIZAR SALDOS
 		 * */
		CtrEstEstadoDAO estadoDAO = new CtrEstEstadoDAO(getSessionHibernate(request));
		CtaAscAsociadoDAO ascAsociadoDAO = new CtaAscAsociadoDAO(getSessionHibernate(request));
		CtaCasCuentaAsociadoDAO cAsociadoDAO = new CtaCasCuentaAsociadoDAO(getSessionHibernate(request));
		CtaCahCuentaAhorroDAO ahorroDAO = new CtaCahCuentaAhorroDAO(getSessionHibernate(request));
		CtaMxpMovimientoPrestamoDAO movPresDAO = new CtaMxpMovimientoPrestamoDAO(getSessionHibernate(request));
		CtaTxaTransaccionxcuentaAsociadoDAO txaDAO = new CtaTxaTransaccionxcuentaAsociadoDAO(getSessionHibernate(request));
		CtaInaIngresosxasociadoDAO ingresosxasociadoDAO = new CtaInaIngresosxasociadoDAO(getSessionHibernate(request));
		CtaTxaTransaccionxcuentaAsociadoDAO transaccionxcuentaAsociadoDAO = new CtaTxaTransaccionxcuentaAsociadoDAO(getSessionHibernate(request));
		CtaMxaMovimientoAhorroDAO movimientoAhorroDAO = new CtaMxaMovimientoAhorroDAO(getSessionHibernate(request));
		DecimalFormat df = new DecimalFormat("0.00");
		Transaction tx = cAsociadoDAO.getSession().beginTransaction();
		
		List<CtaAscAsociado> aLiquidar = new ArrayList<CtaAscAsociado>();
		aLiquidar.add(ascAsociadoDAO.findById(liquidacionAsociadoForm.getAscId()));//buscamos al asociado papa
		
		/*List<CtaAscAsociado> dependientes = ascAsociadoDAO.findDependientesPorAsociado(liquidacionAsociadoForm.getAscId(), 1);//buscamos los dependientes
		if(dependientes != null && !dependientes.isEmpty()){//si tiene dependientes
			aLiquidar.addAll(dependientes);
		}*/
		Iterator<CtaAscAsociado> iteradorLiquidados = aLiquidar.iterator();
 		
		try{
			
			ActionErrors errors = validacionLiquidacion(liquidacionAsociadoForm, request);
			 if(!errors.isEmpty()){
				 //hay errores
				 saveMessages(request, errors);
				 return cargarDatos(mapping, liquidacionAsociadoForm, request, response);
			 }
			 
			 
 			while(iteradorLiquidados.hasNext()){
 				CtaAscAsociado liquidando = iteradorLiquidados.next();
 				Double totalAFavor = new Double(0.0);
 				Double[] saldosA = liquidacionAsociadoForm.getSaldosA();
 				Integer[] posicionA = liquidacionAsociadoForm.getSelectedItemsA();
 				Double[] liquidarA = liquidacionAsociadoForm.getLiquidaA();
 				String[] idsA = liquidacionAsociadoForm.getIdA();
 				String userConect = liquidacionAsociadoForm.getUsuarioConectado().getNombreUsuario();
 				Double saldoALiquidarAhorro = 0.0;
 				PartidaAutomatica partidaAutomatica =  new PartidaAutomatica();
 				//Long comprobante = txaDAO.nextComprobante();
 				Long comprobante = null;
 				
 				int bandera;
 				double capInt=0.00;
 				/***AHORROS  -> total a favor, realizacion de movimientos de cierre y cierre de cuentas de ahorro ***/
 				if(saldosA!= null){

 	 				for (int i = 0; i < saldosA.length; i++) {
 	 					bandera = 0;
 	 					saldoALiquidarAhorro = 0.0;
 	 					if(posicionA != null)
 			 					for (int j = 0; j < posicionA.length; j++) {
 			 						if(posicionA != null)
 				 						if(posicionA[j]==i){
 				 							saldoALiquidarAhorro = liquidarA[i];
 				 							bandera = 1;
 				 						}
 								}
 	 					if(bandera!=1) saldoALiquidarAhorro = saldosA[i];
 						totalAFavor += saldoALiquidarAhorro;
 						
 						//realizacion de movimientos en cuentas de ahorro y en transacciones.
 						CtaCasCuentaAsociado cta = cAsociadoDAO.findbyCahId(idsA[i]);
 						CtaCahCuentaAhorro ahorro = cta.getCtaCahCuentaAhorro();
 						
 						CtaTxaTransaccionxcuentaAsociado trx;
 						CtaMxaMovimientoAhorro mxa;
 						if(ahorro.getCtaTahTipoAhorro()!=null){
 							//movimiento de capitalizacion de interes
 							if(saldosA[i]-ahorro.getCahSaldoActual()>0){
 								trx = crearTransaccion(cta, 16, comprobante,
 											saldosA[i]-ahorro.getCahSaldoActual(),userConect);
 								transaccionxcuentaAsociadoDAO.save(trx);
 								mxa = crearMovimientoPorAhorro(ahorro, trx, 0.00, ahorro.getCahSaldoActual()+(saldosA[i]-ahorro.getCahSaldoActual()),
 											saldosA[i]-ahorro.getCahSaldoActual());
 								movimientoAhorroDAO.save(mxa);
 								//partida por Capitalizacion de Intereses
 								partidaAutomatica.crearPartidaAutomatica("1;2;"+ahorro.getCtaTahTipoAhorro().getTahId()+";16;1"+";-1", new Double(df.format(saldosA[i]-ahorro.getCahSaldoActual())), userConect, 1, null, null, null,request);
 								capInt+=saldosA[i]-ahorro.getCahSaldoActual();
 							}
 		 				}
 						//movimiento por cierre de cuenta
 						//FIXME validacion cuando posicionA sea null
 						//trx = crearTransaccion(cta,4, comprobante, saldoALiquidarAhorro,	userConect);
 						trx = crearTransaccion(cta,47, comprobante, saldoALiquidarAhorro,	userConect);//Cambiamos la transaccion a Cargo por Liquidacion de Asociado(47)
 	 					transaccionxcuentaAsociadoDAO.save(trx);
 	 					mxa = crearMovimientoPorAhorro(ahorro, trx, 0.00, 0.00/*saldosA[i]*/, saldoALiquidarAhorro);
 	 					movimientoAhorroDAO.save(mxa);
 	 					
 	 					//cerrando para inactivacion de las cuentas.
 	 					cta.setCasFechaCierre(new Date());
 	 					cta.setCtrEstEstado(estadoDAO.findById(10));
 	 		 			cAsociadoDAO.merge(cta);
 	 		 			if(ahorro.getCtaTahTipoAhorro()==null){//si la cuenta es de aportacion
 	 		 				partidaAutomatica.crearPartidaAutomatica("1;1;0;47;0"+";-1",new Double(df.format(saldoALiquidarAhorro)),userConect, 1, null, null, null,request);
 	 		 			}else{
 	 		 				partidaAutomatica.crearPartidaAutomatica("1;2;"+ahorro.getCtaTahTipoAhorro().getTahId()+";47;0"+";-1", new Double(df.format(saldoALiquidarAhorro)), userConect, 1, null, null, null,request);
 	 		 			} 				
 					}
 	 				
 				}
 				/***PRESTAMOS SIN GARANTIA***/
 				Double[] saldosP = liquidacionAsociadoForm.getSaldosP();
 				Integer[] posicionP = liquidacionAsociadoForm.getSelectedItemsP();
 				Double[] liquidarP = liquidacionAsociadoForm.getLiquidaP();
 				
 				//seleccionamos los prestamos sin garantias
 				List listaPrestamos = cAsociadoDAO.findPrestamoByEstadoAsocGarantiaYesNo(liquidando .getAscId(),13,1);
 				Iterator<CtaCasCuentaAsociado> iteradorP = listaPrestamos.listIterator();
 				IntereseYMora interesYMora = new IntereseYMora();
 				
 				//while prestamos
 				
 				int j=0;
 				Double totalPrestamo=0.0;
 				while(iteradorP.hasNext()){
 					CtaCasCuentaAsociado cuAsoc = iteradorP.next(); 
 					CtaPrePrestamo prestamo = cuAsoc.getCtaPrePrestamo();
 					totalPrestamo=0.0;
 					
 					bandera = 0;
 					if(posicionP != null)
		 					for (int k = 0; k < posicionP.length; k++) {
		 						if(posicionP != null){
		 							if(posicionP[k]==j){
		 	 							totalPrestamo = liquidarP[j];
		 	 							bandera = 1;
		 	 						}
		 						}
		 						
							}
 					if(bandera!=1) totalPrestamo = saldosP[j];
 					j++;
					
					if(totalPrestamo>0 && totalAFavor >= 0.01){
						CtaMxpMovimientoPrestamo movimiento = movPresDAO.findUltimoMovimiento(prestamo.getPreId());
	 					if(movimiento == null){
	 						movimiento = new CtaMxpMovimientoPrestamo();
	 					}
	 					interesYMora = interesYMora.actualizaInteres(movimiento, prestamo, cuAsoc, new Date(),request);
	 					totalAFavor = abonarPrestamos(totalAFavor, totalPrestamo,cuAsoc,comprobante
	 							,interesYMora,userConect,movimiento,request);
					}
 					if(totalAFavor<0.01) break;
 				}
 				
 				if(totalAFavor>0){
 					/***SEGUROS***/
 	 				Double[] saldosS = liquidacionAsociadoForm.getSaldosS();
 	 				Integer[] posicionS = liquidacionAsociadoForm.getSelectedItemsS();
 	 				Double[] liquidarS = liquidacionAsociadoForm.getLiquidaS();
 	 				int k=0;
 	 				
 					List listaCasSeguros = cAsociadoDAO.findByAscAndTipoCuenta2(liquidando.getAscId(), "D");
 					Iterator<CtaCasCuentaAsociado> iteradorS = listaCasSeguros.listIterator();
 					while(iteradorS.hasNext()){
 						CtaCasCuentaAsociado cuAsociado = iteradorS.next();
 						CtaSegSeguros seguro = cuAsociado.getCtaSegSeguros();
 						//Double totalAnual = seguro.getSegCuota()*12;
 						Double totalDebe = 0.0;/*totalAnual - seguro.getSegSaldoActual();*/
 						
 						
 						bandera = 0;
 	 					if(posicionS != null)
 			 					for (int m = 0; m < posicionS.length; m++) {
 			 						if(posicionS != null){
 			 							if(posicionS[m]==k){
 			 								totalDebe = liquidarS[k];
 			 	 							bandera = 1;
 			 	 						}
 			 						}
 			 						
 								}
 	 					if(bandera!=1) totalDebe = saldosS[k];
 	 					k++;
 	 					
 	 					if(totalDebe>0 && seguro.getSegSaldoActual()>0){
 							totalAFavor= abonarSeguros(totalAFavor,totalDebe, cuAsociado,comprobante,userConect,request);
 						}
 						if(totalAFavor<=0) break;
 					}
 				}
 				
 				/***PRESTAMOS CON GARANTIA***/
 				
 				//seleccionamos los prestamos con garantias
 				List listaPrestamosG = cAsociadoDAO.findPrestamoByEstadoAsocGarantiaYesNo(liquidando .getAscId(),13,2);
 				Iterator<CtaCasCuentaAsociado> iteradorPG = listaPrestamosG.listIterator();
 				
 				totalPrestamo=0.0;
 				while(iteradorPG.hasNext()){
 					CtaCasCuentaAsociado cuAsoc = iteradorPG.next();//aqui tenia iteradorP asumo que fue error de dedo 
 					CtaPrePrestamo prestamo = cuAsoc.getCtaPrePrestamo();
 					totalPrestamo=0.0;
 					
 					bandera = 0;
 					if(posicionP != null)
		 					for (int k = 0; k < posicionP.length; k++) {
		 						if(posicionP != null){
		 							if(posicionP[k]==j){
		 	 							totalPrestamo = liquidarP[j];
		 	 							bandera = 1;
		 	 						}
		 						}
		 						
							}
 					if(bandera!=1) totalPrestamo = saldosP[j];
 					j++;
					
					if(totalPrestamo>0){
						CtaMxpMovimientoPrestamo movimiento = movPresDAO.findUltimoMovimiento(prestamo.getPreId());
	 					if(movimiento == null){
	 						movimiento = new CtaMxpMovimientoPrestamo();
	 					}
	 					interesYMora = interesYMora.actualizaInteres(movimiento, prestamo, cuAsoc, new Date(),request);
	 					totalAFavor = abonarPrestamos(totalAFavor, totalPrestamo,cuAsoc,comprobante
	 							,interesYMora,userConect,movimiento,request);
					}
 					if(totalAFavor<=0) break;
 				}
 				
 				//verificamos si aun quedan fondos a favor del asociado, se le emitira un cheque
 				//pero se le indicara que sea emitido cuando el usuario lo desee, los fondos sobrantes
 				//se abonaran a la cuenta de ahorro descuentos
 				//total en ahorros, fondos
				ahorroDAO.updateByLiquidacion(liquidando.getAscId(), 0);
 				if(totalAFavor > 0){
 					mensajes("errors.liquidacionFinalizadaConSaldoAFavor",request);
 					//ttrid=4 cargo por cierre de cuenta
 					String nombreSocio = "  "+liquidando.getAscCodigo() + "; "+liquidando.getSecPerPersona().getPerPrimerNombre()+
 						" "+liquidando.getSecPerPersona().getPerSegundoNombre()+ " "+ liquidando.getSecPerPersona().getPerPrimerApellido()+
 						" "+liquidando.getSecPerPersona().getPerSegundoApellido();
 					partidaAutomatica.crearPartidaAutomatica("7", totalAFavor, userConect, 1, null, null, null,nombreSocio,request);
 					liquidando.setAscSaldoAFavor(totalAFavor);
 				}else{
 					mensajes("errors.liquidacionFinalizadaConSaldoEnContra",request);
 				}
 				
 				
 				/***INACTIVANDO AL ASOCIADO***/
 				SecPerPersonaDAO personaDAO = new SecPerPersonaDAO(getSessionHibernate(request));
 				liquidando.setEstId(6);
 				liquidando.setCtrEstEstado(estadoDAO.findById(6));
 				SecPerPersona persona = personaDAO.findById(liquidando.getSecPerPersona().getPerId());
 				
 				liquidando.setAscRetiroCoope(new Date());
 				persona.setPerEstado("I");
 				persona.setAudUsuarioCreacion(userConect);
 				persona.setAudUsuarioModificacion(userConect);
 				personaDAO.merge(persona);

 				ascAsociadoDAO.merge(liquidando);
 				//modificamos el ingreso por asociado
 				CtaInaIngresosxasociado ultimoIngreso = ingresosxasociadoDAO.findLastIngreso(liquidacionAsociadoForm.getAscId());
 				if(ultimoIngreso!=null){
 					ultimoIngreso.setInaFechaSalida(new Date());
 	 				ultimoIngreso.getCtaNotNotas().setNotNota("Retiro de la cooperativa por liquidacion de asociado");
 	 				ingresosxasociadoDAO.merge(ultimoIngreso);	
 				}
 				
 			}
 			tx.commit();
		}catch(Exception e){
			tx.rollback();
			e.printStackTrace();
		}finally{
			cAsociadoDAO.getSession().flush();
			cAsociadoDAO.getSession().clear();
		}
		return lista(mapping, form, request, response);
	}
	
	private CtaTxaTransaccionxcuentaAsociado crearTransaccion(CtaCasCuentaAsociado cuentaAsoc,Integer ttrId,Long comprobante,Double monto, String usuario){
		CtaTxaTransaccionxcuentaAsociado transaccionxcuentaAsociado = new CtaTxaTransaccionxcuentaAsociado();
		transaccionxcuentaAsociado.setCtaCasCuentaAsociado(cuentaAsoc);
		transaccionxcuentaAsociado.getCtaTtrTipoTransaccion().setTtrId(ttrId);
		transaccionxcuentaAsociado.setTxaFecha(new Date());
		transaccionxcuentaAsociado.setTxaEstado("E");
		transaccionxcuentaAsociado.setTxaComprobante(comprobante);
		transaccionxcuentaAsociado.setTxaMonto(monto);
		
		transaccionxcuentaAsociado.setAudFechaCreacion(transaccionxcuentaAsociado.getTxaFecha());
		transaccionxcuentaAsociado.setAudFechaModificacion( transaccionxcuentaAsociado.getTxaFecha());
		transaccionxcuentaAsociado.setAudUsuarioCreacion(usuario);
		transaccionxcuentaAsociado.setAudUsuarioModificacion(usuario);
		return transaccionxcuentaAsociado;
	}
	
	private CtaMxaMovimientoAhorro crearMovimientoPorAhorro(CtaCahCuentaAhorro cuentaAhorro,CtaTxaTransaccionxcuentaAsociado transaccion,Double interes,Double saldo,Double monto){
		CtaMxaMovimientoAhorro mxa = new CtaMxaMovimientoAhorro();
		mxa.setCtaCahCuentaAhorro(cuentaAhorro);
		mxa.setCtaTxaTransaccionxcuentaAsociado(transaccion);
		mxa.setMxaFecha(new Date());
		mxa.setMxaInteresTran(interes);
		mxa.setMxaSaldo(saldo);
		mxa.setMxaMonto(monto);
		
		mxa.setAudFechaCreacion(transaccion.getAudFechaCreacion());
		mxa.setAudFechaModificacion(transaccion.getAudFechaModificacion());
		mxa.setAudUsuarioCreacion(transaccion.getAudUsuarioCreacion());
		mxa.setAudUsuarioModificacion(transaccion.getAudUsuarioModificacion());
		return mxa;
	}
	
	public Double abonarSeguros(Double totalAFavor,Double totalSeguros, CtaCasCuentaAsociado cuentaAsoc
			,Long comprobante,String usuario,HttpServletRequest request){
		CtaTxaTransaccionxcuentaAsociadoDAO txaDAO = new CtaTxaTransaccionxcuentaAsociadoDAO(getSessionHibernate(request));
		CtrEstEstadoDAO estadoDAO = new CtrEstEstadoDAO(getSessionHibernate(request));
		CtaMxsMovimientoSegurosDAO mxsDAO = new CtaMxsMovimientoSegurosDAO(getSessionHibernate(request));
		CtaCasCuentaAsociadoDAO cuentaAsociadoDAO = new CtaCasCuentaAsociadoDAO(getSessionHibernate(request));
		CtaSegSegurosDAO seguroDAO = new CtaSegSegurosDAO(getSessionHibernate(request));
		Date fechaTrans = new Date();
		
		CtaTxaTransaccionxcuentaAsociado txa = new CtaTxaTransaccionxcuentaAsociado();
		CtaMxsMovimientoSeguros mxs = new CtaMxsMovimientoSeguros();
		CtaMxsMovimientoSeguros mxsU = new CtaMxsMovimientoSeguros();
		CtaTtrTipoTransaccion tipoTransac = new CtaTtrTipoTransaccion();
		mxsU = mxsDAO.findUltimoMovimiento(cuentaAsoc.getCtaSegSeguros().getSegId());
		
		txa.setCtaCasCuentaAsociado(cuentaAsoc);
		tipoTransac.setTtrId(35);
		txa.setCtaTtrTipoTransaccion(tipoTransac);
		txa.setTxaComprobante(comprobante);
		txa.setTxaFecha(fechaTrans);
		txa.setTxaEstado("E");
		Double totalAbono = totalAFavor - totalSeguros; 
		if(totalAbono>0){
			txa.setTxaMonto(totalSeguros);
			Double montoS = cuentaAsoc.getCtaSegSeguros().getSegSaldoActual();
			if(montoS > totalSeguros){
				cuentaAsoc.getCtaSegSeguros().setSegSaldoActual(montoS - totalSeguros);
			}else{//es porque son iguales
				cuentaAsoc.getCtaSegSeguros().setSegSaldoActual(0.0);
			}
			// Asumiendo que siempre se le cerrara la cuenta de seguros
			cuentaAsoc.setCtrEstEstado(estadoDAO.findById(12));//inactivamos el la cuenta del seguro
			cuentaAsoc.setCasFechaCierre(new Date());
			mxs.setMxsMonto(totalSeguros);
			mxs.setMxsSaldo(cuentaAsoc.getCtaSegSeguros().getSegSaldoActual()/*(mxsU==null?totalSeguros:mxsU.getMxsSaldo())+totalSeguros*/);
		}else{
			txa.setTxaMonto(totalSeguros-totalAbono);
			mxs.setMxsMonto(totalSeguros-totalAbono);
			cuentaAsoc.getCtaSegSeguros().setSegSaldoActual(totalAbono + totalSeguros);
			mxs.setMxsSaldo(cuentaAsoc.getCtaSegSeguros().getSegSaldoActual()/*totalSeguros+totalAbono+(mxsU==null?0.0:mxsU.getMxsSaldo())*/);
		}
		txa.setAudFechaCreacion(fechaTrans);
		txa.setAudFechaModificacion(fechaTrans);
		txa.setAudUsuarioCreacion(usuario);
		txa.setAudUsuarioModificacion(usuario);
		
		txaDAO.save2(txa);
		
		mxs.setCtaSegSeguros(cuentaAsoc.getCtaSegSeguros());
		mxs.setCtaTxaTransaccionxcuentaAsociado(txa);
		mxs.setMxsFecha(fechaTrans);
		mxs.setAudFechaCreacion(fechaTrans);
		mxs.setAudFechaModificacion(fechaTrans);
		mxs.setAudUsuarioCreacion(usuario);
		mxs.setAudUsuarioModificacion(usuario);
		
		mxsDAO.save(mxs);
		seguroDAO.merge(cuentaAsoc.getCtaSegSeguros());
		cuentaAsociadoDAO.merge(cuentaAsoc);
		//creamos el detalle de la partida diaria
		PartidaAutomatica partidaAutomatica =  new PartidaAutomatica();
		partidaAutomatica.crearPartidaAutomatica("1;4;"+cuentaAsoc.getCtaSegSeguros().getCtaTisTipoSeguro().getTisId()+";35;0"+";-1", txa.getTxaMonto()/*totalAbono*/, usuario, 1, null, null, null,request);
		return totalAbono;
	}
	//agregar como parametro el interes corriente (calculado desde el ultimo movimiento a la fecha) 
	public Double abonarPrestamos(Double totalAhorros, Double totalPrestamo, CtaCasCuentaAsociado cuentaAsoc
			,Long comprobante,IntereseYMora interesYMora,String usuario, CtaMxpMovimientoPrestamo ultMov
			,HttpServletRequest request){
		CtrEstEstadoDAO estadoDAO = new CtrEstEstadoDAO(getSessionHibernate(request));
		CtaCasCuentaAsociadoDAO cuentaAsociadoDAO = new CtaCasCuentaAsociadoDAO(getSessionHibernate(request));
		CtaTxaTransaccionxcuentaAsociadoDAO txaDAO = new CtaTxaTransaccionxcuentaAsociadoDAO(getSessionHibernate(request));
		CtaMxpMovimientoPrestamoDAO mxpDAO = new CtaMxpMovimientoPrestamoDAO(getSessionHibernate(request));
		CtaPrePrestamoDAO prestamoDAO = new CtaPrePrestamoDAO(getSessionHibernate(request));
		
		CtaTxaTransaccionxcuentaAsociado txa = new CtaTxaTransaccionxcuentaAsociado();
		CtaMxpMovimientoPrestamo mxp = new CtaMxpMovimientoPrestamo();
		CtaTtrTipoTransaccion tipoTransac = new CtaTtrTipoTransaccion();
		
		Date fechaTrans = new Date();
		Double pendiente = interesYMora.getPendiente();
		Double interesCorriente = interesYMora.getAcumulado();
		//Double totalPrestamo = pendiente + interesCorriente;
		Double monto=0.00,abonoInteres=0.00;
				
		/***movimiento de abono y actualizacion de abono a cuenta de prestamo***/
		txa.setCtaCasCuentaAsociado(cuentaAsoc);
		tipoTransac.setTtrId(36);
		txa.setCtaTtrTipoTransaccion(tipoTransac);
		txa.setTxaComprobante(comprobante);
		txa.setTxaFecha(fechaTrans);
		if((totalAhorros - totalPrestamo)>0)	txa.setTxaMonto(totalPrestamo);
		else			txa.setTxaMonto(totalAhorros);
		
		txa.setAudFechaCreacion(fechaTrans);
		txa.setAudFechaModificacion(fechaTrans);
		txa.setAudUsuarioCreacion(usuario);
		txa.setAudUsuarioModificacion(usuario);
		txaDAO.save2(txa);
		
		
		mxp.setCtaPrePrestamo(cuentaAsoc.getCtaPrePrestamo());
		mxp.setCtaTxaTransaccionxcuentaAsociado(txa);
		mxp.setMxpFecha(fechaTrans);
		/*total ahorros = ahorros totales del asociado
		 * 
		 */
		/****Comenzamos abonando los intereses pendientes***/
		if(pendiente<totalPrestamo){
			totalAhorros -= pendiente;//para la siguiente verificacion
			totalPrestamo -= pendiente;
		}else{
			totalAhorros -= totalPrestamo;//para la siguiente verificacion
			pendiente -= totalPrestamo;
		}
		cuentaAsoc.getCtaPrePrestamo().setPreMoraMov(0.0);/*cero pues no hay mora para un socio activo solo para liquidados*/
		if(totalAhorros>=0){
			if(pendiente > 0){
				abonoInteres += (pendiente<totalPrestamo)?pendiente:totalPrestamo;;
				mxp.setMxpInteresPendiente(abonoInteres);
				cuentaAsoc.getCtaPrePrestamo().setPrePendMov((pendiente<totalPrestamo)?0.0:pendiente);
			}else{
				mxp.setMxpInteresPendiente(0.0);
				cuentaAsoc.getCtaPrePrestamo().setPrePendMov(0.0);
			}
			/****Abonamos los intereses acumulados***/
			if(totalPrestamo > 0){
				if(interesCorriente<totalPrestamo){
					totalAhorros -= interesCorriente;//para la siguiente verificacion
					totalPrestamo -= interesCorriente;
				}else{
					totalAhorros -= totalPrestamo;//para la siguiente verificacion
					interesCorriente -= totalPrestamo;
				}
				if(totalAhorros>=0){
					abonoInteres += (interesCorriente<totalPrestamo)?interesCorriente:totalPrestamo;
					
					if(interesCorriente > 0) mxp.setMxpInteresAcumulado(interesCorriente);
					else mxp.setMxpInteresAcumulado(0.0);
					if(totalPrestamo > 0){
						double aFavor= totalAhorros; 
						totalAhorros -= totalPrestamo;//FIXME VALIDAR QUE EL MONTO INGRESADO EN LOS CUADROS DE TEXTO SEA MENOR QUE EL SALDO 
														//TOTAL DE DEUDA, IDEM EN AHORROS
						
						if(totalAhorros>=0){/*desde esta marca hacia abajo en el codigo se modifico mxp.SetMxpSaldo*/
							mxp.setMxpSaldoActual(ultMov.getMxpSaldoActual()==null?totalPrestamo:ultMov.getMxpSaldoActual()+totalPrestamo);
							mxp.setMxpSaldo(ultMov.getMxpSaldo()-totalPrestamo);
							//como el prestamo se cancelo en su totalidad lo colocamos como pagado
							monto = cuentaAsoc.getCtaPrePrestamo().getPreSaldoActualT();
							if(monto > totalPrestamo){
								cuentaAsoc.getCtaPrePrestamo().setPreSaldoActualT(monto-totalPrestamo);
							}else{//es porque son iguales
								cuentaAsoc.getCtaPrePrestamo().setPreSaldoActualT(0.0);
								cuentaAsoc.setCasFechaCierre(new Date());
								cuentaAsoc.setCtrEstEstado(estadoDAO.findById(17));
							}
							
						}else{
							mxp.setMxpSaldoActual((ultMov.getMxpSaldoActual()==null?
										cuentaAsoc.getCtaPrePrestamo().getPreSaldoActualT()+totalAhorros:
										//ultMov.getMxpSaldoActual())+(cuentaAsoc.getCtaPrePrestamo().getPreSaldoActualT()+totalAhorros));
											ultMov.getMxpSaldoActual()+aFavor));
							mxp.setMxpSaldo(ultMov.getMxpSaldo()-aFavor);
							//monto = mxp.getMxpSaldoActual()+(cuentaAsoc.getCtaPrePrestamo().getPreSaldoActualT()+totalAhorros);
							monto = aFavor; 
							
							cuentaAsoc.getCtaPrePrestamo().setPreSaldoActualT(totalAhorros*(-1));
						}
					}else{
						cuentaAsoc.getCtaPrePrestamo().setPreSaldoActualT(0.0);
						cuentaAsoc.setCasFechaCierre(new Date());
						cuentaAsoc.setCtrEstEstado(estadoDAO.findById(17));
					}
				}else{
					mxp.setMxpInteresAcumulado((interesCorriente<totalPrestamo)?(interesCorriente + totalAhorros):(totalPrestamo + totalAhorros));
					abonoInteres += mxp.getMxpInteresAcumulado();
					mxp.setMxpSaldoActual(ultMov.getMxpSaldoActual()==null?0:ultMov.getMxpSaldoActual());
					mxp.setMxpSaldo(ultMov.getMxpSaldo());
					cuentaAsoc.getCtaPrePrestamo().setPrePendMov(cuentaAsoc.getCtaPrePrestamo().getPrePendMov()+ (totalAhorros*(-1)));
				}
			}
		}else{//Solo pagamos el interes pendiente
			abonoInteres += (pendiente<totalPrestamo)?(pendiente+totalAhorros):(totalPrestamo+totalAhorros);//(pendiente+totalAhorros);
			mxp.setMxpInteresPendiente(abonoInteres);
			mxp.setMxpInteresAcumulado(0.0);
			mxp.setMxpSaldoActual(ultMov.getMxpSaldoActual()==null?0:ultMov.getMxpSaldoActual());
			mxp.setMxpSaldo(ultMov.getMxpSaldo());
			cuentaAsoc.getCtaPrePrestamo().setPrePendMov(totalAhorros*(-1) + interesCorriente);
		}
		cuentaAsoc.getCtaPrePrestamo().setPreInteresAcumulado(0.0);
		
		mxp.setAudFechaCreacion(fechaTrans);
		mxp.setAudFechaModificacion(fechaTrans);
		mxp.setAudUsuarioCreacion(usuario);
		mxp.setAudUsuarioModificacion(usuario);
		
		mxpDAO.save(mxp);
		//prestamoDAO.merge(cuentaAsoc.getCtaPrePrestamo());
		//creamos el detalle automatico para los intereses
		PartidaAutomatica partidaAutomatica =  new PartidaAutomatica();
		if(abonoInteres > 0)
			partidaAutomatica.crearPartidaAutomatica("1;3;"+(cuentaAsoc.getCtaPrePrestamo().getCtaTprTipoPrestamo()==null?"-1":cuentaAsoc.getCtaPrePrestamo().getCtaTprTipoPrestamo().getCtaLprLineaPrestamo().getLprId())+";36;1"+";-1", abonoInteres, usuario, 1, null, null, null,request);
		//creamos el detalle automatico para el saldo
		if(monto > 0)
			partidaAutomatica.crearPartidaAutomatica("1;3;"+(cuentaAsoc.getCtaPrePrestamo().getCtaTprTipoPrestamo()==null?"-1":cuentaAsoc.getCtaPrePrestamo().getCtaTprTipoPrestamo().getCtaLprLineaPrestamo().getLprId())+";36;0"+";-1", monto, usuario, 1, null, null, null,request);
		cuentaAsociadoDAO.merge(cuentaAsoc);
		prestamoDAO.merge(cuentaAsoc.getCtaPrePrestamo());
		return totalAhorros;
	}
	
	public ActionForward cargarDatosProyeccion(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		CtaAscAsociadoDAO asociadoDAO = new CtaAscAsociadoDAO(getSessionHibernate(request));
		LiquidacionAsociadoForm liquidacionAsociadoForm = (LiquidacionAsociadoForm) form;
		request.setAttribute("asociado", asociadoDAO.findById(liquidacionAsociadoForm.getAscId()));
		request.setAttribute(Constantes.ACCION_KEY, "/liquidacionAsociado");
		return mapping.findForward("forwardToProyeccionLiquidacion");
	}
	
	public ActionForward cargarDatos(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		CtaAscAsociadoDAO asociadoDAO = new CtaAscAsociadoDAO(getSessionHibernate(request));
		LiquidacionAsociadoForm liquidacionAsociadoForm = (LiquidacionAsociadoForm) form;
		request.setAttribute("asociado", asociadoDAO.findById(liquidacionAsociadoForm.getAscId()));
		request.setAttribute(Constantes.ACCION_KEY, "/liquidacionAsociado");
		return mapping.findForward("forwardToLiquidacion");
	}
	
	public ActionForward regresar(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		return lista(mapping, form, request, response);
	}
	
	public void mensajes(String msg, HttpServletRequest request){
		ActionErrors errors = new ActionErrors();
        errors.add(ActionMessages.GLOBAL_MESSAGE,new ActionMessage(msg));
        saveMessages(request, errors);
	}
	
	public ActionForward cargarDependientes(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		CtaAscAsociadoDAO asociadoDAO = new CtaAscAsociadoDAO(getSessionHibernate(request));
		LiquidacionAsociadoForm liquidacionAsociadoForm = (LiquidacionAsociadoForm) form;
		List<CtaAscAsociado> listaDependientes = asociadoDAO.findDependientesPorAsociado(liquidacionAsociadoForm.getAscId(), 0);//buscamos los dependientes activos del asociados
		try{
			response.setCharacterEncoding("UTF-8");
			response.getWriter().write(construirListaDependientes(listaDependientes, request));
			response.getWriter().flush();
			response.getWriter().close();
		} catch (IOException e) {
			e.printStackTrace();
		}
		return null;
	}
	
	private String construirListaDependientes(List<CtaAscAsociado> dependientes,HttpServletRequest request){
		String html = "";
		if(dependientes.isEmpty()){
			html = "<td><span style=\"font-size: 10px;color: red;font-style: italic;\">"
			+ "El asociado no posee dependientes</span></td>";
		}else{
			 html = "<div class=\"scrollPane\"><table class=\"tableone\" summary=\"\"><caption></caption>"
					+ "<thead><tr><th class=\"th1\" scope=\"col\">Codigo</th><th class=\"th1\" scope=\"col\">"
					+ "Nombre Completo</th></tr></thead><tbody><tr><td colspan=\"2\"><div class=\"innerb\"><table class=\"tabletwo\">";
			Iterator<CtaAscAsociado> iterator = dependientes.iterator();
			while (iterator.hasNext()) {
				CtaAscAsociado dep = iterator.next();
				html = html
						+ "<tr><td class=\"td1\"><a href=\"javascript:void(0)\" onClick=\"ajaxCallNormal('"+request.getContextPath()+"/procesosEspeciales/liquidacionAsociado.do','accion=cargarCuentasYPrestamos&ascId="+dep.getAscId()+"','resps')\">"
						+dep.getAscCodigoAsociado()+"</a></td><td class=\"td1\">"+dep.getSecPerPersona().toString()+"</td></tr>";
			}
				html = html + "</table></div></td></tr></tbody></table></div>";
		}
		return html;
	}
	
	public ActionForward cargarCuentasYPrestamos(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		String resp ="";
		CtaAscAsociadoDAO asociadoDAO = new CtaAscAsociadoDAO(getSessionHibernate(request));
		CtaCasCuentaAsociadoDAO cuentaAsociadoDAO = new CtaCasCuentaAsociadoDAO(getSessionHibernate(request));
		CtaCahCuentaAhorroDAO ahorroDAO = new CtaCahCuentaAhorroDAO(getSessionHibernate(request));
		LiquidacionAsociadoForm liquidacionAsociadoForm = (LiquidacionAsociadoForm) form;
		CtaAscAsociado asoc = asociadoDAO.findById(liquidacionAsociadoForm.getAscId());
		List<CtaCahCuentaAhorro> listaAhorros = ahorroDAO.findListByLiquidacion(liquidacionAsociadoForm.getAscId());
		List<CtaCasCuentaAsociado> listaPrestamos = cuentaAsociadoDAO.findPrestamoByEstadoAsocGarantiaYesNo(liquidacionAsociadoForm.getAscId(),13,0);  
		List<CtaCasCuentaAsociado> listaSeguros =  cuentaAsociadoDAO.findByAscAndTipoCuenta2(liquidacionAsociadoForm.getAscId(), "D");
		
		String enunciado = "CUENTAS DE AHORRO, PR&Eacute;STAMOS Y SEGUROS CORRESPONDIENTES A "+asoc.getSecPerPersona().toString();
		enunciado.toUpperCase();
		resp+= "<p class=\"msg_head\">"+ enunciado +"</p><div class=\"msg_body\">"; 
		resp += construirListaAhorros(listaAhorros,request);
		resp += construirListaPrestamos(listaPrestamos,request);
		resp += construirListaSeguros(listaSeguros);
		try{
			response.setCharacterEncoding("UTF-8");
			response.getWriter().write(resp);
			response.getWriter().flush();
			response.getWriter().close();
		} catch (IOException e) {
			e.printStackTrace();
		}
		return null;
	}
	
	private String construirListaAhorros(List<CtaCahCuentaAhorro> ahorros,HttpServletRequest request){
		DecimalFormat df = new DecimalFormat("0.00");
		String html = "";
		if(ahorros.isEmpty()){
			html = "<td><br><br><span style=\"font-size: 10px;color: red;font-style: italic;\">"
			+ "El asociado no posee al menos una cuenta de Ahorros</span></td>";
		}else{
			 html = "<div>" +
			 		//"<table border=\"1px\" cellpadding=\"2\" cellspacing=\"1\">" +
			 "<table align=\"center\"style=\"font-family: 'Lucida Sans Unicode', 'Lucida Grande', Sans-Serif;font-size: 13px;margin-bottom: 20px;margin-top:20px;margin-left: auto;margin-right: auto;text-align: left;border-collapse: collapse;padding: 20px 20px 20px 20px;\" id=\"hor-zebra\">"+
			 		"<caption style=\"font-size: 13px;color: blue;\">CUENTAS DE AHORRO Y APORTACI&Oacute;N</caption>"
					+ "<thead>" +
							"<tr>" +
								//"<th>&nbsp;</th>" +
								"<th>C&oacute;digo</th>" +
								"<th>Tipo</th>" +
								"<th>Saldo</th>" +
								"<th>Interes</th>" +
								//"<th>Valor a Liquidar</th>" +
							"</tr>" +
					  "</thead>" +
					  "<tbody>"/* +
					  "<tr><td colspan=\"3\"><div class=\"innerb\"><table class=\"tabletwo\">"*/;
			Iterator<CtaCahCuentaAhorro> iterator = ahorros.iterator();
			int correl=0;
			//CuentaAhorroForm ahorroForm = new CuentaAhorroForm();
			CuentaAhorroAction ahorroAction = new CuentaAhorroAction();
			Double nuevoInteres;
			while (iterator.hasNext()) {
				nuevoInteres = new Double(0);
				CtaCahCuentaAhorro ahorro = iterator.next();
				if(ahorro.getCtaTahTipoAhorro() != null){
					//AHORROS
					//ahorroForm.setCtaCahCuentaAhorroH(ahorro);
					nuevoInteres += ahorro.getCahInteresAcumulado();
					nuevoInteres += ahorroAction.calculoInteresTransaccion(ahorro.getCahId(),new Date(),request); 
					//le sumaremos al interes actual, un interes de gracia que ofrece la 
					//cooperativa para lograr saldar las deudas del asociado
					CtrParParametrosDAO parametroDAO = new CtrParParametrosDAO(getSessionHibernate(request));
					CtrParParametros parametroAnio = parametroDAO.findById("ANHO_CALENDARIO");
					Double interes = ahorro.getCtaTahTipoAhorro().getCtaTinTasaInteres().getTinTasa();
					interes = interes/100;
					Double interesGracia = new Double(0);
					Double saldoActual = ahorro.getCahSaldoActual();
					interesGracia = (saldoActual*interes)*parametroDAO.findById("DIAS_ADIC_INTERE_LIQUIDACION").getParValorNumber()/parametroAnio.getParValorNumber();
					Format formato = new Format();
					
					//nuevoInteres += interesGracia;
					//sumamos interes mas saldo actual
					Double aFavor = new Double(df.format(nuevoInteres + ahorro.getCahSaldoActual()));
										
					html = html
					+"<tr>" +
						//"<td align=\"center\"> <input type=\"checkbox\" value=\""+correl+"\" name=\"selectedItemsA\" /> " +
							"<input type=\"hidden\" value=\""+ahorro.getCahId()+"\" name=\"idA\" />"+
						"</td>"+
						"<td>"+ahorro.getCahId()+"</td>" +
						"<td>"+ahorro.getCtaTahTipoAhorro().getTahNombre()+"</td>" +
						"<td>"+df.format(ahorro.getCahSaldoActual())+
							"<input type=\"hidden\" value=\""+aFavor+"\" name=\"saldosA\" />"+
						"</td>" +
						"<td>"+formato.formatDineroSinSimbolo(nuevoInteres)+"</td>" +
						//"<td align=\"center\"> <input type=\"text\" size=\"12\" maxlength=\"12\" name=\"liquidaA\" styleId=\"liquidarA\" /></td>" +
					"</tr>";
				}else{
					//APORTACIONES 
					html = html
					+"<tr>" +
						//"<td align=\"center\"> <input type=\"checkbox\" value=\""+correl+"\" name=\"selectedItemsA\" /> " +
								"<input type=\"hidden\" value=\""+ahorro.getCahId()+"\" name=\"idA\" />"+
						"</td>"+
						"<td>"+ahorro.getCahId()+"</td>" +
						"<td>APORTACION</td>" +
						"<td>"+df.format(ahorro.getCahSaldoActual())+
							"<input type=\"hidden\" value=\""+df.format(ahorro.getCahSaldoActual())+"\" name=\"saldosA\" />"+
						"</td>" +
						"<td>0.0</td>" +
						//"<td align=\"center\"> <input type=\"text\" size=\"12\" style=\"numeric\" maxlength=\"12\" name=\"liquidaA\" styleId=\"liquidarA\" /></td>" +
					"</tr>";
				}
				correl++;
					
			}
				html = html + /*"</table></div></td></tr>*/"</tbody></table></div><br>";
		}
		return html;
	}
	
	private String construirListaSeguros(List<CtaCasCuentaAsociado> seguros){
		DecimalFormat df = new DecimalFormat("0.00");
		String html = "";
		if(seguros.isEmpty()){
			html = "<td><br><br><span style=\"font-size: 10px;color: red;font-style: italic;\">"
			+ "El asociado no posee al menos una cuenta de Seguros</span></td>";
		}else{
			 html = "<div>" +
			 		//"<table border=\"1px\" cellpadding=\"2\" cellspacing=\"1\">" +
			 "<table align=\"center\"style=\"font-family: 'Lucida Sans Unicode', 'Lucida Grande', Sans-Serif;font-size: 13px;margin-bottom: 20px;margin-top:20px;margin-left: auto;margin-right: auto;text-align: left;border-collapse: collapse;padding: 20px 20px 20px 20px;\" id=\"hor-zebra\">"+
			 		"<caption style=\"font-size: 13px;color: blue;\">CUENTAS DE SEGUROS</caption>"
					+ "<thead>" +
							"<tr>" +
								"<th>&nbsp;</th>" +
								"<th>C&oacute;digo</th>" +
								"<th>Tipo</th>" +
								"<th>Saldo</th>" +
								"<th>Valor a Liquidar</th>" +
							"</tr>" +
					  "</thead>" +
					  "<tbody>"/* +
					  "<tr><td colspan=\"3\"><div class=\"innerb\"><table class=\"tabletwo\">"*/;
			Iterator<CtaCasCuentaAsociado> iterator = seguros.iterator();
			int correl=0;
			while (iterator.hasNext()) {
				CtaCasCuentaAsociado cuenta = iterator.next(); 
				CtaSegSeguros seguro = cuenta.getCtaSegSeguros();
				html = html
					+"<tr>" +
						"<td align=\"center\"> <input type=\"checkbox\" value=\""+correl+"\" name=\"selectedItemsS\" /> " +
							"<input type=\"hidden\" value=\""+seguro.getSegId()+"\" name=\"idS\" />"+
						"</td>"+
						"<td>"+seguro.getSegId()+"</td>" +
						"<td>"+seguro.getCtaTisTipoSeguro().getTisNombre()+"</td>" +
						"<td>"+df.format(seguro.getSegSaldoActual())+
							"<input type=\"hidden\" value=\""+df.format(seguro.getSegSaldoActual())+"\" name=\"saldosS\" />"+
						"</td>" +
						"<td align=\"center\"> <input type=\"text\" size=\"12\" maxlength=\"12\" style=\"numeric\" name=\"liquidaS\" styleId=\"liquidarS\" /></td>" +
					"</tr>";
				correl++;
			}
			html = html + /*"</table></div></td></tr>*/"</tbody></table></div><br><br>";
		}
		return html;
	}
	
	private String construirListaPrestamos(List<CtaCasCuentaAsociado> prestamos, HttpServletRequest request){
		DecimalFormat df = new DecimalFormat("0.00");
		String html = "";
		CtaMxpMovimientoPrestamoDAO movPresDAO = new CtaMxpMovimientoPrestamoDAO(getSessionHibernate(request));
		
		if(prestamos.isEmpty()){
			html = "<td><br><br><span style=\"font-size: 13px;color: red;\">"
			+ "El asociado no posee al menos un prestamo a liquidar</span></td>";
		}else{
			 html = "<div >" +
			 		//"<table border=\"1px\" cellpadding=\"2\" cellspacing=\"1\">" +
			 "<table align=\"center\"style=\"font-family: 'Lucida Sans Unicode', 'Lucida Grande', Sans-Serif;font-size: 13px;margin-bottom: 20px;margin-top:20px;margin-left: auto;margin-right: auto;text-align: left;border-collapse: collapse;padding: 20px 20px 20px 20px;\" id=\"hor-zebra\">"+
			 		"<caption style=\"font-size: 13px;color: blue;\" >PR&Eacute;STAMOS A LIQUIDAR</caption>"
					+ "<thead>" +
						"<tr>" +
							//"<th>&nbsp;</th>" +
							"<th>C&oacute;digo</th>" +
							"<th>Nombre Cuenta</th>" +
							"<th>Saldo</th>" +
							"<th>Intereses</th>" +
							//"<th>Valor a Liquidar</th>" +
						"</tr>" +
					"</thead>" +
					"<tbody>"/* +
						/*"<tr>" +
							"<td colspan=\"4\"><div class=\"innerb\"><table class=\"tabletwo\">"*/;
			Iterator<CtaCasCuentaAsociado> iterator = prestamos.iterator();
			int correl=0;
			Format formato = new Format();
			IntereseYMora interesYMora = new IntereseYMora();
			Double pendiente, inteAcumulado;
			while (iterator.hasNext()) {
				CtaCasCuentaAsociado cuenta = iterator.next();
				CtaPrePrestamo prestamo = cuenta.getCtaPrePrestamo();
				CtaMxpMovimientoPrestamo movimiento = movPresDAO.findUltimoMovimiento(prestamo.getPreId());
				if(movimiento == null){
					movimiento = new CtaMxpMovimientoPrestamo();
				}
				interesYMora = interesYMora.actualizaInteres(movimiento, prestamo, cuenta,new Date(),request);
				pendiente=interesYMora.getPendiente();
				inteAcumulado = interesYMora.getAcumulado();
				html = html
					+ "<tr>" +
							//"<td align=\"center\"> <input type=\"checkbox\" value=\""+correl+"\" name=\"selectedItemsP\" /> " +
								"<input type=\"hidden\" value=\""+prestamo.getPreId()+"\" name=\"idP\" />"+
							"</td>"+
							"<td>"+prestamo.getPreId()+"</td>" +
							"<td>"+prestamo.getCtaTprTipoPrestamo().getTprNombre()+"</td>" +
							"<td>"+df.format(prestamo.getPreSaldoActualT())+
								"<input type=\"hidden\" value=\""+df.format((prestamo.getPreSaldoActualT() +pendiente+inteAcumulado))+"\" name=\"saldosP\" />"+
							"</td>"+
							"<td>"+formato.formatDineroSinSimbolo(pendiente+inteAcumulado)+"</td>" +
							//"<td align=\"center\"> <input type=\"text\" size=\"12\" maxlength=\"12\" style=\"numeric\" name=\"liquidaP\" styleId=\"liquidarP\" /></td>" +
					 "</tr>";
				correl++;
			}
				html = html + /*"</table></div></td></tr>"+*/"</tbody></table></div></div><br>";
		}
		return html;
	}
	
	public ActionForward generarReporteLiquidacion(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		HashMap<String, Object> pars = new HashMap<String, Object>();
		LiquidacionAsociadoForm liquidacionAsociadoForm = (LiquidacionAsociadoForm) form;
		
		CtaLasLiquidarAsociadoDAO liquidarAsociadoDAO = new CtaLasLiquidarAsociadoDAO(getSessionHibernate(request));
		CtaAscAsociadoDAO asociadoDAO = new CtaAscAsociadoDAO(getSessionHibernate(request));
		CtaAscAsociado asociado = asociadoDAO.findById(liquidacionAsociadoForm.getAscId());
		
		String pathReporte = getServlet().getServletContext().getRealPath(rutaReporteLiquidado+reporteLiquidado+".jrxml");
		SimpleDateFormat sdf = new SimpleDateFormat("dd-MM-yyyy");
		Date fechaLiquidacion = new Date();
		String mes= "";
		switch (new Integer(sdf.format(fechaLiquidacion).substring(3, 5))) {
		case 1: mes=" Enero "; break;
		case 2: mes=" Febrero "; break;
		case 3: mes=" Marzo "; break;
		case 4: mes=" Abril "; break;
		case 5: mes=" Mayo "; break;
		case 6: mes=" Junio "; break;
		case 7: mes=" Julio "; break;
		case 8: mes=" Agosto "; break;
		case 9: mes=" Septiembre "; break;
		case 10: mes=" Octubre "; break;
		case 11: mes=" Noviembre "; break;
		case 12: mes=" Diciembre "; break;
		}
		pars.put(ASCID,liquidacionAsociadoForm.getAscId());
		pars.put("dia",new Integer(sdf.format(fechaLiquidacion).substring(0, 2)));
		pars.put("mes",mes);
		pars.put("anio",new Integer(sdf.format(fechaLiquidacion).substring(6, 10)));
		pars.put("fecha", fechaLiquidacion);
		pars.put("nombreA", asociado.getSecPerPersona().getPerPrimerNombre() +" "
				+ asociado.getSecPerPersona().getPerSegundoNombre() + " "+
				asociado.getSecPerPersona().getPerPrimerApellido()+ " "
				+ asociado.getSecPerPersona().getPerSegundoApellido());
		pars.put("codigoA", asociado.getAscCodigoAsociado());
		
		Transaction tx = liquidarAsociadoDAO.getSession().beginTransaction();
		try{
			liquidarAsociadoDAO.deleteAll();/*con la esperanza que se haga*/
			
			String[] idsA = liquidacionAsociadoForm.getIdA();//ids de cuentas
			Integer[] posicionA = liquidacionAsociadoForm.getSelectedItemsA();//posiciones de los seleccionados
			Double[] saldosA = liquidacionAsociadoForm.getSaldosA();//saldos actuales con intereses totales
			Double[] liquidarA = liquidacionAsociadoForm.getLiquidaA();//total a liquidar independientemente del saldo
			
			String[] idsP = liquidacionAsociadoForm.getIdP();
			Integer[] posicionP = liquidacionAsociadoForm.getSelectedItemsP();
			Double[] saldosP = liquidacionAsociadoForm.getSaldosP();
			Double[] liquidarP = liquidacionAsociadoForm.getLiquidaP();
			
			String[] idsS = liquidacionAsociadoForm.getIdS();
			Integer[] posicionS = liquidacionAsociadoForm.getSelectedItemsS();
			Double[] liquidarS = liquidacionAsociadoForm.getLiquidaS();
			
			int j = 0;
			CtaCahCuentaAhorroDAO ahorroDAO = new CtaCahCuentaAhorroDAO(getSessionHibernate(request));
			if(idsA!=null)
				for (int i = 0; i < idsA.length; i++) {
					CtaCahCuentaAhorro ahorro = ahorroDAO.findById(idsA[i]);
					String nombreCuenta = (ahorro.getCtaTahTipoAhorro()==null)?"APORTACIONES":ahorro.getCtaTahTipoAhorro().getTahNombre();
					Double saldoActual = ahorro.getCahSaldoActual();
					Double interesActual = saldosA[i] - saldoActual;
					
					/*agregar a la tabla temporal para ello*/
					CtaLasLiquidarAsociado padreLiquidacion = new CtaLasLiquidarAsociado();
					CtaLasLiquidarAsociadoId itemLiquidacion = new CtaLasLiquidarAsociadoId();
					
					itemLiquidacion.setLasId(j);
					itemLiquidacion.setLasFavorContra(1);
					itemLiquidacion.setLasNombreCuenta(nombreCuenta);
					itemLiquidacion.setLasSaldo(saldoActual);
					itemLiquidacion.setLasInteres(interesActual);
					itemLiquidacion.setLasOtrasDeducciones(0.0);
					itemLiquidacion.setLasAscId(asociado.getAscId());
					
					padreLiquidacion.setId(itemLiquidacion);
					
					liquidarAsociadoDAO.save(padreLiquidacion);
					j++;
				}
			
			CtaPrePrestamoDAO prestamoDAO = new CtaPrePrestamoDAO(getSessionHibernate(request));
			if(idsP != null)
				for (int i = 0; i < idsP.length; i++) {
					CtaPrePrestamo prestamo = prestamoDAO.findById(idsP[i]);
					String nombreCuenta = prestamo.getCtaTprTipoPrestamo().getCtaLprLineaPrestamo().getLprNombre()+"; "+prestamo.getCtaTprTipoPrestamo().getTprNombre();
					Double saldoActual  = prestamo.getPreSaldoActualT();
					Double interesActual = saldosP[i] - saldoActual;
					
					/*agregar a la tabla temporal para ello*/
					CtaLasLiquidarAsociado padreLiquidacion = new CtaLasLiquidarAsociado();
					CtaLasLiquidarAsociadoId itemLiquidacion = new CtaLasLiquidarAsociadoId();
					
					itemLiquidacion.setLasId(j);
					itemLiquidacion.setLasFavorContra(-1);
					itemLiquidacion.setLasNombreCuenta(nombreCuenta);
					itemLiquidacion.setLasSaldo(saldoActual);
					itemLiquidacion.setLasInteres(interesActual);
					itemLiquidacion.setLasOtrasDeducciones(0.0);
					itemLiquidacion.setLasAscId(asociado.getAscId());
					
					j ++;
					padreLiquidacion.setId(itemLiquidacion);
					
					liquidarAsociadoDAO.save(padreLiquidacion);
				}
			
			CtaSegSegurosDAO seguroDAO = new CtaSegSegurosDAO(getSessionHibernate(request));
			if(idsS!= null)
				for (int i = 0; i < idsS.length; i++) {
					CtaSegSeguros seguro = seguroDAO.findById(idsS[i]);
					String nombreCuenta = seguro.getCtaTisTipoSeguro().getTisNombre();
					Double saldoActual  = seguro.getSegSaldoActual();
					Double interesActual = 0.0;
					
					/*agregar a la tabla temporal para ello*/
					CtaLasLiquidarAsociado padreLiquidacion = new CtaLasLiquidarAsociado();
					CtaLasLiquidarAsociadoId itemLiquidacion = new CtaLasLiquidarAsociadoId();
					
					itemLiquidacion.setLasId(j);
					itemLiquidacion.setLasFavorContra(-1);
					itemLiquidacion.setLasNombreCuenta(nombreCuenta);
					itemLiquidacion.setLasSaldo(saldoActual);
					itemLiquidacion.setLasInteres(interesActual);
					itemLiquidacion.setLasOtrasDeducciones(0.0);
					itemLiquidacion.setLasAscId(asociado.getAscId());
					
					j++;
					padreLiquidacion.setId(itemLiquidacion);
					
					liquidarAsociadoDAO.save(padreLiquidacion);
				}
		}catch (Exception e) {
			tx.rollback();
			e.printStackTrace();
		}finally{
			tx.commit();
			liquidarAsociadoDAO.getSession().flush();
			liquidarAsociadoDAO.getSession().clear();
		}
		
		
		try{
			
			//Connection con = HibernateSessionFactory.getSession().connection();
			
			//Conexion jdbc normal
			String jdbcDriver = "com.mysql.jdbc.Driver";
			Class.forName(jdbcDriver);
			String url = HibernateSessionFactory.getConfiguration().getProperty("connection.url");
			String user = HibernateSessionFactory.getConfiguration().getProperty("connection.username");
			String pass = HibernateSessionFactory.getConfiguration().getProperty("connection.password");

			Connection con = DriverManager.getConnection(url, user, pass);
			
			FileInputStream input = new FileInputStream(new File(pathReporte));
			JasperDesign jd = JRXmlLoader.load(input);
			JasperReport jr = JasperCompileManager.compileReport(jd);
			JasperPrint jp = JasperFillManager.fillReport(jr,pars, con);
			response.setHeader("Cache-Control","private");
			response.setHeader("Pragma", "Cache");
			response.setContentType("application/pdf");
			response.setHeader("content-Disposition", "attachment;filename=" + reporteLiquidado + new SimpleDateFormat("yyyy-MM-dd").format(new Date()) + ".pdf");
	        JRPdfExporter pdfExporter = new JRPdfExporter();
	        pdfExporter.setParameter(JRExporterParameter.JASPER_PRINT, jp);
	        pdfExporter.setParameter(JRExporterParameter.OUTPUT_STREAM, response.getOutputStream());
	        pdfExporter.exportReport();
		}catch (Exception e) {
			e.printStackTrace();
		}
		return null;
	}
	
	public ActionForward proyectarLiquidacion(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		LiquidacionAsociadoForm liquidacionAsociadoForm = (LiquidacionAsociadoForm) form;
		ElapsedTime elap = new ElapsedTime();
		Date fechaProy = elap.obtenerFecha(new Date(), liquidacionAsociadoForm.getMesesProyeccion());
		/* 1.	proyectar ahorros
 		 * 2.	proyectar prestamos
 		 * 3.	sumar intereses pendientes, mora en prestamos con el saldo pendiente
 		 * 4.	asignar a tabla temporal partida contable, para vista asi:
 		 * 5.	codigo='tipo al que pertenece';cue_id= correlativo;	nombrecuenta; parcial= saldo actual; debe= interes actual; haber=interes proyectado
 		 * 6.	limpiar tabla despues de haber generado reporte
 		 * */
		
		CtaAscAsociadoDAO ascAsociadoDAO = new CtaAscAsociadoDAO(getSessionHibernate(request));
		CtaCasCuentaAsociadoDAO cAsociadoDAO = new CtaCasCuentaAsociadoDAO(getSessionHibernate(request));
		CtaCahCuentaAhorroDAO ahorroDAO = new CtaCahCuentaAhorroDAO(getSessionHibernate(request));
		CtaMxpMovimientoPrestamoDAO movPresDAO = new CtaMxpMovimientoPrestamoDAO(getSessionHibernate(request));
		//PartidaContableDAO partidaDAO = new PartidaContableDAO(getSessionHibernate(request));
		
		CtaLasLiquidarAsociadoDAO liquidarAsociadoDAO = new CtaLasLiquidarAsociadoDAO(getSessionHibernate(request));
		
		CtaAscAsociado liquidando = ascAsociadoDAO.findById(liquidacionAsociadoForm.getAscId());
		Transaction tx = liquidarAsociadoDAO.getSession().beginTransaction();
		try{//socio a liquidar
			liquidarAsociadoDAO.deleteAll();
			tx.commit();
				
			int cont=0;////***********/////
 			List<CtaCahCuentaAhorro> listaAhorro = ahorroDAO.findListByLiquidacion(liquidando .getAscId());
 			List listaPrestamos = cAsociadoDAO.findPrestamoByEstadoAsocGarantiaYesNo(liquidando .getAscId(),13,0);
 			List listaSeguros = cAsociadoDAO.findByAscAndTipoCuenta2(liquidando .getAscId(), "D");
 			String nombreCuenta;
 			Double saldoActual = 0.0;
 			Double interesActual = 0.0;
 			int correl=0;
 			
 			/***AHORROS***/
 			Iterator<CtaCahCuentaAhorro> iterator = listaAhorro.iterator();
			//CuentaAhorroForm ahorroForm = new CuentaAhorroForm();
			CuentaAhorroAction ahorroAction = new CuentaAhorroAction();
			while (iterator.hasNext()) {
				Double nuevoInteres=0.0;
				Double interesProyectado =0.0;
				nuevoInteres = new Double(0);//INTERES ACTUAL
				CtaCahCuentaAhorro ahorro = iterator.next();
				nombreCuenta = ahorro.getCtaTahTipoAhorro()==null?"APORTACIONES":ahorro.getCtaTahTipoAhorro().getTahNombre();
				saldoActual = ahorro.getCahSaldoActual();
				if(ahorro.getCtaTahTipoAhorro() != null){
					//ahorroForm.setCtaCahCuentaAhorroH(ahorro);
					nuevoInteres += ahorro.getCahInteresAcumulado();
					nuevoInteres += ahorroAction.calculoInteresTransaccion(ahorro.getCahId(),new Date(),request); 
					
					//interes proyectado
					CtrParParametrosDAO parametroDAO = new CtrParParametrosDAO(getSessionHibernate(request));
					CtrParParametros parametroAnio = parametroDAO.findById("ANHO_CALENDARIO");
					Double interes = ahorro.getCtaTahTipoAhorro().getCtaTinTasaInteres().getTinTasa();
					interes = interes/100;
					interesProyectado = (saldoActual*interes)*liquidacionAsociadoForm.getMesesProyeccion()/parametroAnio.getParValorNumber();
					interesProyectado += nuevoInteres;
					
				}
				
				
				/*agregar a la tabla temporal para ello*/
				CtaLasLiquidarAsociado padreLiquidacion = new CtaLasLiquidarAsociado();
				CtaLasLiquidarAsociadoId itemLiquidacion = new CtaLasLiquidarAsociadoId();
				
				itemLiquidacion.setLasId(correl);
				itemLiquidacion.setLasFavorContra(1);
				itemLiquidacion.setLasNombreCuenta(nombreCuenta);
				itemLiquidacion.setLasSaldo(saldoActual);
				itemLiquidacion.setLasInteres(nuevoInteres);
				itemLiquidacion.setLasOtrasDeducciones(interesProyectado);//para el nuevo interes
				itemLiquidacion.setLasAscId(liquidando.getAscId());
				
				padreLiquidacion.setId(itemLiquidacion);
				
				liquidarAsociadoDAO.save(padreLiquidacion);
				correl++;
			}
			
			
			/***PRESTAMOS****/
			Iterator<CtaCasCuentaAsociado> it = listaPrestamos.iterator();
			Format formato = new Format();
			IntereseYMora interesYMora = new IntereseYMora();
			Double pendiente, inteAcumulado, intActualP, intProyectadoP;
			
			while (it.hasNext()) {
				CtaCasCuentaAsociado cuenta = it.next();
				CtaPrePrestamo prestamo = cuenta.getCtaPrePrestamo();
				nombreCuenta = prestamo.getCtaTprTipoPrestamo().getCtaLprLineaPrestamo().getLprNombre() + ";  "+
							   prestamo.getCtaTprTipoPrestamo().getTprNombre();
				CtaMxpMovimientoPrestamo movimiento = movPresDAO.findUltimoMovimiento(prestamo.getPreId());
				if(movimiento == null){
					movimiento = new CtaMxpMovimientoPrestamo();
				}
				//calculo de interes actual en prestamos
				interesYMora = interesYMora.actualizaInteres(movimiento, prestamo, cuenta,new Date(),request);
				pendiente=interesYMora.getPendiente();
				inteAcumulado = interesYMora.getAcumulado();
				
				intActualP = pendiente + inteAcumulado;
				
				//calculo de interes proyectado en prestamos
				interesYMora = interesYMora.actualizaInteres(movimiento, prestamo, cuenta, fechaProy, request);
				pendiente=interesYMora.getPendiente();
				inteAcumulado = interesYMora.getAcumulado();
				
				intProyectadoP=pendiente + inteAcumulado;
				
				
				/*agregar a la tabla temporal para ello*/
				CtaLasLiquidarAsociado padreLiquidacion = new CtaLasLiquidarAsociado();
				CtaLasLiquidarAsociadoId itemLiquidacion = new CtaLasLiquidarAsociadoId();
				
				itemLiquidacion.setLasId(correl);
				itemLiquidacion.setLasFavorContra(2);
				itemLiquidacion.setLasNombreCuenta(nombreCuenta);
				itemLiquidacion.setLasSaldo(prestamo.getPreSaldoActualT());
				itemLiquidacion.setLasInteres(intActualP);
				itemLiquidacion.setLasOtrasDeducciones(intProyectadoP<0?0.0:intProyectadoP);//para el nuevo interes
				itemLiquidacion.setLasAscId(liquidando.getAscId());
				
				padreLiquidacion.setId(itemLiquidacion);
				
				liquidarAsociadoDAO.save(padreLiquidacion);
				
				correl++;
			}
			
 			/**SEGUROS**/
 			Iterator<CtaCasCuentaAsociado> iteradorS = listaSeguros.listIterator();
 			while(iteradorS.hasNext()){
 				CtaCasCuentaAsociado cuAsociado = iteradorS.next();
 				CtaSegSeguros seguro = cuAsociado.getCtaSegSeguros();
 				nombreCuenta = seguro.getCtaTisTipoSeguro().getTisNombre();
 				
 				/*agregar a la tabla temporal para ello*/
				CtaLasLiquidarAsociado padreLiquidacion = new CtaLasLiquidarAsociado();
				CtaLasLiquidarAsociadoId itemLiquidacion = new CtaLasLiquidarAsociadoId();
				
				itemLiquidacion.setLasId(correl);
				itemLiquidacion.setLasFavorContra(3);
				itemLiquidacion.setLasNombreCuenta(nombreCuenta);
				itemLiquidacion.setLasSaldo(seguro.getSegSaldoActual());
				itemLiquidacion.setLasInteres(0.0);
				itemLiquidacion.setLasOtrasDeducciones(0.0);//para el nuevo interes
				itemLiquidacion.setLasAscId(liquidando.getAscId());
				
				padreLiquidacion.setId(itemLiquidacion);
				
				liquidarAsociadoDAO.save(padreLiquidacion);
				
				correl++;
			}
 			
 			/*			
				partidaDAO.save(llenarTablaPartida("3", cont++, seguro.getCtaTisTipoSeguro().getTisNombre(), 
 						seguro.getSegSaldoActual(), 0.0, 0.0));
				Iterator<CtaPrePrestamo> iteradorP = listaPrestamos.listIterator();
				IntereseYMora interesYMora = new IntereseYMora();
				Double mora1, pendiente1, inteAcumulado1, mora,pendiente,inteAcumulado;
				while(iteradorP.hasNext()){
					CtaPrePrestamo prestamo = iteradorP.next();
					CtaCasCuentaAsociado cuAsoc = cAsociadoDAO.findByPreId(prestamo.getPreId());
					
					CtaMxpMovimientoPrestamo movimiento = movPresDAO.findUltimoMovimiento(prestamo.getPreId());
					if(movimiento == null){
						movimiento = new CtaMxpMovimientoPrestamo();
					}
					//primer calculo de interes, hasta hoy
					interesYMora = interesYMora.actualizaInteres(movimiento, prestamo, cuAsoc,new Date());
					inteAcumulado1 = interesYMora.getAcumulado();//interes corriente
					mora1 = interesYMora.getMora();
					pendiente1 = interesYMora.getPendiente();
					
					//calculo de interes de hoy en adelante hasta la proyeccion
					interesYMora = interesYMora.actualizaInteres(movimiento, prestamo, cuAsoc, greCalendarM.getTime());
					inteAcumulado = interesYMora.getAcumulado() - inteAcumulado1;//interes corriente
					mora = interesYMora.getMora() - mora1;
					pendiente = interesYMora.getPendiente() - pendiente1;
					partidaDAO.save(llenarTablaPartida("2", cont++, 
							(prestamo.getCtaTprTipoPrestamo()==null)?"CREDITO":prestamo.getCtaTprTipoPrestamo().getTprNombre(), 
									prestamo.getPreSaldoActualT(), inteAcumulado1+mora1+pendiente1, inteAcumulado+mora+pendiente));
					
				}
				
				/*
	 			CuentaAhorroAction ahorroAction = new CuentaAhorroAction();
	 			CuentaAhorroForm ahorroForm = new CuentaAhorroForm();
	 			Double interesesProyectados = new Double(0.0);
	 			Date hoy = new Date();
	 			int meses = liquidacionAsociadoForm.getMesesProyeccion();
	 			GregorianCalendar greCalendarM = new GregorianCalendar();
	 			greCalendarM.setTime(hoy);
	 			if(meses>0)	 greCalendarM.add(Calendar.DAY_OF_YEAR, meses);
	 			
	 				
	 				Iterator<CtaCahCuentaAhorro> itAh = listaAhorro.listIterator();
	 				while(itAh.hasNext()){
	 					CtaCahCuentaAhorro ahorro = itAh.next();
	 					ahorro = ahorroDAO.findById(ahorro.getCahId());
	 					ahorroForm.setCtaCahCuentaAhorroH(ahorro);
	 					interesesProyectados=0.0;
	 					if(ahorro.getCtaTahTipoAhorro()!=null) interesesProyectados = ahorroAction.calculoInteresTransaccion(ahorroForm, greCalendarM.getTime());
	 					String nombreCuenta = (ahorro.getCtaTahTipoAhorro()==null)?"APORTACIONES":ahorro.getCtaTahTipoAhorro().getTahNombre();
	 					partidaDAO.save(llenarTablaPartida("1", cont++, nombreCuenta,ahorro.getCahSaldoActual(), ahorro.getCahInteresAcumulado(), interesesProyectados));
	 				}
	 				*/
				
		}catch(Exception e){
			tx.rollback();
			e.printStackTrace();
		}finally{
			tx.commit();
			liquidarAsociadoDAO.getSession().flush();
			liquidarAsociadoDAO.getSession().clear();
		}
		try{
			HashMap<String, Object> pars = new HashMap<String, Object>();
			String rutaReporte = "/listaReportes/liquidacion/";
			String reporte = "REPORTE_PROYECCION_LIQUIDACION";
			String pathReporte = getServlet().getServletContext().getRealPath(rutaReporte+reporte+".jrxml");
			
			String jdbcDriver = "com.mysql.jdbc.Driver";
			Class.forName(jdbcDriver);
			String url = HibernateSessionFactory.getConfiguration().getProperty("connection.url");
			String user = HibernateSessionFactory.getConfiguration().getProperty("connection.username");
			String pass = HibernateSessionFactory.getConfiguration().getProperty("connection.password");

			Connection con = DriverManager.getConnection(url, user, pass);
			
			FileInputStream input = new FileInputStream(new File(pathReporte));
			CtaAscAsociado asociado = ascAsociadoDAO.findById(liquidacionAsociadoForm.getAscId());
			String nombre  = asociado.getAscCodigo() + " ; " + asociado.getSecPerPersona().getPerPrimerNombre() +" "
							+ asociado.getSecPerPersona().getPerSegundoNombre() +" "+ asociado.getSecPerPersona().getPerPrimerApellido()+ " "
							+ asociado.getSecPerPersona().getPerSegundoApellido();
			
			pars.put("PCO_ID", asociado.getAscId());
			pars.put("nombreCompleto",nombre);
			pars.put("fechaProy",fechaProy);
			
			JasperDesign jd = JRXmlLoader.load(input);
			JasperReport jr = JasperCompileManager.compileReport(jd);
			JasperPrint jp = JasperFillManager.fillReport(jr,pars, con);
			
			response.setHeader("Cache-Control","private");
			response.setHeader("Pragma", "Cache");
			response.setContentType("application/pdf");
			response.setHeader("content-Disposition", "attachment;filename=" + reporte + new SimpleDateFormat("yyyy-MM-dd").format(new Date()) + ".pdf");
	        JRPdfExporter pdfExporter = new JRPdfExporter();
	        pdfExporter.setParameter(JRExporterParameter.JASPER_PRINT, jp);
	        pdfExporter.setParameter(JRExporterParameter.OUTPUT_STREAM, response.getOutputStream());
	        pdfExporter.exportReport();
		}catch(Exception e){
			e.printStackTrace();
		}
		return lista(mapping, form, request, response);
	}
	
	public PartidaContable llenarTablaPartida(String codigoCuenta, 
							int cuentaId, String nombreCuenta, Double saldoActual, Double interesActual, Double interesProyectado){
		PartidaContable partida = new PartidaContable();
		partida.setCodigoCuenta(codigoCuenta);
		partida.setNombreCuenta(nombreCuenta);
		partida.setCuentaId(cuentaId);
		partida.setParcial(saldoActual);
		partida.setDebe(interesActual);
		partida.setHaber(interesProyectado);
		partida.setPcoId(new Long(0));
		return partida;
	 }
	
	protected Map<String, String> getKeyMethodMap() {
		HashMap<String, String> map = new HashMap<String, String>();
		map.put("cmd.liq.lista","lista");
		map.put("cmd.liq.buscar","buscar");
		map.put("cmd.liq.cargarDatos","cargarDatos");
		map.put("cmd.liq.liquidar","liquidar");
		map.put("cmd.liq.regresar","regresar");
		map.put("cmd.liq.cargarDependientes","cargarDependientes");
		map.put("cmd.liq.cargarCuentasYPrestamos","cargarCuentasYPrestamos");
		map.put("cmd.liq.generarReporteLiquidacion","generarReporteLiquidacion");
		map.put("cmd.liq.proyectar", "proyectarLiquidacion");
		map.put("cmd.liq.cargarDatosP", "cargarDatosProyeccion");
		return map;
	}
}