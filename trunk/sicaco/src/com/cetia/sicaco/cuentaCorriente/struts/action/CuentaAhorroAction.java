/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package com.cetia.sicaco.cuentaCorriente.struts.action;

import java.io.IOException;
import java.sql.Connection;
import java.sql.DriverManager;
import java.text.DateFormat;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.Date;
import java.util.GregorianCalendar;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import javax.servlet.ServletContext;
import javax.servlet.ServletOutputStream;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.struts.action.ActionErrors;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;
import org.apache.struts.action.ActionMessage;
import org.apache.struts.action.ActionMessages;
import org.hibernate.Transaction;
import org.jmesa.facade.TableFacade;
import org.jmesa.facade.TableFacadeImpl;
import org.jmesa.limit.ExportType;
import org.jmesa.limit.Limit;
import org.jmesa.view.component.Column;
import org.jmesa.view.component.Row;
import org.jmesa.view.component.Table;
import org.jmesa.view.editor.BasicCellEditor;
import org.jmesa.view.editor.CellEditor;
import org.jmesa.view.editor.DateCellEditor;

import com.cetia.sicaco.contabilidad.struts.form.FondosOficinaForm;
import com.cetia.sicaco.cuentaCorriente.struts.form.AgregaBenForm;
import com.cetia.sicaco.cuentaCorriente.struts.form.CuentaAhorroForm;
import com.cetia.sicaco.cuentaCorriente.struts.form.CuentaAsociadoForm;
import com.cetia.sicaco.hibernate.ConCueCuentaDAO;
import com.cetia.sicaco.hibernate.CtaAscAsociado;
import com.cetia.sicaco.hibernate.CtaAscAsociadoDAO;
import com.cetia.sicaco.hibernate.CtaCahCuentaAhorro;
import com.cetia.sicaco.hibernate.CtaCahCuentaAhorroDAO;
import com.cetia.sicaco.hibernate.CtaCasCuentaAsociado;
import com.cetia.sicaco.hibernate.CtaCasCuentaAsociadoDAO;
import com.cetia.sicaco.hibernate.CtaCbaCuentaBancaria;
import com.cetia.sicaco.hibernate.CtaCbaCuentaBancariaDAO;
import com.cetia.sicaco.hibernate.CtaMxaMovimientoAhorro;
import com.cetia.sicaco.hibernate.CtaMxaMovimientoAhorroDAO;
import com.cetia.sicaco.hibernate.CtaNotNotas;
import com.cetia.sicaco.hibernate.CtaNotNotasDAO;
import com.cetia.sicaco.hibernate.CtaPlmPlanMeses;
import com.cetia.sicaco.hibernate.CtaStbSolTransBanc;
import com.cetia.sicaco.hibernate.CtaStbSolTransBancDAO;
import com.cetia.sicaco.hibernate.CtaTahTipoAhorro;
import com.cetia.sicaco.hibernate.CtaTahTipoAhorroDAO;
import com.cetia.sicaco.hibernate.CtaTinTasaInteresDAO;
import com.cetia.sicaco.hibernate.CtaTxaTransaccionxcuentaAsociado;
import com.cetia.sicaco.hibernate.CtaTxaTransaccionxcuentaAsociadoDAO;
import com.cetia.sicaco.hibernate.CtrEstEstado;
import com.cetia.sicaco.hibernate.CtrEstEstadoDAO;
import com.cetia.sicaco.hibernate.CtrParParametros;
import com.cetia.sicaco.hibernate.CtrParParametrosDAO;
import com.cetia.sicaco.hibernate.HibernateSessionFactory;
import com.cetia.sicaco.hibernate.SecIseInicioSesion;
import com.cetia.sicaco.hibernate.SecIseInicioSesionDAO;
import com.cetia.sicaco.reporte.struts.form.ReporteForm;
import com.cetia.sicaco.reporte.struts.form.ReportesForm;
import com.cetia.sicaco.struts.Constantes;
import com.cetia.sicaco.struts.DMLAction;
import com.cetia.sicaco.struts.PartidaAutomatica;
import com.mad.utilidades.Cuenta;
import com.mad.utilidades.ElapsedTime;
import com.mad.utilidades.ExportReport;
import com.mad.utilidades.Format;
import com.mad.utilidades.IntereseYMora;
import com.mad.utilidades.ReportFile;

/** 
 * MyEclipse Struts
 * Creation date: 08-11-2008
 * 
 * XDoclet definition:
 * @struts.action path="/cuentaAhorro" name="cuentaAhorroForm" input="redirectInvalidData" parameter="accion" scope="request" validate="true"
 * @struts.action-forward name="lista" path="pagina-lista"
 * @struts.action-forward name="redirectInvalidData" path="redirectInvalidData" redirect="true"
 */
public class CuentaAhorroAction extends DMLAction {
	
	public String TABLA_ID = "ctaMxaMovimientoAhorro";
	private String LIST_TIPO_AHORRO="lstTahTipoAhorro";
	public String LIST_ESTADO = "lstCtrEstEstado";
	public String LIST_CUENTAS = "lstCuentas";
	
	
	public ActionForward lista(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		CuentaAhorroForm cuentaAhorroForm = (CuentaAhorroForm) form;
		CtaMxaMovimientoAhorroDAO movimientosAhorro = new CtaMxaMovimientoAhorroDAO(getSessionHibernate(request));
		CtaCahCuentaAhorroDAO cueAhDAO = new CtaCahCuentaAhorroDAO(getSessionHibernate(request));
		CtaTahTipoAhorroDAO tipoAhorroDAO = new CtaTahTipoAhorroDAO(getSessionHibernate(request));
		List lstTipoAhorro = tipoAhorroDAO.findAll();
		List lst = null;
		if(cuentaAhorroForm.getCahId()!=null){//si se modificara
			lst = movimientosAhorro.findByProperty("ctaCahCuentaAhorro.cahId", cuentaAhorroForm.getCahId());
			CtaCasCuentaAsociadoDAO cuentaADAO = new CtaCasCuentaAsociadoDAO(getSessionHibernate(request));
			CtaCasCuentaAsociado cuA = new CtaCasCuentaAsociado();
			List listC = cuentaADAO.findByProperty("ctaCahCuentaAhorro.cahId", cuentaAhorroForm.getCahId());
			cuA = (CtaCasCuentaAsociado)listC.get(0);
			cuentaAhorroForm.setCtaCasCuentaAsociado(cuA);
		}else{//si es nueva
			lst = movimientosAhorro.findByProperty("ctaCahCuentaAhorro.cahId", " ");
			CtaCahCuentaAhorro cuenAhorro = new CtaCahCuentaAhorro();
			cuenAhorro.setCahId(cueAhDAO.generarId("B"));
			cuentaAhorroForm.setCtaCahCuentaAhorroH(cuenAhorro);
			cuentaAhorroForm.setCasValorApertura(0.0);
			SimpleDateFormat sdf = new SimpleDateFormat("dd-MM-yyyy HH:mm:ss");
			cuentaAhorroForm.setCasFechaApertura(sdf.format(new Date()));
			//llenar con ajax tasa interes, plazo mes (si hay)
			
			request.setAttribute("datosTipoAhorro", cuentaAhorroForm.getCtaTahTipoAhorro());
		}
		
		TableFacade tableFacade = new TableFacadeImpl(TABLA_ID, request);
		tableFacade.setItems(lst);
		
		//---- Genera los tipos de formas con que se podran exportar los datos
		tableFacade.setExportTypes(response, ExportType.CSV, ExportType.JEXCEL);
		tableFacade.setStateAttr("restore");
		Limit limit = tableFacade.getLimit();
		if (limit.isExported()) {
        	//---- exporta la tabla
            export(tableFacade);
            return null; 
        } else {
        	//---- genera el html de la tabla para ser mostrada
            String html = html(tableFacade, request);
            request.setAttribute(Constantes.LISTA_KEY, html);
        }
				
		CtaAscAsociadoDAO ascDAO = new CtaAscAsociadoDAO(getSessionHibernate(request));
		request.setAttribute(LIST_TIPO_AHORRO, lstTipoAhorro);
		request.setAttribute("asociadoNombre",ascDAO.findById(cuentaAhorroForm.getAscId()));
		request.setAttribute("referencia", cuentaAhorroForm.getCtaCahCuentaAhorroH());
		request.setAttribute("form", cuentaAhorroForm);
		request.setAttribute(Constantes.ACCION_KEY, "/cuentaAhorro");
		return mapping.findForward("lista");
	}
	
	//---- metodo que genera el html de la tabla del jmesa
	private String html(final TableFacade tableFacade, final HttpServletRequest request) {
		tableFacade.setColumnProperties("mxaFecha", "mxaSaldoActual","mxaMonto");
		Table table = tableFacade.getTable();
		//---- Titulo de la tabla
		table.setCaptionKey("tbl.cah.caption");		
		Row row = table.getRow();
		
		Column nombreColumna = row.getColumn("mxaFecha");
		nombreColumna.setTitleKey("tbl.cah.mxaFecha");
		nombreColumna.getCellRenderer().setCellEditor(new DateCellEditor("dd-MMM-yyyy HH:mm:ss"));
		
		nombreColumna = row.getColumn("mxaSaldoActual");
		nombreColumna.setTitleKey("tbl.cah.mxaSaldoActual");
		nombreColumna.getCellRenderer().setCellEditor(new CellEditor(){

			public Object getValue(Object item, String property, int rowcount) {
				Object value = new BasicCellEditor().getValue(item, property, rowcount);
				String coa = "";
				CtaMxaMovimientoAhorro mxa = (CtaMxaMovimientoAhorro)item;
				CtaTxaTransaccionxcuentaAsociadoDAO txaDao = new CtaTxaTransaccionxcuentaAsociadoDAO(getSessionHibernate(request));
				CtaTxaTransaccionxcuentaAsociado txa = txaDao.findById(mxa.getCtaTxaTransaccionxcuentaAsociado().getTxaId());
				if(txa.getCtaTtrTipoTransaccion().getTtrUso().equals("A")){
					coa = "Abono";
				}else{
					coa = "Cargo";
				}
				return coa;
			}
		});
		
		nombreColumna = row.getColumn("mxaMonto");
		nombreColumna.setTitleKey("tbl.cah.txaMonto");
		nombreColumna.getCellRenderer().setCellEditor(new CellEditor(){

			public Object getValue(Object item, String property, int rowcount) {
				Object value = new BasicCellEditor().getValue(item, property, rowcount);
				CtaMxaMovimientoAhorro mxa = (CtaMxaMovimientoAhorro)item;
				return Format.formatDinero(mxa.getMxaMonto());
			}
		});
		
		return tableFacade.render();
	}
	
	//---- metodo que genera los exports, el formato que tendran
	 private void export(final TableFacade tableFacade) {
		 tableFacade.setColumnProperties("mxaFecha", "mxaSaldoActual","mxaMonto");
			Table table = tableFacade.getTable();
			//---- Titulo de la tabla
			table.setCaptionKey("tbl.cah.caption");
			
			Row row = table.getRow();
			Column nombreColumna = row.getColumn("mxaFecha");
			nombreColumna.setTitleKey("tbl.cah.mxaFecha");
			nombreColumna.getCellRenderer().setCellEditor(new DateCellEditor("dd-MMM-yyyy HH:mm:ss"));
			
			nombreColumna = row.getColumn("mxaSaldoActual");
			nombreColumna.setTitleKey("tbl.cah.mxaSaldoActual");
			
			nombreColumna = row.getColumn("mxaMonto");
			nombreColumna.setTitleKey("tbl.cah.txaMonto");
			
			tableFacade.render();
	}
	
	 public ActionForward cargarDatosTipoAhorro(ActionMapping mapping, ActionForm form,
				HttpServletRequest request, HttpServletResponse response) {
				CuentaAhorroForm cuAhorroForm = (CuentaAhorroForm)form;
				try{
					CtaTahTipoAhorroDAO tipoAhDAO = new CtaTahTipoAhorroDAO(getSessionHibernate(request));
					CtaTahTipoAhorro tipoAHorro = tipoAhDAO.findById(cuAhorroForm.getCtaTahTipoAhorro().getTahId());
					// Construimos una lista para el response
					String lista="";
					cuAhorroForm.setCtaTahTipoAhorro(tipoAHorro);
					if(tipoAHorro.getCtaPlmPlanMeses()!=null){
						lista +=" <label id=\"planMesLabel\" >  "+
								"Plan : ";
						lista +=tipoAHorro.getCtaPlmPlanMeses().getPlmNombre() + " Mes/es </label> "; 
					}
					lista += " <label id=\"tasaInteresLabel\" >  ";
					lista += "Tasa Interes : "+tipoAHorro.getCtaTinTasaInteres().getTinTasa() + 
							 " % </label> ";
					response.getWriter().write(lista);
					response.getWriter().flush();
					response.getWriter().close();
				} catch (RuntimeException e) {
					log.error("Error runtime", e);
				} catch (IOException e) {
					log.error(e);
				}
				return null;
		}
	 
	 //formulario de busqueda de cuentas en general.
	 public ActionForward buscarMovimientos(ActionMapping mapping, ActionForm form,
				HttpServletRequest request, HttpServletResponse response) {
		 	CuentaAhorroForm cuentaAhorroForm = (CuentaAhorroForm) form;
			CtaMxaMovimientoAhorroDAO movimientosAhorro = new CtaMxaMovimientoAhorroDAO(getSessionHibernate(request));
			CtaCahCuentaAhorroDAO cueAhDAO = new CtaCahCuentaAhorroDAO(getSessionHibernate(request));
			List lst = null;
			CtaTahTipoAhorroDAO tipoAhorroDAO = new CtaTahTipoAhorroDAO(getSessionHibernate(request));
			List lstTipoAhorro = tipoAhorroDAO.findAll();
			if(cuentaAhorroForm.getCahId()!=null){
				lst = movimientosAhorro.findByPeriod(cuentaAhorroForm.getFechaIni(), cuentaAhorroForm.getFechaFin(),
													cuentaAhorroForm.getCahId());
				CtaCasCuentaAsociadoDAO cuentaADAO = new CtaCasCuentaAsociadoDAO(getSessionHibernate(request));
				CtaCasCuentaAsociado cuA = new CtaCasCuentaAsociado();
				List listC = cuentaADAO.findByProperty("ctaCahCuentaAhorro.cahId", cuentaAhorroForm.getCahId());
				if(listC!=null){
					cuA = (CtaCasCuentaAsociado)listC.get(0);
				}
				cuentaAhorroForm.setCtaCasCuentaAsociado(cuA);
			}else{
				cuentaAhorroForm = (CuentaAhorroForm) request.getAttribute("form");
				lst = movimientosAhorro.findByProperty("ctaCahCuentaAhorro.cahId", " ");
				cuentaAhorroForm.setCahId(cueAhDAO.generarId("A"));
				cuentaAhorroForm.setCasValorApertura(0.0);
				SimpleDateFormat sdf = new SimpleDateFormat("dd-MM-yyyy");
				cuentaAhorroForm.setCasFechaApertura(sdf.format(new Date()));
			}
			
			TableFacade tableFacade = new TableFacadeImpl(TABLA_ID, request);
			tableFacade.setItems(lst);
			//---- Genera los tipos de formas con que se podran exportar los datos
			tableFacade.setExportTypes(response, ExportType.CSV, ExportType.JEXCEL);
			tableFacade.setStateAttr("restore");
			Limit limit = tableFacade.getLimit();
			if (limit.isExported()) {
	        	//---- exporta la tabla
	            export(tableFacade);
	            return null; 
	        } else {
	        	String html = html(tableFacade, request);
	            request.setAttribute(Constantes.LISTA_KEY, html);
	        }
	        //----- Variables de configuracion
			request.setAttribute(LIST_TIPO_AHORRO, lstTipoAhorro);
			CtaAscAsociadoDAO ascDAO = new CtaAscAsociadoDAO(getSessionHibernate(request));
			request.setAttribute("asociadoNombre",ascDAO.findById(cuentaAhorroForm.getAscId()));
			request.setAttribute("referencia", cuentaAhorroForm.getCtaCahCuentaAhorroH());
			request.setAttribute("form", cuentaAhorroForm);
			request.setAttribute(Constantes.ACCION_KEY, "/cuentaAhorro");
			return mapping.findForward("lista");
		}
	 
	 //guardar Ahorro
	 public ActionForward guardar(ActionMapping mapping, ActionForm form,
				HttpServletRequest request, HttpServletResponse response) {
		 	ActionForward target = null;
			CuentaAhorroForm cuentaAhorroForm = (CuentaAhorroForm)form;
			CtaCahCuentaAhorroDAO cuentaAhorroDAO = new CtaCahCuentaAhorroDAO(getSessionHibernate(request));
			CtaCahCuentaAhorro ctaCahCuentaAhorro = cuentaAhorroForm.getCtaCahCuentaAhorroH();
			CtaCasCuentaAsociado cuentaAsociado = new CtaCasCuentaAsociado();
			CtaCasCuentaAsociadoDAO cuentaAsociadoDAO = new CtaCasCuentaAsociadoDAO(getSessionHibernate(request));
			CtrEstEstado ctrEstEstado = new CtrEstEstado();
			CtaAscAsociadoDAO asocDAO = new CtaAscAsociadoDAO(getSessionHibernate(request));
			Double valorApertura = cuentaAhorroForm.getCtaCasCuentaAsociado().getCasValorApertura();
			Double num = valorApertura;
			Double cuota = new Double(cuentaAhorroForm.getCahCuota());
			Transaction tx = cuentaAhorroDAO.getSession().beginTransaction();
			try{
				if(!cuentaAhorroForm.isMdf()){//ingresando un nuevo registro
					//ingreso de cuenta asociado, cuenta ahorro, mov por ahorro
					/* generando codigo cuenta ahorro formato= 'letra identificadora + fecha + correl'*/
						ctrEstEstado.setEstId(9);//estado activo
						//ctaCahCuentaAhorro.setCtrEstEstado(ctrEstEstado);
						ctaCahCuentaAhorro.setCahInteresAcumulado(0.0);
						if(num>0){
							ctaCahCuentaAhorro.setCahSaldoActual(num);
						}else{
							ctaCahCuentaAhorro.setCahSaldoActual(new Double(0));
						}
						cuentaAhorroForm.setCtaCahCuentaAhorroH(ctaCahCuentaAhorro);
						cuentaAhorroDAO.save(cuentaAhorroForm.getCtaCahCuentaAhorroH());
						tx.commit();
						
						//ingresando Datos en Cuenta Asociado
						cuentaAsociado.setCasValorApertura(valorApertura);
						//SimpleDateFormat sdf = new SimpleDateFormat("dd-MM-yyyy HH:mm:ss");
						//sdf.parse(cuentaAhorroForm.getCasFechaApertura())
						cuentaAsociado.setCasFechaApertura(new Date());
						cuentaAsociado.setCtaAscAsociado(asocDAO.findById(cuentaAhorroForm.getAscId()));
						cuentaAsociado.setCtaCahCuentaAhorro(ctaCahCuentaAhorro);
						cuentaAsociado.setCtaCbaCuentaBancaria(null);
						cuentaAsociado.setCtaSegSeguros(null);
						cuentaAsociado.setCtaPrePrestamo(null);
						SimpleDateFormat sdf = new SimpleDateFormat("dd-MM-yyyy");
						Date fechaCierre = cuentaAsociado.getCasFechaApertura();
						CtaTahTipoAhorroDAO tipoAhDAO = new CtaTahTipoAhorroDAO(getSessionHibernate(request));
						CtaTahTipoAhorro tipo = tipoAhDAO.findById(ctaCahCuentaAhorro.getCtaTahTipoAhorro().getTahId());
						CtaPlmPlanMeses planMeses = tipo.getCtaPlmPlanMeses();
						
						if(planMeses != null){
							//vamos a proyectar la fecha de cierre de esta cuenta
							ElapsedTime elapser = new ElapsedTime();
							
							
							fechaCierre = elapser.obtenerFechaMeses(sdf.format(fechaCierre), planMeses.getPlmDuracion());
							cuentaAsociado.setCasFechaCierre(fechaCierre);
						}else if(tipo.getTahFechaFin()!=null){
							String fechaFin = sdf.format(tipo.getTahFechaFin());
							String anio = fechaFin.substring(6);
							String partDate = fechaFin.substring(0, 6);
							if(anio.compareTo(sdf.format(fechaCierre).substring(6))<0){
								cuentaAsociado.setCasFechaCierre(sdf.parse(partDate+sdf.format(fechaCierre).substring(6)));
							}else{
								cuentaAsociado.setCasFechaCierre(sdf.parse(fechaFin));
							}
						}else{
							cuentaAsociado.setCasFechaCierre(null);
						}
						cuentaAsociado.setCasPrincipal("N");
						cuentaAsociado.setCtrEstEstado(ctrEstEstado);
						cuentaAsociado.setCtaPxtPersonaExterna(null);
						cuentaAsociadoDAO.save(cuentaAsociado);
						tx.commit();
						
						cuentaAhorroForm.setCasCuenta(cuentaAsociado.getCasCuenta());
						if(num>0){
							//ingresando Datos en Transaccion por Cuenta
							CtaTahTipoAhorroDAO tahTipoAhorroDAO = new CtaTahTipoAhorroDAO(getSessionHibernate(request));
							CtaTxaTransaccionxcuentaAsociado transaccionCuenta = new CtaTxaTransaccionxcuentaAsociado();
							CtaTxaTransaccionxcuentaAsociadoDAO transaccionCuentaDAO = new CtaTxaTransaccionxcuentaAsociadoDAO(getSessionHibernate(request));
							transaccionCuenta.getCtaTtrTipoTransaccion().setTtrId(3);//abono por aportacion
							transaccionCuenta.setCtaCasCuentaAsociado(cuentaAsociado);
							transaccionCuenta.setTxaMonto(num);
							transaccionCuenta.setTxaComprobante(transaccionCuentaDAO.nextComprobante());
							transaccionCuenta.setTxaFecha(new Date());
							transaccionCuenta.setTxaNota("Abono por apertura de cuenta "+ tahTipoAhorroDAO.findById(cuentaAsociado.getCtaCahCuentaAhorro().getCtaTahTipoAhorro().getTahId()).getTahNombre());
							//auditoria de movimiento
							transaccionCuenta.setAudFechaCreacion(transaccionCuenta.getTxaFecha());
							transaccionCuenta.setAudFechaModificacion(transaccionCuenta.getTxaFecha());
							transaccionCuenta.setAudUsuarioCreacion(cuentaAhorroForm.getUsuarioConectado().getNombreUsuario());
							transaccionCuenta.setAudUsuarioModificacion(cuentaAhorroForm.getUsuarioConectado().getNombreUsuario());
							
							transaccionCuentaDAO.save(transaccionCuenta);
							tx.commit();
							
							//Falta hacer que se imprima un documento al realizar esta transaccion como proceso interno
							//ingresando Movimiento Ahorro
							CtaMxaMovimientoAhorroDAO movAhorroDAO = new CtaMxaMovimientoAhorroDAO(getSessionHibernate(request));
							CtaMxaMovimientoAhorro movAhorro = new CtaMxaMovimientoAhorro();
							movAhorro.setCtaCahCuentaAhorro(ctaCahCuentaAhorro);
							movAhorro.setMxaFecha(transaccionCuenta.getTxaFecha());
							
							movAhorro.setCtaTxaTransaccionxcuentaAsociado(transaccionCuenta);
							movAhorro.setMxaInteresTran(0.0);
							movAhorro.setMxaMonto(num);
							movAhorro.setMxaSaldo(num);
							
							//auditoria
							movAhorro.setAudUsuarioCreacion(cuentaAhorroForm.getUsuarioConectado().getNombreUsuario());
							movAhorro.setAudUsuarioModificacion(cuentaAhorroForm.getUsuarioConectado().getNombreUsuario());
							movAhorro.setAudFechaCreacion(movAhorro.getMxaFecha());
							movAhorro.setAudFechaModificacion(movAhorro.getMxaFecha());
							
							movAhorroDAO.save(movAhorro);
							tx.commit();
							
							//partida generada
							PartidaAutomatica partidaAutomatica =  new PartidaAutomatica();
							partidaAutomatica.crearPartidaAutomatica("1;2;"+ctaCahCuentaAhorro.getCtaTahTipoAhorro().getTahId()+";"+
									transaccionCuenta.getCtaTtrTipoTransaccion().getTtrId()+";0;-1", num, 
									cuentaAhorroForm.getUsuarioConectado().getNombreUsuario(), 1, null, null, null,request);
							cuentaAhorroForm.setComprobante(transaccionCuenta.getTxaComprobante());
							cuentaAhorroForm.setApertura(true);
							cuentaAhorroForm.setCasCuenta(cuentaAsociado.getCasCuenta());
							target = lista(mapping, form, request, response);
						}else{
							target = forwardToBeneficiarios(mapping, form, request, response);
							/*request.getSession().setAttribute("asociadoIdAportacion",cuentaAsociado.getCtaAscAsociado().getAscId());
							request.getSession().setAttribute("porcent",1);
							BeneficiariosForm beneForm = new BeneficiariosForm();
							beneForm.setCuentaX(cuentaAsociado.getCasCuenta());
							request.setAttribute("beneficiariosForm", beneForm);
							target = mapping.findForward("beneficiariosLista");*/
						}
						/*request.getSession().setAttribute("asociadoIdAportacion",cuentaAsociado.getCtaAscAsociado().getAscId());
						request.getSession().setAttribute("porcent",1);
						BeneficiariosForm beneForm = new BeneficiariosForm();
						beneForm.setCuentaX(cuentaAsociado.getCasCuenta());
						request.setAttribute("beneficiariosForm", beneForm);
						target = mapping.findForward("beneficiariosLista");*/
						mensajes("exito.ingresoCuentaAhExito",request);
				}else{//modificando un registro
					if(cuota >= 0){
						List list = cuentaAsociadoDAO.findByProperty("ctaCahCuentaAhorro.cahId", cuentaAhorroForm.getCahId());
						cuentaAsociado = (CtaCasCuentaAsociado) list.get(0);
						ctaCahCuentaAhorro = cuentaAhorroForm.getCtaCahCuentaAhorroH();
						cuentaAsociado.getCtaCahCuentaAhorro().setCahCuota(ctaCahCuentaAhorro.getCahCuota());
						cuentaAsociadoDAO.merge(cuentaAsociado);
					/*	ctrEstEstado.setEstId(9);
						//ctaCahCuentaAhorro.setCtrEstEstado(ctrEstEstado);
						ctaCahCuentaAhorro.setCahInteresAcumulado(0.0);
						cuentaAhorroDAO.merge(ctaCahCuentaAhorro);
						cuentaAsociado.setCtrEstEstado(ctrEstEstado);
						cuentaAsociado.setCtaPxtPersonaExterna(null);
						cuentaAsociadoDAO.merge(cuentaAsociado);*/
						mensajes("exito.ModificacionCuentaAhExito",request);
					}
					/*SOLO VISUALIZACION, SI SE MODIFICA CUOTA PODRIA EXISTIR MODIFICACION, SINO NO*/
					target= lista(mapping, form, request, response);
					//cuentaAhorroForm.setMdf(false);
				}	
				tx.commit();
			}catch(Exception e){
				tx.rollback();
				e.printStackTrace();
			}finally{
				cuentaAhorroDAO.getSession().flush();
				cuentaAhorroDAO.getSession().clear();
				
			}
			return target;
		} 
	 
	 public ActionForward cierreCuentaDatos(ActionMapping mapping, ActionForm form,
				HttpServletRequest request, HttpServletResponse response) {
		 CuentaAhorroForm cuentaAForm = (CuentaAhorroForm)form;
		 CtaCasCuentaAsociadoDAO ctaCasCuentaAsociadoDAO = new CtaCasCuentaAsociadoDAO(getSessionHibernate(request));
		 CtaCahCuentaAhorroDAO cuentaAhorroDAO = new CtaCahCuentaAhorroDAO(getSessionHibernate(request));
		 CtaAscAsociadoDAO asocDAO = new CtaAscAsociadoDAO(getSessionHibernate(request));
		 cuentaAForm.setCtaCahCuentaAhorroH(cuentaAhorroDAO.findById(cuentaAForm.getCahId()));
		 cuentaAForm.setCtaAscAsociado(asocDAO.findById(cuentaAForm.getAscId()));
		 cuentaAForm.setCtaCasCuentaAsociado((CtaCasCuentaAsociado)
				 	ctaCasCuentaAsociadoDAO.findByProperty("ctaCahCuentaAhorro.cahId", cuentaAForm.getCahId()).get(0));
		 request.setAttribute(LIST_CUENTAS, 
				 			ctaCasCuentaAsociadoDAO.findCuentasSinPrestamos(
				 					cuentaAForm.getAscId(),9,cuentaAForm.getCahId()));
		 request.setAttribute("asociadoNombre", cuentaAForm.getCtaAscAsociado());
		 request.setAttribute("referencia", cuentaAForm.getCtaCahCuentaAhorroH());
		 request.setAttribute("form", cuentaAForm);
		 Double penalidad = calculoPenalidad(cuentaAForm.getCtaCahCuentaAhorroH(),request);
		 request.setAttribute("penalidad", penalidad);
		 request.setAttribute(Constantes.ACCION_KEY, "/cuentaAhorro");
		 return mapping.findForward("cierreDeCuentas");
	 }
	 
	 public ActionForward cierreCuentaAhorro(ActionMapping mapping, ActionForm form,
				HttpServletRequest request, HttpServletResponse response) {
		 CuentaAhorroForm cuentaAForm = (CuentaAhorroForm)form;
		 CtaCahCuentaAhorroDAO cuentaAhorroDAO = new CtaCahCuentaAhorroDAO(getSessionHibernate(request));
		 CtaAscAsociadoDAO asocDAO = new CtaAscAsociadoDAO(getSessionHibernate(request));
		 CtaCasCuentaAsociadoDAO casCuentaAsocDAO = new CtaCasCuentaAsociadoDAO(getSessionHibernate(request));
		 
		 cuentaAForm.setCtaCahCuentaAhorroH(cuentaAhorroDAO.findById(cuentaAForm.getCahId()));
		 cuentaAForm.setCtaAscAsociado(asocDAO.findById(cuentaAForm.getAscId()));
		 List lstCuAsoc = casCuentaAsocDAO.findByProperty("ctaCahCuentaAhorro.cahId", cuentaAForm.getCahId());
		 CtaCasCuentaAsociado cuentaAsociadoC = (CtaCasCuentaAsociado) lstCuAsoc.get(0);
		 
		 Transaction tx = cuentaAhorroDAO.getSession().beginTransaction();
		 
		 try{
				/*      Modificacion de cuenta de Ahorro a inactiva     */
				CtaCahCuentaAhorro ctaCahCuentaAhorro = cuentaAForm.getCtaCahCuentaAhorroH();
				CtaMxaMovimientoAhorroDAO movimientoAhDAO = new CtaMxaMovimientoAhorroDAO(getSessionHibernate(request));
				CtaTxaTransaccionxcuentaAsociadoDAO transaccionDAO = new CtaTxaTransaccionxcuentaAsociadoDAO(getSessionHibernate(request));
				CtrEstEstadoDAO ctrEstadoDAO = new CtrEstEstadoDAO(getSessionHibernate(request));
				Date FechaTrans = new Date();
				Long comprobanteTrans = new Long(0);
				comprobanteTrans = transaccionDAO.nextComprobante(); 
				
				CtrEstEstado ctrEstado = new CtrEstEstado();
				List lstEstadoCu = ctrEstadoDAO.findByProperty("ctrTusTipoUso.tusCodigo", "APORT");
				ctrEstado = (CtrEstEstado)lstEstadoCu.get(1);//estado inactivo
				cuentaAsociadoC.setCtrEstEstado(ctrEstado);
				
				/*      Verificacion y calculo de intereses     */
				Double interesGenerado = new Double(0);
				interesGenerado = calculoInteresTransaccion(cuentaAForm.getCahId(), new Date(),request);
				if(interesGenerado > 0){
					ctaCahCuentaAhorro.setCahInteresAcumulado(ctaCahCuentaAhorro.getCahInteresAcumulado()+interesGenerado);
				}
				//AQUI HACER MOVIMIENTO POR INTERESES CAPITALIZADOS
				if(ctaCahCuentaAhorro.getCahInteresAcumulado()>0){
					ctaCahCuentaAhorro.setCahSaldoActual(ctaCahCuentaAhorro.getCahSaldoActual()+
							 ctaCahCuentaAhorro.getCahInteresAcumulado());
					CtaTxaTransaccionxcuentaAsociado transaccion = new CtaTxaTransaccionxcuentaAsociado();
							
					transaccion.getCtaTtrTipoTransaccion().setTtrId(16);//CAPITALIZACION DE INTERESES
					transaccion.setCtaCasCuentaAsociado(cuentaAsociadoC);
					transaccion.setTxaMonto(ctaCahCuentaAhorro.getCahInteresAcumulado());
					transaccion.setTxaComprobante(comprobanteTrans);
					transaccion.setTxaFecha(FechaTrans);
					
					//auditoria de movimiento
					transaccion.setAudFechaCreacion(transaccion.getTxaFecha());
					transaccion.setAudFechaModificacion(transaccion.getTxaFecha());
					transaccion.setAudUsuarioCreacion(cuentaAForm.getUsuarioConectado().getNombreUsuario());
					transaccion.setAudUsuarioModificacion(cuentaAForm.getUsuarioConectado().getNombreUsuario());
					
					transaccionDAO.save(transaccion);
								
					//registro de movimiento de capitalizacion en movimientos de ahorro
					CtaMxaMovimientoAhorro movimientoAhorro = new CtaMxaMovimientoAhorro();
					movimientoAhorro.setMxaFecha(transaccion.getTxaFecha());
					movimientoAhorro.setCtaTxaTransaccionxcuentaAsociado(transaccion);
					movimientoAhorro.setCtaCahCuentaAhorro(ctaCahCuentaAhorro);
					movimientoAhorro.setMxaInteresTran(0.0);
					movimientoAhorro.setMxaMonto(transaccion.getTxaMonto());
					movimientoAhorro.setMxaSaldo(ctaCahCuentaAhorro.getCahSaldoActual());
					
					//auditoria
					movimientoAhorro.setAudUsuarioCreacion(cuentaAForm.getUsuarioConectado().getNombreUsuario());
					movimientoAhorro.setAudUsuarioModificacion(cuentaAForm.getUsuarioConectado().getNombreUsuario());
					movimientoAhorro.setAudFechaCreacion(movimientoAhorro.getMxaFecha());
					movimientoAhorro.setAudFechaModificacion(movimientoAhorro.getMxaFecha());
					
					movimientoAhDAO.save(movimientoAhorro);
					
					//partida contable por capitalizacion de intereses 
					PartidaAutomatica partidaAutomatica =  new PartidaAutomatica();
					partidaAutomatica.crearPartidaAutomatica("1;2;"+ctaCahCuentaAhorro.getCtaTahTipoAhorro().getTahId()+";"+transaccion.getCtaTtrTipoTransaccion().getTtrId()+";1;-1", 
							transaccion.getTxaMonto(), cuentaAForm.getUsuarioConectado().getNombreUsuario(), 1, null, null, null,request);
				}
				ctaCahCuentaAhorro.setCahInteresAcumulado(0.0);
				Double penalidad=0.00;
				if(cuentaAForm.isOpPenalidad() && ctaCahCuentaAhorro.getCahSaldoActual()>0){
					//si el usuario decidio si calcular la penalidad
					//verificacion si hay penalidad
					
					ElapsedTime elapsedT = new ElapsedTime();
					CtrParParametrosDAO parametroDAO = new CtrParParametrosDAO(getSessionHibernate(request));
					CtrParParametros parametro = parametroDAO.findById("DIAS_ANTERIORIDAD_AVISO_AHORRO");
					if(elapsedT.fechaMenor(FechaTrans,cuentaAsociadoC.getCasFechaCierre())==true |  
						elapsedT.fechaMenor(elapsedT.obtenerFecha(cuentaAsociadoC.getCasFechaCierre(), 
																  parametro.getParValorNumber().intValue()),
																  FechaTrans)){
						penalidad = calculoPenalidad(cuentaAForm.getCtaCahCuentaAhorroH(),request);
						if(penalidad > 0){
							//lo que se le quito de penalidad va a una cuenta en contabilidad, pendiente
							ctaCahCuentaAhorro.setCahSaldoActual(ctaCahCuentaAhorro.getCahSaldoActual()-penalidad);
							CtaTxaTransaccionxcuentaAsociado tranP = new CtaTxaTransaccionxcuentaAsociado();
							
							tranP.getCtaTtrTipoTransaccion().setTtrId(38);//Cargo por Penalidad en Ahorros
							tranP.setCtaCasCuentaAsociado(cuentaAsociadoC);
							tranP.setTxaMonto(penalidad);
							tranP.setTxaComprobante(comprobanteTrans);
							tranP.setTxaFecha(FechaTrans);
							
							//auditoria
							tranP.setAudFechaCreacion(tranP.getTxaFecha());
							tranP.setAudFechaModificacion(tranP.getTxaFecha());
							tranP.setAudUsuarioCreacion(cuentaAForm.getUsuarioConectado().getNombreUsuario());
							tranP.setAudUsuarioModificacion(cuentaAForm.getUsuarioConectado().getNombreUsuario());
							
							transaccionDAO.save(tranP);
										
							//registro por Penalidad en Ahorros
							CtaMxaMovimientoAhorro movimientoAhorroP = new CtaMxaMovimientoAhorro();
							movimientoAhorroP.setMxaFecha(tranP.getTxaFecha());
							movimientoAhorroP.setCtaTxaTransaccionxcuentaAsociado(tranP);
							movimientoAhorroP.setCtaCahCuentaAhorro(ctaCahCuentaAhorro);
							movimientoAhorroP.setMxaInteresTran(0.0);
							movimientoAhorroP.setMxaMonto(tranP.getTxaMonto());
							movimientoAhorroP.setMxaSaldo(ctaCahCuentaAhorro.getCahSaldoActual());
							
							//auditoria
							movimientoAhorroP.setAudUsuarioCreacion(cuentaAForm.getUsuarioConectado().getNombreUsuario());
							movimientoAhorroP.setAudUsuarioModificacion(cuentaAForm.getUsuarioConectado().getNombreUsuario());
							movimientoAhorroP.setAudFechaCreacion(movimientoAhorroP.getMxaFecha());
							movimientoAhorroP.setAudFechaModificacion(movimientoAhorroP.getMxaFecha());
							
							movimientoAhDAO.save(movimientoAhorroP);
							
							//partida contable por Penalidad en Ahorros
							CtaCasCuentaAsociado cuentaABono = new CtaCasCuentaAsociado();
							cuentaABono = casCuentaAsocDAO.findById(cuentaAForm.getCtaCasCuentaAsociado().getCasCuenta());
							
							if(cuentaABono.getCtaCahCuentaAhorro()!= null){
								PartidaAutomatica partidaAutomatica =  new PartidaAutomatica();
							partidaAutomatica.crearPartidaAutomatica("1;2;"+ctaCahCuentaAhorro.getCtaTahTipoAhorro().getTahId()+";"+tranP.getCtaTtrTipoTransaccion().getTtrId()+";0;-1", 
									tranP.getTxaMonto(), cuentaAForm.getUsuarioConectado().getNombreUsuario(), 1, null, null, null,request);
							}
						}
						
					}
				}
				
				
				cuentaAhorroDAO.merge(ctaCahCuentaAhorro);
				
				
				cuentaAsociadoC.setCtrEstEstado(ctrEstado);
				casCuentaAsocDAO.merge(cuentaAsociadoC);
				
				if(ctaCahCuentaAhorro.getCahSaldoActual()>0){
					/*	vamos a cargar la cuenta de ahorros para darselo al asociado 	*/
					CtaTxaTransaccionxcuentaAsociado transaccionC = new CtaTxaTransaccionxcuentaAsociado();
					CtaTxaTransaccionxcuentaAsociado transaccionA = new CtaTxaTransaccionxcuentaAsociado();
					CtaCasCuentaAsociado cuentaABono = new CtaCasCuentaAsociado();
							
					//cargo a la cuenta de ahorro
					transaccionC.getCtaTtrTipoTransaccion().setTtrId(4);//cargo por cierre de cuenta
					transaccionC.setCtaCasCuentaAsociado(cuentaAsociadoC);
					transaccionC.setTxaMonto(ctaCahCuentaAhorro.getCahSaldoActual());
					transaccionC.setTxaComprobante(comprobanteTrans);
					transaccionC.setTxaFecha(FechaTrans);
					
					//auditoria de movimiento
					transaccionC.setAudFechaCreacion(transaccionC.getTxaFecha());
					transaccionC.setAudFechaModificacion(transaccionC.getTxaFecha());
					transaccionC.setAudUsuarioCreacion(cuentaAForm.getUsuarioConectado().getNombreUsuario());
					transaccionC.setAudUsuarioModificacion(cuentaAForm.getUsuarioConectado().getNombreUsuario());
					String nota1 = " CARGO POR CIERRE DE CUENTA ";
					CtaNotNotasDAO notasDAO = new CtaNotNotasDAO(getSessionHibernate(request));
					Transaction txnot = notasDAO.getSession().beginTransaction();
					CtaNotNotas nota = new CtaNotNotas();
					nota.setNotId(notasDAO.nextId());
					nota.setCasCuenta(null);
					nota.setCtaTntTipoNota(null);
					nota.setNotFecha(new Date());
					nota.setNotNota(nota1);
					nota.setNotCampo(nota1);
					notasDAO.save(nota);
					txnot.commit();
					transaccionC.setCtaNotNotas(nota);
					transaccionC.setTxaNota(nota1);
					transaccionDAO.save(transaccionC);
								
					//registro de movimiento de capitalizacion en movimientos de ahorro
					CtaMxaMovimientoAhorro movimientoAhorroC = new CtaMxaMovimientoAhorro();
					movimientoAhorroC.setMxaFecha(transaccionC.getTxaFecha());
					movimientoAhorroC.setCtaTxaTransaccionxcuentaAsociado(transaccionC);
					movimientoAhorroC.setCtaCahCuentaAhorro(ctaCahCuentaAhorro);
					movimientoAhorroC.setMxaInteresTran(0.0);
					movimientoAhorroC.setMxaMonto(transaccionC.getTxaMonto());
					movimientoAhorroC.setMxaSaldo(0.0);
					
					//auditoria
					movimientoAhorroC.setAudUsuarioCreacion(cuentaAForm.getUsuarioConectado().getNombreUsuario());
					movimientoAhorroC.setAudUsuarioModificacion(cuentaAForm.getUsuarioConectado().getNombreUsuario());
					movimientoAhorroC.setAudFechaCreacion(movimientoAhorroC.getMxaFecha());
					movimientoAhorroC.setAudFechaModificacion(movimientoAhorroC.getMxaFecha());
					
					movimientoAhDAO.save(movimientoAhorroC);
					
					cuentaABono = casCuentaAsocDAO.findById(cuentaAForm.getCtaCasCuentaAsociado().getCasCuenta());
					
					//La partida por el cargo a los ahorros solo se debe hacer si no se ha seleccionado abono a cuenta bancaria
					if(cuentaABono.getCtaCahCuentaAhorro()!= null){
						//partida contable por cargo a la cuenta de ahorro
						PartidaAutomatica partidaAutomatica =  new PartidaAutomatica();
						partidaAutomatica.crearPartidaAutomatica("1;2;"+ctaCahCuentaAhorro.getCtaTahTipoAhorro().getTahId()+";"+transaccionC.getCtaTtrTipoTransaccion().getTtrId()+";0;-1", 
								transaccionC.getTxaMonto(), cuentaAForm.getUsuarioConectado().getNombreUsuario(), 1, null, null, null,request);
					}
					
					//abono por transferencia de la cuenta de ahorro a cualquier otra.
					//cuentaABono = cuentaAForm.getCtaCasCuentaAsociado();
					
					transaccionA.getCtaTtrTipoTransaccion().setTtrId(5);//Abono por transferencia
					transaccionA.setCtaCasCuentaAsociado(cuentaABono);
					transaccionA.setTxaMonto(ctaCahCuentaAhorro.getCahSaldoActual());
					transaccionA.setTxaComprobante(transaccionC.getTxaComprobante());
					transaccionA.setTxaFecha(transaccionC.getTxaFecha());
					
					//auditoria de movimiento
					transaccionA.setAudFechaCreacion(transaccionA.getTxaFecha());
					transaccionA.setAudFechaModificacion(transaccionA.getTxaFecha());
					transaccionA.setAudUsuarioCreacion(cuentaAForm.getUsuarioConectado().getNombreUsuario());
					transaccionA.setAudUsuarioModificacion(cuentaAForm.getUsuarioConectado().getNombreUsuario());
					if(cuentaABono.getCtaCbaCuentaBancaria()!=null){
						transaccionA.setTxaEstado("P");//estado de pendiente de transferencia electronica
					}
					transaccionDAO.save(transaccionA);
								
					//actualizacion en la cuenta abonada
					if(cuentaABono.getCtaCahCuentaAhorro()!= null){
						String letraId = cuentaABono.getCtaCahCuentaAhorro().getCahId().substring(0,1);
						CtaCahCuentaAhorro cuentaAhorroA = new CtaCahCuentaAhorro();
						cuentaAhorroA = cuentaAhorroDAO.findById(cuentaABono.getCtaCahCuentaAhorro().getCahId());
						Double saldoNuevoConAbono = cuentaAhorroA.getCahSaldoActual()+transaccionC.getTxaMonto();
						cuentaAhorroA.setCahSaldoActual(saldoNuevoConAbono);
						Double interesAbono = new Double(0);
						if(letraId.equals("B")){
							//Ahorro generar interes acumulado
							CuentaAhorroForm abonaCuentaForm = new CuentaAhorroForm();
							abonaCuentaForm.setCtaCahCuentaAhorroH(cuentaAhorroA);
							interesAbono = calculoInteresTransaccion(abonaCuentaForm.getCahId(),new Date(),request);
							cuentaAhorroA.setCahInteresAcumulado(cuentaAhorroA.getCahInteresAcumulado()+interesAbono);
							/*PARTIDA POR ABONO POR TRANSFERENCIA*/
							
						}
						cuentaAhorroDAO.merge(cuentaAhorroA);
						PartidaAutomatica partidaAutomatica =  new PartidaAutomatica();
						if(cuentaAhorroA.getCahId().substring(0,1).equals("A"))
								partidaAutomatica.crearPartidaAutomatica("1;1;0;"+5+";0;-1", 
									transaccionA.getTxaMonto(), cuentaAForm.getUsuarioConectado().getNombreUsuario(), 1, null, null, null,request);
							
						else	partidaAutomatica.crearPartidaAutomatica("1;2;"+cuentaAhorroA.getCtaTahTipoAhorro().getTahId()+";"+5+";0;-1", 
									transaccionA.getTxaMonto(), cuentaAForm.getUsuarioConectado().getNombreUsuario(), 1, null, null, null,request);
						
						CtaMxaMovimientoAhorro movimientoAhorroA = new CtaMxaMovimientoAhorro();
						movimientoAhorroA.setMxaFecha(transaccionA.getTxaFecha());
						movimientoAhorroA.setCtaTxaTransaccionxcuentaAsociado(transaccionA);
						movimientoAhorroA.setCtaCahCuentaAhorro(cuentaAhorroA);
						movimientoAhorroA.setMxaInteresTran(interesAbono);
						movimientoAhorroA.setMxaMonto(transaccionA.getTxaMonto());
						movimientoAhorroA.setMxaSaldo(cuentaAhorroA.getCahSaldoActual());
						
						//auditoria
						movimientoAhorroA.setAudUsuarioCreacion(cuentaAForm.getUsuarioConectado().getNombreUsuario());
						movimientoAhorroA.setAudUsuarioModificacion(cuentaAForm.getUsuarioConectado().getNombreUsuario());
						movimientoAhorroA.setAudFechaCreacion(movimientoAhorroA.getMxaFecha());
						movimientoAhorroA.setAudFechaModificacion(movimientoAhorroA.getMxaFecha());
						
						movimientoAhDAO.save(movimientoAhorroA);
											
					}else if(cuentaABono.getCtaCbaCuentaBancaria()!=null){
						/*PARTIDA POR ABONO POR TRANSFERENCIA*/
						enviarAsolTransBanc(transaccionA, movimientoAhorroC, cuentaABono.getCtaCbaCuentaBancaria().getCbaId(), penalidad,request);
						/*PartidaAutomatica.crearPartidaAutomatica("1;5;"+cuentaABono.getCtaCbaCuentaBancaria().getCtaTcuTipoCuenta().getTcuId()+";"+5+";0;-1", 
								transaccionA.getTxaMonto(), cuentaAForm.getUsuarioConectado().getNombreUsuario(), 1, null, null, null);*/
						
					}
					
					ctaCahCuentaAhorro.setCahSaldoActual(0.00);
					cuentaAhorroDAO.merge(ctaCahCuentaAhorro);					
				}
			}catch(Exception e){
				tx.rollback();
				e.printStackTrace();
			}finally{
				tx.commit();
				cuentaAhorroDAO.getSession().flush();
				cuentaAhorroDAO.getSession().clear();
			}
			//return mapping.findForward("regresar");
			return toCuentasAsociadoAh(mapping, cuentaAForm, request, response);
	 }
	 
	 private void enviarAsolTransBanc(CtaTxaTransaccionxcuentaAsociado txa,
				CtaMxaMovimientoAhorro movimientoAhorro, String cuentaBan, double penalidad,HttpServletRequest request) {
			CtaStbSolTransBancDAO solTransBancDAO = new CtaStbSolTransBancDAO(getSessionHibernate(request));
			CtaStbSolTransBanc solTransBanc = new CtaStbSolTransBanc();
			CtaCahCuentaAhorroDAO cuentaAhorroDAO = new CtaCahCuentaAhorroDAO(getSessionHibernate(request));
			CtaCahCuentaAhorro cuentaAhorro = cuentaAhorroDAO.findById(movimientoAhorro.getCtaCahCuentaAhorro().getCahId());
			solTransBanc.setCtaCahCuentaAhorro(cuentaAhorro);
			solTransBanc.setStbEstado("N");
			solTransBanc.setStbFechaSol(new Date());
			solTransBanc.setStbMonto(movimientoAhorro.getMxaMonto());
			CtaCasCuentaAsociadoDAO casDao = new CtaCasCuentaAsociadoDAO(getSessionHibernate(request));
			CtaCasCuentaAsociado cas = casDao.findbyCahId(cuentaAhorro.getCahId());
			CtaAscAsociadoDAO asociadoDAO = new CtaAscAsociadoDAO(getSessionHibernate(request));
			CtaAscAsociado asociado = asociadoDAO.findById(cas.getCtaAscAsociado().getAscId());
			String nombreAsociado = asociado.getSecPerPersona().getPerPrimerNombre() + " " +
				asociado.getSecPerPersona().getPerSegundoNombre() + " " +
				asociado.getSecPerPersona().getPerPrimerApellido() + " " +
				asociado.getSecPerPersona().getPerSegundoApellido();
			solTransBanc.setStbNombreAsociado(nombreAsociado);
			solTransBanc.setStbRazon("Deposito pago ahorros electronicos");
			CtaCbaCuentaBancariaDAO bancariaDAO = new CtaCbaCuentaBancariaDAO(getSessionHibernate(request));
			CtaCbaCuentaBancaria bancaria = bancariaDAO.findById(cuentaBan);
			solTransBanc.setCtaCbaCuentaBancaria(bancaria);
			solTransBanc.setStbTipoAhorro(bancaria.getCtaTcuTipoCuenta().getTcuNombre());
			solTransBanc.setInvPcbProveedorCuentaBancaria(null);
			solTransBanc.setStbPenalidad(penalidad);
			solTransBancDAO.save(solTransBanc);
			
			Transaction tx = solTransBancDAO.getSession().beginTransaction();
			tx.commit();
			solTransBancDAO.getSession().flush();
			solTransBancDAO.getSession().clear();
		}
	 
	 public Double calculoInteresTransaccion(String cahId, Date fecha,HttpServletRequest request){
			Double totalInteres = 0.0;
			Double interesGenerado = 0.0;
			CtaMxaMovimientoAhorroDAO movimAhorroDAO = new CtaMxaMovimientoAhorroDAO(getSessionHibernate(request));
			CtaMxaMovimientoAhorro movAhorro = new CtaMxaMovimientoAhorro();
			CtaCahCuentaAhorroDAO cuAhorroDAO = new CtaCahCuentaAhorroDAO(getSessionHibernate(request));
			CtaCahCuentaAhorro cuentaAhorro = cuAhorroDAO.findById(cahId);
			
//			if(cuentaAhorro.getCahInteresAcumulado()!=null){
//				totalInteres += cuentaAhorro.getCahInteresAcumulado();
//			}
			movAhorro=(CtaMxaMovimientoAhorro)movimAhorroDAO.findUltimoMovimientoAhorro(cuentaAhorro.getCahId());
			//si no hay ultimo movimiento
			CtrParParametrosDAO parametrosDAO = new CtrParParametrosDAO(getSessionHibernate(request));
			Date fechaSinMov = parametrosDAO.findById("INICIO_ACUMULACION_INTERESES").getParValorDate();
			Date fechaUltimoMov;
			if(movAhorro == null){
				fechaUltimoMov = fechaSinMov; 
			}else{
				fechaUltimoMov = movAhorro.getMxaFecha();
			}
			IntereseYMora iYm = new IntereseYMora();
			Date fechaX = iYm.noTime(fechaUltimoMov);
			if(!fechaX.equals(iYm.noTime(new Date()))){

				//if(movAhorro!=null){
					ElapsedTime elapsed = new ElapsedTime();
					GregorianCalendar greCalendarI = new GregorianCalendar();
					GregorianCalendar greCalendarF = new GregorianCalendar();
					SimpleDateFormat sdf = new SimpleDateFormat("dd-MM-yyyy");
					try {
						//greCalendarI = ElapsedTime.dTGC(sdf.parse(sdf.format(movAhorro.getMxaFecha())));
						greCalendarI = ElapsedTime.dTGC(sdf.parse(sdf.format(fechaUltimoMov)));
					} catch (ParseException e) {
						// TODO Auto-generated catch block
						e.printStackTrace();
					}
					greCalendarF = ElapsedTime.dTGC(new Date());
					greCalendarF.set(Calendar.MILLISECOND, 0);
					greCalendarF.set(Calendar.SECOND, 0);
					greCalendarF.set(Calendar.MINUTE, 0);
					greCalendarF.set(Calendar.HOUR_OF_DAY, 0);
					
					greCalendarI.set(Calendar.MILLISECOND, 0);
					greCalendarI.set(Calendar.SECOND, 0);
					greCalendarI.set(Calendar.MINUTE, 0);
					greCalendarI.set(Calendar.HOUR_OF_DAY, 0);
					
					CtrParParametrosDAO parametroDAO = new CtrParParametrosDAO(getSessionHibernate(request));
					CtrParParametros parametroAnio = parametroDAO.findById("ANHO_CALENDARIO");
					//int numDiasTranscurridos = elapsed.getDays(greCalendarI,greCalendarF);
					int numDiasTranscurridos = diferenciaEnDias(fechaUltimoMov,new Date()); 
					CtaTahTipoAhorro tah = new CtaTahTipoAhorro();
					CtaTahTipoAhorroDAO tahDAO = new CtaTahTipoAhorroDAO(getSessionHibernate(request));
					tah = tahDAO.findById(cuentaAhorro.getCtaTahTipoAhorro().getTahId());
					Double interes = tah.getCtaTinTasaInteres().getTinTasa()/100;
					
					Double saldoActual = cuentaAhorro.getCahSaldoActual();
					/**
					 * 
					 * NUMERO DE DIAS AUMENTADO EN 2 
					 * 
					 * */
					numDiasTranscurridos = numDiasTranscurridos+2;
					;
					
					
					System.out.println("Días utilizados para capitalizacion: "+numDiasTranscurridos);
					System.out.println("SaldoActual : "+saldoActual);
					System.out.println("Interes: "+interes);
					System.out.println("Anio "+parametroAnio.getParValorNumber());
					
					/**
					 * DELETE THOSE LINES
					 * 
					 * */
					
					interesGenerado = (saldoActual*interes)*numDiasTranscurridos/parametroAnio.getParValorNumber();
					
					System.out.println("Interes generado: "+interesGenerado);
				//}
			}
			totalInteres += interesGenerado;
			if(true);
			return totalInteres;
	}
	 
		public static int diferenciaEnDias(Date fechainicial, Date fechafinal) {
			DateFormat df = DateFormat.getDateInstance(DateFormat.MEDIUM);
			String fi = df.format(fechainicial);
			try {
				fechainicial = df.parse(fi);
			} catch (ParseException ex) {
			}
			String fechafinalstring = df.format(fechafinal);
			try {
				fechafinal = df.parse(fechafinalstring);
			} catch (ParseException ex) {

			}
			long fechainicialms = fechainicial.getTime();
			long fechafinalms = fechafinal.getTime();
			long diferencia = fechafinalms - fechainicialms;
			double dias = Math.floor(diferencia / (1000 * 60 * 60 * 24));
			return ((int) dias);
		}
	 
	 
	 
	 
	 public Double calculoPenalidad(CtaCahCuentaAhorro ahorro,HttpServletRequest request){
	 		CtaCahCuentaAhorro ctaCahCuentaAhorro = new CtaCahCuentaAhorro();
		 	ctaCahCuentaAhorro = ahorro;//form.getCtaCahCuentaAhorroH();
			CtaCasCuentaAsociadoDAO cuentaAsociadoDAO = new CtaCasCuentaAsociadoDAO(getSessionHibernate(request));
			CtaCasCuentaAsociado  ctaCasCuentaAsociado = new CtaCasCuentaAsociado();
			ctaCasCuentaAsociado = (CtaCasCuentaAsociado)cuentaAsociadoDAO.findByProperty("ctaCahCuentaAhorro.cahId", ahorro.getCahId()).get(0);//form.getCahId()).get(0);
			
			ElapsedTime elapsed = new ElapsedTime();
			Double penalidad = new Double(0);
			if(ahorro.getCtaTahTipoAhorro().getCtaPlmPlanMeses() != null 
					|| ahorro.getCtaTahTipoAhorro().getTahFechaFin() != null){
			if(ctaCasCuentaAsociado.getCasFechaCierre()!=null){
				GregorianCalendar greCalendarI = ElapsedTime.dTGC(ahorro.getCtaTahTipoAhorro().getTahFechaFin());//inicial
				GregorianCalendar greCalendarF = ElapsedTime.dTGC(new Date());//final
				/*greCalendarI.setGregorianChange(ctaCasCuentaAsociado.getCasFechaCierre());
				greCalendarF.setGregorianChange(new Date());
				if(ctaCahCuentaAhorro.getCtaTahTipoAhorro().getCtaPlmPlanMeses() != null || 
						ctaCahCuentaAhorro.getCtaTahTipoAhorro().getTahFechaFin() != null){
					if(ctaCasCuentaAsociado.getCasFechaCierre()!=null){
						greCalendarF.set(Calendar.MILLISECOND, 0);
						greCalendarF.set(Calendar.SECOND, 0);
						greCalendarF.set(Calendar.MINUTE, 0);
						greCalendarF.set(Calendar.HOUR_OF_DAY, 0);
						
						greCalendarI.set(Calendar.MILLISECOND, 0);
						greCalendarI.set(Calendar.SECOND, 0);
						greCalendarI.set(Calendar.MINUTE, 0);
						greCalendarI.set(Calendar.HOUR_OF_DAY, 0);
						*/
						
						int diasParaPenalidad= elapsed.getDays(greCalendarF, greCalendarI);
						
						if(diasParaPenalidad>0){
							//calculo de penalidad = (saldo a reti.*dias faltan.*tasa mas alta de int.)/aÃ±o calen.
							CtaTinTasaInteresDAO ctaTinTasaInteresDAO = new CtaTinTasaInteresDAO(getSessionHibernate(request));
							CtrParParametrosDAO ctrParParametrosDAO = new CtrParParametrosDAO(getSessionHibernate(request));
							Double saldoActual = ctaCahCuentaAhorro.getCahSaldoActual();
							Double tasa = (double) ctaTinTasaInteresDAO.maximaTasadeInteresPrestamosActivos()/100;
							Double anhoCal = ctrParParametrosDAO.findById("ANHO_CALENDARIO").getParValorNumber(); 
							penalidad = (saldoActual * diasParaPenalidad * tasa)/ anhoCal;
						}
					}
//				}
//			}
			}
			if(penalidad > 0){
				penalidad =	Math.floor(penalidad*Math.pow(10, 2))/Math.pow(10, 2);
			}
			return penalidad;
	 }
	 
	 /*calculo penalidad sobrecargado para poder pasar como parametro el monto a ser retirado
	  *sobre el cual se calcula la penalidad
	  */
	 public Double calculoPenalidad(CtaCahCuentaAhorro ahorro, double monto,HttpServletRequest request){
	 		CtaCahCuentaAhorro ctaCahCuentaAhorro = new CtaCahCuentaAhorro();
		 	ctaCahCuentaAhorro = ahorro;//form.getCtaCahCuentaAhorroH();
			CtaCasCuentaAsociadoDAO cuentaAsociadoDAO = new CtaCasCuentaAsociadoDAO(getSessionHibernate(request));
			CtaCasCuentaAsociado  ctaCasCuentaAsociado = new CtaCasCuentaAsociado();
			ctaCasCuentaAsociado = (CtaCasCuentaAsociado)cuentaAsociadoDAO.findByProperty("ctaCahCuentaAhorro.cahId", ahorro.getCahId()).get(0);//form.getCahId()).get(0);
			
			ElapsedTime elapsed = new ElapsedTime();
			Double penalidad = new Double(0);
			if(ahorro.getCtaTahTipoAhorro().getCtaPlmPlanMeses() != null 
					|| ahorro.getCtaTahTipoAhorro().getTahFechaFin() != null){
			if(ctaCasCuentaAsociado.getCasFechaCierre()!=null){
				GregorianCalendar greCalendarI = ElapsedTime.dTGC(ahorro.getCtaTahTipoAhorro().getTahFechaFin());//inicial
				GregorianCalendar greCalendarF = ElapsedTime.dTGC(new Date());//final
				/*greCalendarI.setGregorianChange(ctaCasCuentaAsociado.getCasFechaCierre());
				greCalendarF.setGregorianChange(new Date());
				if(ctaCahCuentaAhorro.getCtaTahTipoAhorro().getCtaPlmPlanMeses() != null || 
						ctaCahCuentaAhorro.getCtaTahTipoAhorro().getTahFechaFin() != null){
					if(ctaCasCuentaAsociado.getCasFechaCierre()!=null){
						greCalendarF.set(Calendar.MILLISECOND, 0);
						greCalendarF.set(Calendar.SECOND, 0);
						greCalendarF.set(Calendar.MINUTE, 0);
						greCalendarF.set(Calendar.HOUR_OF_DAY, 0);
						
						greCalendarI.set(Calendar.MILLISECOND, 0);
						greCalendarI.set(Calendar.SECOND, 0);
						greCalendarI.set(Calendar.MINUTE, 0);
						greCalendarI.set(Calendar.HOUR_OF_DAY, 0);
						*/
//						System.out.println(greCalendarI);
						int diasParaPenalidad= elapsed.getDays(greCalendarI, greCalendarF);
						
						
						//sint diasParaPenalidad= diferenciaEnDias(new Date(),ahorro.getCtaTahTipoAhorro().getTahFechaFin());
						System.out.println("diasParaPenalidad: "+diasParaPenalidad);
						if(diasParaPenalidad>0){
							//calculo de penalidad = (saldo a reti.*dias faltan.*tasa mas alta de int.)/aÃ±o calen.
							CtaTinTasaInteresDAO ctaTinTasaInteresDAO = new CtaTinTasaInteresDAO(getSessionHibernate(request));
							CtrParParametrosDAO ctrParParametrosDAO = new CtrParParametrosDAO(getSessionHibernate(request));
							//Double saldoActual = ctaCahCuentaAhorro.getCahSaldoActual();
							Double tasa = (double) ctaTinTasaInteresDAO.maximaTasadeInteresPrestamosActivos()/100;
							Double anhoCal = ctrParParametrosDAO.findById("ANHO_CALENDARIO").getParValorNumber();
							
							penalidad = (monto * diasParaPenalidad * tasa)/ anhoCal;
//							System.out.println("Tasa:"+tasa );
//							System.out.println("anhoCal:"+anhoCal );
//							System.out.println("monto: "+ monto);
						}
					}
//				}
//			}
			}
			if(penalidad > 0){
				penalidad =	Math.round(penalidad*Math.pow(10, 2))/Math.pow(10, 2);
			}
			return penalidad;
	 }
	 
	 public ActionForward cargarDatos(ActionMapping mapping, ActionForm form,
				HttpServletRequest request, HttpServletResponse response) {
		 CuentaAhorroForm cuentaAForm = (CuentaAhorroForm)form;
		 CtaCahCuentaAhorroDAO cuentaAhorroDAO = new CtaCahCuentaAhorroDAO(getSessionHibernate(request));
		 cuentaAForm.setCtaCahCuentaAhorroH(cuentaAhorroDAO.findById(cuentaAForm.getCahId()));
		 return lista(mapping, cuentaAForm, request, response);//mandar nuevo form
	 }
	 
	 public ActionForward toCuentasAsociadoAh(ActionMapping mapping, ActionForm form,
				HttpServletRequest request, HttpServletResponse response){
		 	String asociadoId = request.getSession().getAttribute("asociadoId").toString();
		 	/*CuentaAhorroForm ahForm = (CuentaAhorroForm)form;*/
			CtaAscAsociadoDAO asociadoDAO = new CtaAscAsociadoDAO(getSessionHibernate(request));
			CtaAscAsociado asociado = asociadoDAO.findById(asociadoId);
			/*asociado = asociadoDAO.findById(ahForm.getAscId());*/
			CuentaAsociadoForm cuentaAsociadoForm = new CuentaAsociadoForm();
			cuentaAsociadoForm.setAscId(asociado.getAscId());
			cuentaAsociadoForm.setAscCodigo(asociado.getAscCodigo());
			cuentaAsociadoForm.setTipoCuentaMadre("Ah");
			request.setAttribute("form", cuentaAsociadoForm);
			return mapping.findForward("regresar");
		  //return mapping.findForward("toCuentasDelAsociado");
	}
	 
		public ActionForward redirectInvalidData(ActionMapping mapping, ActionForm form,
				HttpServletRequest request, HttpServletResponse response){
			ActionErrors errors = (ActionErrors)request.getSession().getAttribute(Constantes.ERRORS);
			saveMessages(request, errors);
			return lista(mapping, form, request, response);
		}
		
		public void mensajes(String msg, HttpServletRequest request){
			ActionErrors errors = new ActionErrors();
	        errors.add(ActionMessages.GLOBAL_MESSAGE,new ActionMessage(msg));
	        saveMessages(request, errors);
		}
		
		public ActionForward forwardToBeneficiarios(ActionMapping mapping, ActionForm form,
				HttpServletRequest request, HttpServletResponse response) {
			CuentaAhorroForm ahorroForm = (CuentaAhorroForm) form;
			AgregaBenForm benForm = new AgregaBenForm();
			benForm.setCuentaX(ahorroForm.getCasCuenta());
			request.setAttribute("agregaBenForm", benForm);
			request.setAttribute(Constantes.ACCION_KEY, "/agregaBen");
			return mapping.findForward("addBeneAport");
			/*CuentaAhorroForm ahorroForm = (CuentaAhorroForm) form;
			request.getSession().setAttribute("asociadoIdAportacion",ahorroForm.getCtaAscAsociadoH().getAscId());
			request.getSession().setAttribute("porcent",1);
			BeneficiariosForm beneForm = new BeneficiariosForm();
			beneForm.setCuentaX(ahorroForm.getCasCuenta());
			request.setAttribute("beneficiariosForm", beneForm);
			return mapping.findForward("beneficiariosLista");*/
		}
		
		public ActionForward generarComprobante(ActionMapping mapping, ActionForm form,
				HttpServletRequest request, HttpServletResponse response) {
			CuentaAhorroForm ahorroForm = (CuentaAhorroForm) form;
			try{
				Date fechaActual = new Date();
				response.setHeader("Cache-Control","private");
				response.setHeader("Pragma", "Cache");
				String pathReporte = "";//ruta reporte
				String nombreReporte = "";
				ExportReport exportar = null;
				ReportFile reporte = new ReportFile();
				ServletContext servletContext = getServlet().getServletContext();
				
				nombreReporte = "comprobante";
				pathReporte = servletContext
				.getRealPath("/reportesOtros/facturacion/"+nombreReporte+"/"+nombreReporte+".jasper");
				reporte.addParameter("txaComprobante",ahorroForm.getComprobante());
				
				SecIseInicioSesionDAO sesionDAO = new SecIseInicioSesionDAO(getSessionHibernate(request));
				SecIseInicioSesion sesion = sesionDAO.findById(ahorroForm.getUsuarioConectado().getNombreUsuario());
				reporte.addParameter("sucNombre",sesion.getSecPerPersona().getSecSucSucursal().getSucNombre());
				
				reporte.setPathJasper(pathReporte);
				exportar = new ExportReport(reporte);//reporte a exportar
				
				//Conexion jdbc normal
				String jdbcDriver = "com.mysql.jdbc.Driver";
				Class.forName(jdbcDriver);
				String url = HibernateSessionFactory.getConfiguration().getProperty("connection.url");
				String user = HibernateSessionFactory.getConfiguration().getProperty("connection.username");
				String pass = HibernateSessionFactory.getConfiguration().getProperty("connection.password");
				Connection con = DriverManager.getConnection(url, user, pass);
				byte[] repCompilado = exportar.exportReportPDF(con);				
				response.setContentType("application/pdf");
				response.setContentLength(repCompilado.length);
				response.setHeader("content-Disposition", "attachment;filename="+nombreReporte+"-"+fechaActual.getTime()+".pdf");
				ServletOutputStream outputStream = response.getOutputStream();
				outputStream.write(repCompilado, 0, repCompilado.length);
				outputStream.flush();
				outputStream.close();
				
			}catch(Exception e){
				e.printStackTrace();
				log.error("Se produjo un error al tratar de generar el reporte...", e);
				System.out.println("Se produjo un error al tratar de generar el reporte...\n");
			}
			return null;
		}
	
		
	protected Map getKeyMethodMap() {
		// TODO Auto-generated method stub
		HashMap<String, String> map = new HashMap<String, String>();
		map.put("cmd.cah.lista", "lista");
		map.put("cmd.cah.cerrarRegresar", "toCuentasAsociadoAh");
		map.put("cmd.cah.buscarMovimientos", "buscarMovimientos");
		map.put("cmd.cah.guardar", "guardar");
		map.put("cmd.cah.cargarDatos", "cargarDatos");
		map.put("cmd.cah.cierreCuentaDatos", "cierreCuentaDatos");
		map.put("cmd.cah.cierreCuentaAhorro", "cierreCuentaAhorro");
		/*map.put("cmd.cah.cerrarRegresar", "toCuentasAsociadoAh");*/
		map.put("cmd.cah.cargarDatosTipoAhorro","cargarDatosTipoAhorro");
		map.put("cmd.cah.redirectInvalidData", "redirectInvalidData");
		map.put("cmd.cah.generarComprobante", "generarComprobante");
		map.put("cmd.cah.continuarBeneficiarios", "forwardToBeneficiarios");
		
		return map;
	}
}
